油猴脚本编写教程

# 使用

## **安装插件**

油猴脚本是一个运行浏览器插件线程中的扩展程序

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/1662869594452-b3e0b414-1c1f-40c5-81e4-d88c7e0019a9.png)

## **新建一个脚本**

<img src="%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/1651891475940-ac2f6698-d62f-4c4c-b724-e7f0a9fde3f8-170239038788711.png" alt="image.png" style="zoom:67%;" />

![image-20231212221604502](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231212221604502.png)

## **脚本示例**

### csdn免费复制

```js
// ==UserScript==
// @name         csdn免费复制
// @version      0.1
// @description  直接复制需要登录后才能复制的代码片段
// @author       vanndxh
// @match        https://blog.csdn.net/*/article/details/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=tampermonkey.net
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    document.querySelectorAll('code').forEach(i => {
        i.contentEditable = true
    })
})();
```

用jquery抓取并遍历所有code代码，并将可编辑属性contentEditable置为true

### 百度文库破解

这部分分成两部分，复制和全文阅读的破解，可以放在一个脚本里面

复制破解

```js
document.body.addEventListener("keydown", function (e) {
    // Ctrl功能键 + 67（C）或者 mac版的command
    if (e.ctrlKey && e.keyCode == "67" || e.metaKey && e.keyCode == "67") {
        // 目标文本
        let tagetStr = document.querySelector(".search-result-wrap .link").innerText.split("查看全部包含“")[1].split("”的文档")[0];
        // 创建input元素，为实现复制准备
        let input = document.createElement("input");
        // 给input的value属性设置值为目标文本
        input.setAttribute("value", tagetStr);
        // 将input添加到页面
        document.body.appendChild(input);
        // 选中input
        input.select();
        // 执行copy命令
        document.execCommand("copy");
        // 完了之后移除input元素，为下一次初始化
        document.body.removeChild(input);
        // 定时器延迟1毫秒隐藏vip提示和遮罩层
        setTimeout(function () {
            document.querySelector(".dialog-mask").style.display = "none";
            document.querySelector(".copy-limit-dialog-v2").style.display = "none";
        }, 1)
    }
})

// 鼠标抬起触发
document.body.addEventListener("mouseup", function () {
    // 设置不想看见的盒子隐藏
    document.querySelector("#reader-helper").style.display = "none";
})
```

全文阅读破解

```js
// ==UserScript==
// @name         百度文库破解
// @version      0.1
// @description  百度文库复制、全文阅读破解
// @author       vanndxh
// @match        https://wenku.baidu.com/view/*.html
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// @run-at       document-start
// ==/UserScript==

/** 全文阅读部分 */
let data;
Object.defineProperty(window, 'pageData', {
    set: v => data = v,
    get() { 'vipInfo' in data ? data.vipInfo.isVip = 1 : ''; return data; }
})
```

需要注意一下，上方高亮部分代码必须写入！

### 腾讯视频去广告

```js
setInterval(() => {
    let adVideos =
        document.querySelector(".txp_ad")?.children[0].children[0].childNodes;
    adVideos.forEach((i) => {
        if (i.duration !== i.currentTime) {
            i.setAttribute("src", "");
        }
    });
}, 10);
```

### 全网vip破解

```js
// ==UserScript==
// @name              破解VIP会员视频集合
// @namespace         https://greasyfork.org/zh-CN/users/104201
// @version           5.46
// @description       解锁B站大会员，番剧；爱奇艺、腾讯、优酷、芒果等全网VIP视频免费破解去广告(免跳出观影特方便，支持【PC端+移动端，支持自定义接口】)网易云音乐、QQ音乐、酷狗、蜻蜓FM、荔枝FM、喜马拉雅等音乐和有声书音频免客户端下载；B站、A站视频解析下载；油管、Facebook等国外视频解析下载；高清电视频道观看(CCTV、湖南卫视等100多个台)；优惠券查询等【脚本长期维护更新，完全免费，无广告】
// @author            max
// @icon              data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACS0lEQVRYR8WXz2oTURTGv3MnpqhNKy1UWmxRTGdaiLSQRKkKIoK4FVrRPoHu7BMYn0B3+gQquuiuiC6kaFVsAhGEZkKqG/+Vrtp0YWsyR27KlEwz0xnnT3LgwjB37vl+97tzz9whdDiow/pwBCjofN0AJohwKQgkMxYF8Dmt0bxdnhaAQoWTXMczENJBhFvGMgqk4GY6SZXmPgvAmy/cnYijGqrwvmTVHSQup2jLvG0ByJf5EYDbUQIAeJxR6U4LQHGV1VodesTijfQxBdrkaSrL6z0Hlst8i4An7QBgYDar0lMrgM45ItxrCwDjflajnC+AtR8Gvn8zGpz9xwVOjor/Zma/ANt/GIsLNWxt8p7o4IiAmlLQP+C9pvkG+FoyUPxYs52xhFDPKIh3uRviG2ClWIdsTpHoJYymFNdliQzABBsaEZg4p+DwUftliRxAggwOC0xdidma1RaAI92Ea9OHOgcwPqlANruI1AElhsa2dBKXQJEBnDglGlvxWN/BNcE3gKyCS69b64AUlMISwEv4BpDJ3778i/Xfu5XQtFtaLq+9RiCA6gZj/dcuQN8Audod6kvodYZuz9k7UOK7JPDAbXAY/WxgLjtGDy2f408VPi8MLIUh4JbDELhwNknvLQDyQNoTh87AkFuCIP0E/NzcgWYeTC0bdrkNp6Lm9bc4YM4qr/NzEGaCzNJxLONFRqMbzf22JSu/wlcphhwzpsIAIcIHriGXGadX+/MdWDPflTjRxcH+kLYJhYtj5Piz4/0gF4YVNjk6DvAPDb0aMEr8/nEAAAAASUVORK5CYII=
// @include           *://*.youku.com/v_*
// @include           *://*.iqiyi.com/v_*
// @include           *://*.iqiyi.com/w_*
// @include           *://*.iqiyi.com/a_*
// @include           *://*.le.com/ptv/vplay/*
// @include           *://v.qq.com/x/cover/*
// @include           *://v.qq.com/x/page/*
// @include           *://v.qq.com/tv/*
// @include           *://*.tudou.com/listplay/*
// @include           *://*.tudou.com/albumplay/*
// @include           *://*.tudou.com/programs/view/*
// @include           *://*.mgtv.com/b/*
// @include           *://film.sohu.com/album/*
// @include           *://tv.sohu.com/v/*
// @include           *://*.bilibili.com/video/*
// @include           *://*.bilibili.com/bangumi/play/*
// @include           *://*.baofeng.com/play/*
// @include           *://vip.pptv.com/show/*
// @include           *://v.pptv.com/show/*
// @include           *://www.le.com/ptv/vplay/*
// @include           *://www.wasu.cn/Play/show/*
//---------------------------------------------------
// @include           *://m.v.qq.com/x/cover/*
// @include           *://m.v.qq.com/x/page/*
// @include           *://m.v.qq.com/*
// @include           *://m.iqiyi.com/*
// @include           *://m.iqiyi.com/kszt/*
// @include           *://m.youku.com/alipay_video/*
// @include           *://m.mgtv.com/b/*
// @include           *://m.tv.sohu.com/v/*
// @include           *://m.film.sohu.com/album/*
// @include           *://m.le.com/ptv/vplay/*
// @include           *://m.pptv.com/show/*
// @include           *://m.acfun.cn/v/*
// @include           *://m.bilibili.com/video/*
// @include           *://m.bilibili.com/anime/*
// @include           *://m.bilibili.com/bangumi/play/*
// @include           *://m.wasu.cn/Play/show/*
//---------------------------------------------------
// @include           *://www.youtube.com
// @include           *://www.youtube.com/
// @include           *://www.youtube.com/watch*
// @include           *://www.facebook.com/*
// @include           *://yt1s.com/facebook-downloader
//---------------------------------------------------
// @include      	  *music.163.com*
// @include           *://y.qq.com*
// @include           *://www.kugou.com*
// @include           *://www.kuwo.cn*
// @include           *://www.lizhi.fm*
// @include           *://*.ximalaya.com*
// @include           *://music.migu.cn*
//---------------------------------------------------
// @include           *://www.laisoyixia.com/download/detail**
// @include           *://*.ucloud.cn/*
// @include           *://virmach.com/*
// @include           *://www.hostwinds.com/*
// @require           https://cdn.jsdelivr.net/npm/jquery-tampers@3.2.1/jquery.min.js
// @connect			  tt.shuqiandiqiu.com
// @connect           api.bilibili.com
// @grant             unsafeWindow
// @grant             GM_openInTab
// @grant             GM.openInTab
// @grant             GM_getValue
// @grant             GM.getValue
// @grant             GM_setValue
// @grant             GM.setValue
// @grant             GM_xmlhttpRequest
// @grant             GM.xmlHttpRequest
// @grant             GM_registerMenuCommand
// @license           MIT
// @charset		      UTF-8
// ==/UserScript==

(function () {
	'use strict';
	var $ = $ || window.$;

	//如果本地值不能满足需求，可自定义添加接口到此处
	//注意数据格式
	//category=1:全网VIP解析内嵌页播放
	//category=2:全网VIP解析新建页面播放
	var customizeInterfaceList=[
		//{ name:"就是名字而已", category:"1", url:"https://jx.idc126.net/jx/?url="},
		//{ name:"就是名字而已", category:"2", url:"https://jx.idc126.net/jx/?url="},
	];

	//视频vip解析收集自脚本：
	//https://greasyfork.org/zh-CN/scripts/390952
	//https://greasyfork.org/zh-CN/scripts/398195

	//默认值，当网络请求出现错误时使用此值
	var originalInterfaceList = [
		{"name":"纯净解析","category":"1","url":"https://z1.m1907.cn/?jx="},
		{"name":"高速接口1","category":"1","url":"https://jsap.attakids.com/?url="},
		{"name":"B站解析1","category":"1","url":"https://vip.parwix.com:4433/player/?url="},
		{"name":"B站解析2","category":"1","url":"https://www.cuan.la/m3u8.php?url="},
		{"name":"乐多资源","category":"1","url":"https://api.leduotv.com/wp-api/ifr.php?isDp=1&vid="},
		{"name":"ccyjjd","category":"1","url":"https://ckmov.ccyjjd.com/ckmov/?url="},
		{"name":"七哥","category":"1","url":"https://jx.mmkv.cn/tv.php?url="},
		{"name":"M3U8","category":"1","url":"https://jx.m3u8.tv/jiexi/?url="},
		{"name":"大白","category":"1","url":"https://api.myzch.cn/?url="},
		{"name":"老板","category":"1","url":"https://vip.laobandq.com/jiexi.php?url="},
		{"name":"云点播","category":"1","url":"https://api.iopenyun.com:88/vip/?url="},
		{"name":"爱豆","category":"1","url":"https://jx.aidouer.net/?url="},
		{"name":"Ckplayer","category":"1","url":"https://www.ckplayer.vip/jiexi/?url="},
		{"name":"BL","category":"1","url":"https://vip.bljiex.com/?v="},
		{"name":"Mao解析","category":"1","url":"https://91jxs.com/jiexi/?url="},
		{"name":"盘古","category":"1","url":"https://www.pangujiexi.cc/jiexi.php?url="},
		{"name":"ckmov","category":"1","url":"https://www.ckmov.vip/api.php?url="},
		{"name":"迪奥","category":"1","url":"https://123.1dior.cn/?url="},
		{"name":"RDHK","category":"1","url":"https://jx.rdhk.net/?v="},
		{"name":"H8","category":"1","url":"https://www.h8jx.com/jiexi.php?url="},
		{"name":"解析la","category":"1","url":"https://api.jiexi.la/?url="},
		{"name":"久播","category":"1","url":"https://jx.jiubojx.com/vip.php?url="},
		{"name":"九八","category":"1","url":"https://jx.youyitv.com/?url="},
		{"name":"MUTV","category":"1","url":"https://jiexi.janan.net/jiexi/?url="},
		{"name":"明日","category":"1","url":"https://jx.yingxiangbao.cn/vip.php?url="},
		{"name":"磨菇","category":"1","url":"https://jx.wzslw.cn/?url="},
		{"name":"OK","category":"1","url":"https://okjx.cc/?url="},
		{"name":"维多","category":"1","url":"https://jx.ivito.cn/?url="},
		{"name":"小蒋","category":"1","url":"https://www.kpezp.cn/jlexi.php?url="},
		{"name":"星驰","category":"1","url":"https://vip.cjys.top/?url="},
		{"name":"星空","category":"1","url":"http://60jx.com/?url="},
		{"name":"月亮","category":"1","url":"https://api.yueliangjx.com/?url="},
		{"name":"0523","category":"1","url":"https://go.yh0523.cn/y.cy?url="},
		{"name":"云端","category":"1","url":"https://jx.ergan.top/?url="},
		{"name":"17云","category":"1","url":"https://www.1717yun.com/jx/ty.php?url="},
		{"name":"66","category":"1","url":"https://api.3jx.top/vip/?url="},
		{"name":"116","category":"1","url":"https://jx.116kan.com/?url="},
		{"name":"200","category":"1","url":"https://vip.66parse.club/?url="},
		{"name":"云析","category":"1","url":"https://jx.yparse.com/index.php?url="},
		{"name":"8090","category":"1","url":"https://www.8090g.cn/?url="},

		{"name":"综合线路解析","category":"2","url":"https://www.showxi.xyz/mov/s/?sv=3&url="},
		{"name":"纯净解析","category":"2","url":"https://z1.m1907.cn/?jx="},
		{"name":"高速接口1","category":"2","url":"https://jsap.attakids.com/?url="},
		{"name":"高速接口2","category":"2","url":"https://api.sigujx.com/?url="},
		{"name":"B站解析1","category":"2","url":"https://vip.parwix.com:4433/player/?url="},
		{"name":"B站解析2","category":"2","url":"https://www.cuan.la/m3u8.php?url="},
		{"name":"Ckplayer","category":"2","url":"https://www.ckplayer.vip/jiexi/?url="},
		{"name":"乐多资源","category":"2","url":"https://api.leduotv.com/wp-api/ifr.php?isDp=1&vid="},
		{"name":"ccyjjd","category":"2","url":"https://ckmov.ccyjjd.com/ckmov/?url="},
		{"name":"M3U8","category":"2","url":"https://jx.m3u8.tv/jiexi/?url="},
		{"name":"BL","category":"2","url":"https://vip.bljiex.com/?v="},
		{"name":"Mao解析","category":"2","url":"https://qd.hxys.tv/m3u8.php?url="}
	];
	var playerNodes = [
		{ url:"v.qq.com", node:"#mod_player"},
		{ url:"www.iqiyi.com", node:"#flashbox"},
		{ url:"v.youku.com", node:"#player"},
		{ url:"w.mgtv.com", node:"#mgtv-player-wrap"},
		{ url:"www.mgtv.com", node:"#mgtv-player-wrap"},
		{ url:"tv.sohu.com", node:"#player"},
		{ url:"film.sohu.com", node:"#playerWrap"},
		{ url:"www.le.com", node:"#le_playbox"},
		{ url:"video.tudou.com", node:".td-playbox"},
		{ url:"v.pptv.com", node:"#pptv_playpage_box"},
		{ url:"vip.pptv.com", node:".w-video"},
		{ url:"www.wasu.cn", node:"#flashContent"},
		{ url:"www.acfun.cn", node:"#player"},
		{ url:"www.bilibili.com", node:"#player_module"},
		{ url:"vip.1905.com", node:"#player"},
	];

	let newOriginalInterfaceList = originalInterfaceList;
	try{
		newOriginalInterfaceList = customizeInterfaceList.concat(originalInterfaceList);
	}catch(e){
		console.log("自定义解析接口错误，注意数据格式....");
	}

	/**
	 * 共有方法
	 */
	function commonFunction(){
		this.GMgetValue = function (name, value) { //得到存在本地的数据
			if (typeof GM_getValue === "function") {
				return GM_getValue(name, value);
			} else {
				return GM.getValue(name, value);
			}
		};
		this.GMsetValue = function(name, value){
			if (typeof GM_setValue === "function") {
				return GM_setValue(name, value);
			} else {
				return GM.setValue(name, value);
			}
		};
		this.GMaddStyle = function(css){
			var myStyle = document.createElement('style');
			myStyle.textContent = css;
			var doc = document.head || document.documentElement;
			doc.appendChild(myStyle);
		};
		this.GMopenInTab = function(url, open_in_background){
			if (typeof GM_openInTab === "function") {
				GM_openInTab(url, open_in_background);
			} else {
				GM.openInTab(url, open_in_background);
			}
		};
		this.addScript = function(url){
			var s = document.createElement('script');
			s.setAttribute('src',url);
			document.body.appendChild(s);
		};
		this.randomNumber = function(){
			return Math.ceil(Math.random()*100000000);
		};
		this.request = function(mothed, url, param){
			return new Promise(function(resolve, reject){
				GM_xmlhttpRequest({
					url: url,
					method: mothed,
					data:param,
					onload: function(response) {
						var status = response.status;
						var playurl = "";
						if(status==200||status=='200'){
							var responseText = response.responseText;
							resolve({"result":"success", "data":responseText});
						}else{
							reject({"result":"error", "data":null});
						}
					}
				});
			})
		};
	}
	//全局统一变量
	const commonFunctionObject = new commonFunction();

	/**
	 * 超级解析助手
	 * @param {Object} originalInterfaceList
	 * @param {Object} playerNodes
	 */
	function superVideoHelper(originalInterfaceList, playerNodes){
		this.originalInterfaceList = originalInterfaceList;
		this.node = "";
		this.elementId = Math.ceil(Math.random()*100000000);
		for(var i in playerNodes) { //获得窗口ID
			if (playerNodes[i].url == window.location.host) {
				this.node = playerNodes[i].node;
				break;
			}
		}
		this.isRun = function(){ //判断是否运行
			var urls = ["iqiyi.com","v.qq.com","youku.com", "le.com","tudou.com","mgtv.com","sohu.com", "acfun.cn","bilibili.com","baofeng.com","pptv.com"];
			for(var i=0; i<urls.length;i++){
				if((window.location.host!=="bilibili.com" && window.location.host.indexOf(urls[i])!=-1)
					|| (window.location.host==="bilibili.com" && window.location.href.indexOf("bangumi/play")!=-1)){
					return true;
				}
			}
			return false;
		};
		this.innerParse = function(url) { //内嵌解析
			$("#iframe-player").attr("src", url);
		};
		this.addHtmlElements = function(){
			var vipVideoImageBase64 =`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAC9klEQVRoQ+2ZPWgVQRDH/7/CWqOIYOFHFbRSjJhGMGDpByoIago70cqvUtQgdipWFqawMWghGIidhcHKQAJqEURBRfED1CCCjc3IPu4em31775J7d3m8cAtX3O7szP7nPzszx6EeH/T4+VUD6DaDTQbMbE+3D7MY+8Ckkw8BPFuMki7KDtUAuuh9Z3oZMtBljxY2X9eBwq4raWPNQEmOLKxm+TBgZqsknQ1dAVzNco+ZhWsm6ZakHZLC1mQyrZ5OX2RvzMxnSa8lzQJ/YwLzGDCze5JOeoI/gbVtAMxJ6vPW7wKnkr4qbEuaxccDcGWBsfNV0mjMmSGAg5LGA6XbgFehITPbLel5MN84ZAUAUjMPgWO+zZY7YGbvJW0OvRoB8EjSEW9+BhhIvOvCp0wGfPPbgZfpRAzATUnn56GEmJyLd39cBNxeF99FADTa42BskuQef4wDh9oB2CXpRbDpMPA4nTOz05LuBDLrgW+dAACGIkxfkHTDm/8DrMwEkBxgOskkqdwEcMAD4GLf3YF0PACOe+uFGMgA4Bj4EAAbAGbcXLQOmNklSdeCTRuBT2bWL+lNsLYfeFIRgH2SJgJ7GwCXYjMBrJb0K9jUiHEzG5F02VubA9b4skXvQMiAmW2VdFSSn24/As0kk1mJzeyppL3ewaaBnWY2K2mLNz8S5ueCAMLwz3q/DZxreweSe3BC0v1Ai7tkYXrsB96WwMBCAfQBv3MBJCD+SVrhaXaZ54z3PgUMhpYrZKCF7bbNnJk5BhwT6fghyW8thoGxigE4my6tXwemQlt5AGI1oamDSIFLmCuURiW5BOGPL8C7drGV206b2XdJ6yJKxoDhmPKCIeS61ZZClncxFgLAtcyxrnEwRmknDFQFIFYTWnJ/CVmoGgYSj7Z81OR86Lg7sOgPmnY6s0IpN4TyYrDb6zWAmoEOPVCHUIcO7Hh7/YemYxcWU7AMf3BkNGDF/FP9rkwGqjddkoWWv5Ql6V1yNXUdWHKXBwZ7noH/dP+HQNqheToAAAAASUVORK5CYII=`;
			var tvImageBase64=`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAACvUlEQVRoQ+2ZPYwNURTHf/9Gp/ARCpFYoVDZRCMqGgrRKCgoyCZE46MgaNiCRLIhu4WPDaIgkWwhEZHQ0IqPIFGI+AgJsQ0FKnHkbs5s5o2Z9+atmX33JXOb9+Z+nPv/n/+9Z+65I/q8qM/x0xDotYKNAlEpYGa7gC3A/F4DK5j/C3Bb0s2kfXoJmdky4H2kwLOwBiR9CJVpAieBE31CYFhSwNuWwMPIyKxP4SlFYIOkKEiYWQD/oCHQqyXVKJD2vJldB5aUUCOEubuSJswsRIzPksbzxpnZOmAjcEHS12yfyhRwIN2E2mHgI3DFQW2SdD/jkEXAM3fKdHTJ9KluE5vZCLAm46UkxKWjVlAgEFgIPPb+NyTtzIA7Bpz2uiFJV2tToED+EN6mCEjKPRyaWXj1b/fxqyW9DP/NbC7wHFgOTEpaXDBHdQrkeKcMgc3AHR87KumgEwi/57z+qKQzURJwsAnRb8AA8BMISqwCvgMLJP2JmcAQcNkBHgF+AOf9eUTS4aLIVlkUmukecAXm+HoPHn/jCgwCv4IikiajJuAkjgOnMkDHJB1o916JQgEnsBR4AcxzwL+BQUmv+oKAkxgF9jvgi5L2tQPvY2oNo0kidE3S7hJgVgBjvolD6HxXYkx9BBIP1Zk71LoHOnmvivaGQBVe/B8bM1UgnCRjKuljfKmkPibwWSy5BEJGdC9m1ClsayU9Cs8t53dPF3dETuKWpK0Jxn8SEDML+e7KCki03OMAVdwxfZL0No2tluv1dlGjAse0mGgI5Hk0OgX86j0cqMIVfC7mnMqp22Mv3b5TngBPJYXvAW1LqSVkZpeAPZ2MVdw+IWlbJ5tlCVgnQ3W0F13TdB2FzOwscKgOkG1sjkva22nOUgoEI74PivZAp3m6bX9dZv0Ho6UJdItgtvo3BGbL00XzNAr0WoG/02m4QKQE53EAAAAASUVORK5CYII=`;
			var category_1_html = "";
			var category_2_html = "";
			this.originalInterfaceList.forEach((item, index) => {
				if (item.category === "1") {
					category_1_html += "<li title='"+item.name+"' data-index='"+index+"'>" + item.name + "</li>";
				}
				if (item.category === "2") {
					category_2_html += "<li title='"+item.name+"' data-index='"+index+"'>" + item.name + "</li>";
				}
			});

			//获得自定义位置
			var left = 0;
			var top = 130;
			var Position = commonFunctionObject.GMgetValue("Position_" + window.location.host);
			if(!!Position){
				left = Position.left;
				top = Position.top;
			}
			var cssMould = `#vip_movie_box`+this.elementId+` {cursor:pointer; position:fixed; top:` + top + `px; left:` + left + `px; width:0px; z-index:2147483647; font-size:16px; text-align:left;}
							#vip_movie_box`+this.elementId+` .item_text {}
							#vip_movie_box`+this.elementId+` .item_text .img_box{width:26px; height:35px;line-height:35px;text-align:center;background-color:#E5212E;}
							#vip_movie_box`+this.elementId+` .item_text .img_box >img {width:20px; display:inline-block; vertical-align:middle;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_action {display:none; position:absolute; left:26px; top:0; text-align:center; background-color:#272930; border:1px solid gray;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_action li{border-radius:2px; font-size:12px; color:#DCDCDC; text-align:center; width:60px; line-height:21px; float:left; border:1px solid gray; padding:0 4px; margin:4px 2px;overflow:hidden;white-space: nowrap;text-overflow: ellipsis;-o-text-overflow:ellipsis;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_action li:hover{color:#E5212E; border:1px solid #E5212E;}

							#vip_movie_box`+this.elementId+` li.selected{color:#E5212E; border:1px solid #E5212E;}


							#vip_movie_box`+this.elementId+` .selected_text {margin-top:5px;}
							#vip_movie_box`+this.elementId+` .selected_text .img_box{width:26px; height:35px;line-height:35px;text-align:center;background-color:#E5212E;}
							#vip_movie_box`+this.elementId+` .selected_text .img_box >img {width:20px; height:20px;display:inline-block; vertical-align:middle;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_selected {display:none;position:absolute; left:26px; top:0; text-align:center; background-color:#F5F6CE; border:1px solid gray;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_selected ul{overflow-y: auto;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_selected li{border-radius:2px; font-size:12px; color:#393AE6; text-align:center; width:95px; line-height:27px; float:left; border:1px dashed gray; padding:0 4px; margin:4px 2px;display:block;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
							#vip_movie_box`+this.elementId+` .vip_mod_box_selected li:hover{color:#E5212E; border:1px solid #E5212E;}

							#vip_movie_box`+this.elementId+` .default-scrollbar-55678::-webkit-scrollbar{width:5px; height:1px;}
							#vip_movie_box`+this.elementId+` .default-scrollbar-55678::-webkit-scrollbar-thumb{box-shadow:inset 0 0 5px rgba(0, 0, 0, 0.2); background:#A8A8A8;}
							#vip_movie_box`+this.elementId+` .default-scrollbar-55678::-webkit-scrollbar-track{box-shadow:inset 0 0 5px rgba(0, 0, 0, 0.2); background:#F1F1F1;}
							`
			commonFunctionObject.GMaddStyle(cssMould);

			var htmlMould = `<div id='vip_movie_box`+this.elementId+`'>
								<div class='item_text'>
									<div class="img_box" id="img_box_6667897iio"><img src='`+ vipVideoImageBase64 +`' title='点击跳转到综合解析页面，线路随意选！'/></div>
										<div class='vip_mod_box_action' >
											<div style='display:flex;'>
												<div style='padding:10px 0px; width:380px; max-height:400px; overflow-y:auto;'  class="default-scrollbar-55678">
													<div>
														<div style='font-size:16px; text-align:center; color:#E5212E; padding:5px 0px;'><b>全网VIP视频解析[内嵌播放]</b></div>
														<ul>
															` + category_1_html + `
															<div style='clear:both;'></div>
														</ul>
													</div>
													<div>
														<div style='font-size:16px; text-align:center; color:#E5212E; padding:5px 0px;'><b>全网VIP视频解析[弹窗播放]</b></div>
														<ul>
														` + category_2_html + `
														<div style='clear:both;'></div>
														</ul>
													</div>
												</div>
											<div>
										</div>
									</div>
								</div>
							</div>
							`;
			$("body").append(htmlMould);
		};
		this.mouseEvent = function(){
			$(".item_text").on("mouseover", () => {
				$(".vip_mod_box_action").show();
			});
			$(".item_text").on("mouseout", () => {
				$(".vip_mod_box_action").hide();
			});
			$(".vip_mod_box_action li").each((liIndex, item) => {
				item.addEventListener("click", () => {
					var videoPlayer = $("<div id='iframe-play-div' style='width:100%;height:100%;z-index:1000;'><iframe id='iframe-player' frameborder='0' allowfullscreen='true' width='100%' height='100%'></iframe></div>");
					var index = parseInt($(item).attr("data-index"));
					var category = this.originalInterfaceList[index].category;
					var url = this.originalInterfaceList[index].url + window.location.href;
					if (category==="1") { //内嵌播放....
						if (document.getElementById("iframe-player") == null) {
							var player = $(this.node);
							player.empty();
							player.append(videoPlayer);
						}
						this.innerParse(url);  //把播放链接加入到自定义的div
					}
					if (category==="2"){  //弹窗播放....
						commonFunctionObject.GMopenInTab(url, false);
					}
					//把点击过的标红
					$(".vip_mod_box_action li").removeClass("selected");
					$(item).addClass("selected");
				});
			});
			//右键移动位置
			var movie_box = $("#vip_movie_box"+this.elementId);
			movie_box.mousedown(function(e) {
				if (e.which == 3) {
					e.preventDefault()
					movie_box.css("cursor", "move");
					var positionDiv = $(this).offset();
					var distenceX = e.pageX - positionDiv.left;
					var distenceY = e.pageY - positionDiv.top;

					$(document).mousemove(function(e) {
						var x = e.pageX - distenceX;
						var y = e.pageY - distenceY;
						var windowWidth = $(window).width();
						var windowHeight = $(window).height();

						if (x < 0) {
							x = 0;
						} else if (x >  windowWidth- movie_box.outerWidth(true) - 100) {
							x = windowWidth - movie_box.outerWidth(true) - 100;
						}

						if (y < 0) {
							y = 0;
						} else if (y > windowHeight - movie_box.outerHeight(true)) {
							y = windowHeight - movie_box.outerHeight(true);
						}

						movie_box.css("left", x);
						movie_box.css("top", y);
						commonFunctionObject.GMsetValue("Position_" + window.location.host,{ "left":x, "top":y});
					});
					$(document).mouseup(function() {
						$(document).off('mousemove');
						movie_box.css("cursor", "pointer");
					});
					$(document).contextmenu(function(e) {
						e.preventDefault();
					})
				}
			});
			//点击视频播放界面
			$("#img_box_6667897iio").on("click", function(){
				commonFunctionObject.GMopenInTab("https://www.xixicai.top/mov/s/?sv=3&url="+window.location.href, false);
			});
		};

		//视频广告过滤相关代码借鉴自其它脚本，该部分代码版权归原作者所有！在此感谢
		//借鉴脚本作者：sign
		//地址：https://greasyfork.org/zh-CN/scripts/406849
		//修改：优化了该段代码的逻辑，使可读性更高
		this.videAdemove = function(){
			switch (window.location.host) {
				case 'www.iqiyi.com':
					try{
						unsafeWindow.rate = 0;
						unsafeWindow.Date.now = () => {
							return new unsafeWindow.Date().getTime() + (unsafeWindow.rate += 1000);
						}
						setInterval(() => {
							unsafeWindow.rate = 0;
						}, 600000);
					}catch(e){}

					//广告过滤iqiyi有点问题，10s后循环结束
					let iqiyiDelay = 0;
					let iqiyiInterval =  setInterval(() => {
						try{
							let cupidPublicTime = document.getElementsByClassName("cupid-public-time");
							if(cupidPublicTime.length!=0 && !!cupidPublicTime[0]){
								$(".skippable-after").css("display", "block");
								let skippableAfter = document.getElementsByClassName("skippable-after");
								if(skippableAfter.length!=0 && !!skippableAfter[0]){
									skippableAfter[0].click();
								}
							}
							$(".qy-player-vippay-popup").css("display", "none");
							$(".black-screen").css("display", "none");
						}catch(e){}
						if(iqiyiDelay>=10000){
							clearInterval(iqiyiInterval);
						}
						iqiyiDelay += 500;
					}, 500);
					break;
				case 'v.qq.com':
					setInterval(() => { //视频广告加速
						try{
							$(".txp_ad").find("txpdiv").find("video")[0].currentTime = 1000;
							$(".txp_ad").find("txpdiv").find("video")[1].currentTime = 1000;
						}catch(e){}
					}, 1000)
					setInterval(() => {
						try{
							var txp_btn_volume = $(".txp_btn_volume");
							if (txp_btn_volume.attr("data-status") === "mute") {
								$(".txp_popup_volume").css("display", "block");
								txp_btn_volume.click();
								$(".txp_popup_volume").css("display", "none");
							}
							//$("txpdiv[data-role='hd-ad-adapter-adlayer']").attr("class", "txp_none");
							$(".mod_vip_popup").css("display", "none");
							$(".tvip_layer").css("display", "none");
							$("#mask_layer").css("display", "none");
						}catch(e){}
					}, 500);

					break
				case 'v.youku.com':
					try{
						window.onload = function () {
							if (!document.querySelectorAll('video')[0]) {
								setInterval(() => {
									document.querySelectorAll('video')[1].playbackRate = 16;
								}, 100)
							}
						}
					}catch(e){}
					setInterval(() => {
						try{
							var H5 = $(".h5-ext-layer").find("div")
							if(H5.length != 0){
								$(".h5-ext-layer div").remove();
								var control_btn_play = $(".control-left-grid .control-play-icon");
								if (control_btn_play.attr("data-tip") === "播放") {
									$(".h5player-dashboard").css("display", "block");
									control_btn_play.click();
									$(".h5player-dashboard").css("display", "none");
								}
							}
							$(".information-tips").css("display", "none");
						}catch(e){}
					}, 500);

					break
				case 'www.mgtv.com':

					break
				case 'tv.sohu.com':
					setInterval(() => {
						try{
							$(".x-video-adv").css("display", "none");
							$(".x-player-mask").css("display", "none");
							$("#player_vipTips").css("display", "none");
						}catch(e){}
					}, 500);

					break
				case 'www.bilibili.com':

					break
			}
		};
		this.start = function(){
			if(this.isRun()){
				let delayTimeMs = 0;
				if(window.location.host.indexOf("www.bilibili.com")!=-1){//如果是哔哩哔哩，则需要延迟加载
					delayTimeMs = 2000;
				}
				setTimeout(()=>{
					this.addHtmlElements();
					this.mouseEvent();
					this.videAdemove();
				}, delayTimeMs);
			}
		};
	};

	//B站相关功能
	function huahuacat_bilibili(toolObject){
		this.toolObject=toolObject;
		this.downloadResutError=function($btn){
			$btn.text("下载视频（最高请）");
			$btn.removeAttr("disabled");
		};
		this.downloadResutSuccess=function($btn){
			$btn.text("下载视频（最高请）");
			$btn.removeAttr("disabled");
		};
		this.downloadVideo=function($btn){
			var pathname = window.location.pathname;
			var bv = pathname.replace("/video/","").replace("/","");
			if(!bv){
				this.downloadResutError();
			}else{
				//bv转av
				toolObject.request("get", "http://api.bilibili.com/x/web-interface/archive/stat?bvid="+bv, null).then((resultData)=>{
					let dataJson = JSON.parse(resultData.data);
					if(!!dataJson && dataJson.code===0 && !!dataJson.data){
						let aid = dataJson.data.aid;
						if(!aid){
							this.downloadResutError($btn);
						}else{
							//获取cid
							toolObject.request("get", "https://api.bilibili.com/x/web-interface/view?aid="+aid, null).then((resultData2)=>{
								let dataJson2 = JSON.parse(resultData2.data);
								if(!!dataJson2 && dataJson2.code===0 && !!dataJson2.data){
									let aid = dataJson2.data.aid;
									let bvid = dataJson2.data.bvid;
									let cid = dataJson2.data.cid;
									if(!aid || !bvid || !cid){
										this.downloadResutError($btn);
									}else{
										//获取播放链接
										toolObject.request("get", "https://api.bilibili.com/x/player/playurl?avid="+aid+"&cid="+cid+"&qn=112", null).then((resultData3)=>{
											let dataJson3 = JSON.parse(resultData3.data);
											if(!!dataJson3 && dataJson3.code===0 && !!dataJson3.data){
												this.downloadResutSuccess($btn);
												window.open(dataJson3.data.durl[0].url);
											}
										}).catch((errorData)=>{
											this.downloadResutError($btn);
										});
									}
								}
							}).catch((errorData)=>{
								this.downloadResutError($btn);
							});
						}
					}
				}).catch((errorData)=>{
					this.downloadResutError();
				});
			}
		}
		this.createElementHtml = function(){
			let randomNumber = this.toolObject.randomNumber();
			let cssText =
			`
				#bilibili_exti_`+randomNumber+`{padding:10px;}
				#bilibili_exti_`+randomNumber+` >.self_s_btn{background-color:#FB7299; color:#FFF; font-size:10px;display:inline-block; margin-right:15px;padding:2px 4px;border-radius:3px;cursor:pointer;}
			`;
			let htmlText=
			`
				<div id="bilibili_exti_`+randomNumber+`">
					<span class="self_s_btn" id="download_s_`+randomNumber+`">下载视频（最高请）</span>
					<span class="self_s_btn" id="focus_s_`+randomNumber+`">一键三联</span>
				</div>
			`;
			setTimeout(()=>{
				if($("#bilibili-player").html().length >= 10){
					$("body").prepend("<style>"+cssText+"</style>");
					$("#viewbox_report div.video-data").append(htmlText);
					let $that = this;
					$("#download_s_"+randomNumber).on("click", function(){
						$(this).attr("disabled", "disabled");
						$(this).text("下载视频（准备中）")
						$that.downloadVideo($(this));
					});
					$("#focus_s_"+randomNumber).on("click", function(){
						$("#arc_toolbar_report .like").click();
						$("#arc_toolbar_report .coin").click();
					});
				}
			}, 2500);
		}
		this.start = function(){
			if(window.location.host==="www.bilibili.com" && window.location.pathname.indexOf("/video")!=-1){
				this.createElementHtml();
			}
		}
	}

	//国外的一些解析
	function abroadVideoHelper(){
		this.isRun = function(){
			var urls=["youtube.com", "facebook.com"];
			for(var i=0; i<urls.length;i++){
				if(window.location.host.indexOf(urls[i])!=-1){
					return true;
				}
			}
			return false;
		};
		this.start = function(){
			if(!this.isRun()){
				return;
			}
			setInterval(function(){
				const host = window.location.host;
				const href = window.location.href;
				const eleId = "free-xx1-player-script-9999";

				//youtube解析
				if(host.indexOf("youtube.com")!=-1){
					if(href.indexOf("youtube.com/watch")!=-1){
						if($("#"+eleId).length != 0){
							return;
						}
						var iconVideo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAADOUlEQVRoQ+2Zz4uNURjHP9+F8g8gykKJNJMUUmzMDKZmYVYsLBRhOaEmFhRRLCZDY4PBrJRREkUMmY3URCk/s6GMhR9ZWNk9OvXO7b133ve+57w/7szUnLqbe59fn/Oc85znnCvm+NAcj595gHgGzWwDsBZYDawEFgI/gT/AR0nDZWe8lAyYWTewF9iTEeA4MCTpblkghQHM7BxwPDCgAUn9gTqJ4oUAzOwKcChnICOS9uXUranlBjCza8CBggFclHSkiI1cAGbWBTwt4jim2y3pSV5bwQBmtgq4BazP67RB7w3gsvAX+CbpV4hdL4CoPG4H3KcjxEEOWVdyHwPjkq5m6WcCmNmFaIaybFXx+2vgsqSRNOOpAGa2GHhY4lIpAnha0qkkA4kAZuZO0k9FPFag2yHJHYR1Iw3gO7CsgiCKmPwMdEmajBuZBmBmbuMcLOKpQt1BSUdTAczMVZmQmjwtpTmC3xqo0ybpw5ROXQbMrA+45GtQUmYVy7JlZpYl0/B73YZuBAjqbWYI4KWkzWkZeBVSNuMAZua1FBorSY4MTEpangYQlM4EgOdZy6ExazkAiNtoXELvgLasIGr0sT0QZaAVAO8ltadlYBTYNcsB7kjanQZwHjg2ywGaViHXIruN7DVmYA+4lnudpC+JGXBfhlwTZwDAPQi4s6o2kloJ9yzyyKcXajGA64F6JL1tChBlwdX0oIrSgirUK+l+49pudh/IhGhhBvolDSRtzKa9jJktBdxrWk+icvXnwO3oIexFWlXJbMbMbAGwJQWg1o0WWEKpLUjSBcZ7CXnV0ZhQXoBQP/MAUzNgZu5Z8EbRGQT2S7qZ107mHmhmuIQnl2lXxFCQQgDRmTEGbAt1DIxJ2pFDr06lDIBFgDsdlwQE8wNol/Q7QCdRtDBAlIVO4FlAMJ2SMk96H3ulAEQQh4FBD6d9koY85LxESgOIIK67qtLE87CkUt+cSgWIICaAjQkQE5I2eU1rgFAVACsA9/Dk/qGcGv+ANZK+BsTmJVo6QJSFXuBeLIKdkh54RRQoVAlABHECOAOclHQ2MC5v8coAIojR+AuCd1QBgpUCBMSRW3QeIPfUlaT4H0/7RUAi2a/NAAAAAElFTkSuQmCC";
						var html='<div id="'+eleId+'" style="width:25px;padding:10px 0px;text-align:center;background-color:#E5212E;position:fixed;top:250px;left:0px;color:#FFF;font-size:0px;z-index:9999999999999;cursor:pointer;margin:0px auto;text-align:center;">'+
							'<img src="'+iconVideo+'" style="width:20px;">'+
							'</div>';
						$("body").append(html);
						$("body").on("click", "#"+eleId, function(){
							var location_url = window.location.href;
							var videourl = "https://yt1s.com/?q="+location_url;
							commonFunctionObject.GMopenInTab(videourl, false);
						});
					}else{
						$("#"+eleId).remove();
					}
				}

				//facebook解析
				if(host.indexOf("facebook.com")!=-1){
					if(href.indexOf("facebook.com/watch")!=-1 || href.indexOf("/videos/")!=-1){
						if($("#"+eleId).length != 0){
							return;
						}
						var iconVideo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAADOUlEQVRoQ+2Zz4uNURjHP9+F8g8gykKJNJMUUmzMDKZmYVYsLBRhOaEmFhRRLCZDY4PBrJRREkUMmY3URCk/s6GMhR9ZWNk9OvXO7b133ve+57w/7szUnLqbe59fn/Oc85znnCvm+NAcj595gHgGzWwDsBZYDawEFgI/gT/AR0nDZWe8lAyYWTewF9iTEeA4MCTpblkghQHM7BxwPDCgAUn9gTqJ4oUAzOwKcChnICOS9uXUranlBjCza8CBggFclHSkiI1cAGbWBTwt4jim2y3pSV5bwQBmtgq4BazP67RB7w3gsvAX+CbpV4hdL4CoPG4H3KcjxEEOWVdyHwPjkq5m6WcCmNmFaIaybFXx+2vgsqSRNOOpAGa2GHhY4lIpAnha0qkkA4kAZuZO0k9FPFag2yHJHYR1Iw3gO7CsgiCKmPwMdEmajBuZBmBmbuMcLOKpQt1BSUdTAczMVZmQmjwtpTmC3xqo0ybpw5ROXQbMrA+45GtQUmYVy7JlZpYl0/B73YZuBAjqbWYI4KWkzWkZeBVSNuMAZua1FBorSY4MTEpangYQlM4EgOdZy6ExazkAiNtoXELvgLasIGr0sT0QZaAVAO8ltadlYBTYNcsB7kjanQZwHjg2ywGaViHXIruN7DVmYA+4lnudpC+JGXBfhlwTZwDAPQi4s6o2kloJ9yzyyKcXajGA64F6JL1tChBlwdX0oIrSgirUK+l+49pudh/IhGhhBvolDSRtzKa9jJktBdxrWk+icvXnwO3oIexFWlXJbMbMbAGwJQWg1o0WWEKpLUjSBcZ7CXnV0ZhQXoBQP/MAUzNgZu5Z8EbRGQT2S7qZ107mHmhmuIQnl2lXxFCQQgDRmTEGbAt1DIxJ2pFDr06lDIBFgDsdlwQE8wNol/Q7QCdRtDBAlIVO4FlAMJ2SMk96H3ulAEQQh4FBD6d9koY85LxESgOIIK67qtLE87CkUt+cSgWIICaAjQkQE5I2eU1rgFAVACsA9/Dk/qGcGv+ANZK+BsTmJVo6QJSFXuBeLIKdkh54RRQoVAlABHECOAOclHQ2MC5v8coAIojR+AuCd1QBgpUCBMSRW3QeIPfUlaT4H0/7RUAi2a/NAAAAAElFTkSuQmCC";
						var html='<div id="'+eleId+'" style="width:25px;padding:10px 0px;text-align:center;background-color:#E5212E;position:fixed;top:250px;left:0px;color:#FFF;font-size:0px;z-index:9999999999999;cursor:pointer;margin:0px auto;text-align:center;">'+
							'<img src="'+iconVideo+'" style="width:20px;">'+
							'</div>';
						$("body").append(html);
						$("body").on("click", "#"+eleId, function(){
							var location_url = window.location.href;
							commonFunctionObject.GMsetValue("facebook_downloader_obj", {"facebook_url":location_url});
							commonFunctionObject.GMopenInTab("https://yt1s.com/facebook-downloader", false);
						});
					}else{
						$("#"+eleId).remove();
					}
				}
			}, 500);

			if(window.location.href.indexOf("yt1s.com/facebook-downloader")!=-1){ //facebook下载
				var facebookObject = commonFunctionObject.GMgetValue("facebook_downloader_obj");
				if(!!facebookObject){
					$("#s_input").val(facebookObject.facebook_url);
				}
			}
		}
	}

	//优惠券查询
	function queryCoupon(){
		this.isRun = function(){
			var urls=["detail.tmall.com", "item.taobao.com", "item.jd.com", "item.yiyaojd.com", "npcitem.jd.hk", "detail.tmall.hk"];
			for(var i=0; i<urls.length;i++){
				if(window.location.host.indexOf(urls[i])!=-1){
					return true;
				}
			}
			return false;
		}
		this.getPlatform = function(){
			let host = window.location.host;
			let platform = "";
			if(host.indexOf("detail.tmall")!=-1){
				platform = "tmall";
			}else if(host.indexOf("item.taobao.com")!=-1){
				platform = "taobao";
			}else if(host.indexOf("jd.com")!=-1 || host.indexOf("npcitem.jd.hk")!=-1){
				platform = "jd";
			}
			return platform;
		};
		this.filterStr = function(str){
			if(!str) return "";
			str = str.replace(/\t/g,"");
			str = str.replace(/\r/g,"");
			str = str.replace(/\n/g,"");
			str = str.replace(/\+/g,"%2B");//"+"
			str = str.replace(/\&/g,"%26");//"&"
			str = str.replace(/\#/g,"%23");//"#"
			return encodeURIComponent(str)
		};
		this.getParamterQueryUrl = function(tag) { //查询GET请求url中的参数
			var t = new RegExp("(^|&)" + tag + "=([^&]*)(&|$)");
			var a = window.location.search.substr(1).match(t);
			if (a != null){
				return a[2];
			}
			return "";
		};
		this.getEndHtmlIdByUrl = function(url) { //获得以html结束的ID
			if(url.indexOf("?")!=-1){
				url = url.split("?")[0]
			}
			if(url.indexOf("#")!=-1){
				url = url.split("#")[0]
			}
			var splitText = url.split("/");
			var idText = splitText[splitText.length-1];
			idText = idText.replace(".html","");
			return idText;
		};
		this.getGoodsData = function(platform){
			var goodsId = "";
			var goodsName = "";
			var href = window.location.href;
			if(platform=="taobao"){
				goodsId = this.getParamterQueryUrl("id");
				goodsName=$(".tb-main-title").text();

			}else if(platform=="tmall"){
				goodsId = this.getParamterQueryUrl("id");
				goodsName=$(".tb-detail-hd").text();

			}else if(platform=="jd"){
				goodsName=$("div.sku-name").text();
				goodsId = this.getEndHtmlIdByUrl(href);

			}
			var data={"goodsId":goodsId, "goodsName":this.filterStr(goodsName)}
			return data;
		};
		this.randomSpmValue=function(){
			$("meta[name='data-spm']").each(function(){
				var max = 5000;
				var min = 1000;
				var randomValue = Math.floor(Math.random() * (max - min + 1) ) + min;
				var randomLetter = String.fromCharCode(Math.floor( Math.random() * 26) + "a".charCodeAt(0));
				$(this).attr("content", randomValue+randomLetter);
			});
			$("meta[name='spm-id']").each(function(){
				var max = 5000;
				var min = 1000;
				var randomValue = Math.floor(Math.random() * (max - min + 1) ) + min;
				var randomLetter = String.fromCharCode(Math.floor( Math.random() * 26) + "a".charCodeAt(0));
				$(this).attr("content", randomValue+randomLetter);
			});
		};
		this.runAliDeceptionSpm=function() {
			if(window.location.host.indexOf("aliyun.com")!=-1 || window.location.host.indexOf("taobao.com")!=-1 || window.location.host.indexOf("tmall.com")!=-1){
				this.randomSpmValue();
				setInterval(()=>{
					this.randomSpmValue();
				}, 4000);
			}
		};
		this.request = function(mothed, url, param){
			return new Promise(function(resolve, reject){
				GM_xmlhttpRequest({
					url: url,
					method: mothed,
					data:param,
					onload: function(response) {
						var status = response.status;
						var playurl = "";
						if(status==200||status=='200'){
							var responseText = response.responseText;
							resolve({"result":"success", "json":responseText});
						}else{
							reject({"result":"error", "json":null});
						}
					}
				});
			})
		};
		this.createCouponHtml = function(platform, goodsId, goodsName){
			if(!platform || !goodsId) return;
			var goodsCouponUrl = "http://tt.shuqiandiqiu.com/api/coupon/discover?no=5&v=1.0.1&pl="+platform+"&id="+goodsId+"&qu="+goodsName;
			var goodsPrivateUrl = "http://tt.shuqiandiqiu.com/api/private/change/coupon?no=5&platform="+platform+"&id=";
			this.request("GET", goodsCouponUrl, null).then((resutData)=>{
				if(resutData.result==="success" && !!resutData.json){
					var data = JSON.parse(resutData.json).data;
					if(!data || data==="null" || !data.css || !data.html || !data.handler){
						return;
					}
					var cssText = data.css;
					var htmlText = data.html;
					var handler = data.handler;
					var templateId = data.templateId;
					if(!cssText || !htmlText || !handler){
						return;
					}
					$("body").prepend("<style>"+cssText+"</style>");

					var handlers = handler.split("@");
					for(var i=0; i<handlers.length; i++){
						var $handler = $(""+handlers[i]+"");
						if(platform=="taobao"){
							$handler.parent().after(htmlText);
						}else if(platform=="tmall"){
							$handler.parent().after(htmlText);
						}else if(platform=="jd"){
							$handler.after(htmlText);
						}
					}
					var $llkk = $("#"+templateId);
					if($llkk.length != 0){
						let couponElementA = $llkk.find("a[name='cpShUrl']");
						couponElementA.unbind("click").bind("click", ()=>{
							event.stopPropagation();
							event.preventDefault();
							let couponId = $llkk.data("id");
							if(!!couponId){
								this.request("GET", goodsPrivateUrl+couponId, null).then((resutData2)=>{
									if(resutData2.result==="success" && !!resutData2.json){
										let url = JSON.parse(resutData2.json).url;
										if(!!url) GM_openInTab(url, {active:true});
									}
								});
							}
						});
						setInterval(()=>{
							couponElementA.removeAttr("data-spm-anchor-id");
						},100);
					}
				}
			});
		};
		this.start = function(){
			if(this.isRun()){
				var platform = this.getPlatform();
				if(!!platform){
					var goodsData = this.getGoodsData(platform);
					this.createCouponHtml(platform, goodsData.goodsId, goodsData.goodsName);
				}
			}
			this.runAliDeceptionSpm();
		};
	}

	//全网音乐解析下载
	function superMusicHelper(){
		this.eleId = Math.ceil(Math.random()*100000000);
		this.isRun = function(){
			var urls=["music.163.com","y.qq.com","www.kugou.com","www.kuwo.cn","www.xiami.com","music.taihe.com","music.migu.cn","lizhi.fm","qingting.fm","ximalaya.com"];
			for(var i=0; i<urls.length;i++){
				if(window.location.host.indexOf(urls[i])!=-1){
					return true;
				}
			}
			return false;
		};
		this.getPlayUrl = function(){
			var currentHost = window.location.host;
			var currentUrl = window.location.href;
			var playUrl = null;
			if(currentUrl.match(/music\.163\./)){ //网易云音乐
				if(currentUrl.match(/^https?:\/\/music\.163\.com\/#\/(?:song|dj)\?id/)) {
					playUrl = 'https://music.liuzhijin.cn/?url='+encodeURIComponent(currentUrl);
				}else if(currentUrl.match(/^https?:\/\/y\.music\.163\.com\/m\/(?:song|dj)\?id/)) {
					playUrl = 'https://music.liuzhijin.cn/?url='+encodeURIComponent('https://music.163.com/song?id='+getQueryString('id'));
				}
			}
			else if(currentUrl.match(/y\.qq\.com/)){ //QQ音乐
				if(currentUrl.indexOf("?")) currentUrl = currentUrl.split("?")[0];
				if(currentUrl.indexOf("#")) currentUrl = currentUrl.split("#")[0];
				var musicMatch = currentUrl.match(/^https?:\/\/y\.qq\.com\/n\/ryqq\/songDetail\/(\S*)/);
				if(musicMatch){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch[1]+'&type=qq'
				}
				var musicMatch2 = currentUrl.match(/^https?:\/\/y\.qq\.com\/n\/yqq\/song\/(\S*).html/);
				if(musicMatch2){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch2[1]+'&type=qq';
				}
			}
			else if(currentUrl.match(/kugou\.com/)){ //酷狗
				var musicMatch = currentUrl.match(/hash=(\S*)&album/);
				if(musicMatch){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch[1]+'&type=kugou';
				}
			}
			else if(currentUrl.match(/kuwo\.cn/)){  //酷我
				if(currentUrl.indexOf("?")) currentUrl = currentUrl.split("?")[0];
				if(currentUrl.indexOf("#")) currentUrl = currentUrl.split("#")[0];
				var musicMatch = currentUrl.match(/play_detail\/(\S*)/);
				if(musicMatch){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch[1]+'&type=kuwo';
				}
			}
			else if(currentUrl.match(/www\.ximalaya\.com/)){ //喜马拉雅
			    var xmlyUrlArr = currentUrl.split("/");
			    for(var xuaIndex =0;xuaIndex<xmlyUrlArr.length;xuaIndex++){
			        if(xuaIndex==xmlyUrlArr.length-1){
						playUrl = 'https://music.liuzhijin.cn/?id='+xmlyUrlArr[xuaIndex]+'&type=ximalaya&playUrl='+encodeURIComponent(currentUrl);
			        }
			    }
			}
			else if(currentUrl.match(/www\.lizhi\.fm/)){ //荔枝音乐
				if(currentUrl.indexOf("?")) currentUrl = currentUrl.split("?")[0];
				if(currentUrl.indexOf("#")) currentUrl = currentUrl.split("#")[0];
				var musicMatch = currentUrl.match(/^https?:\/\/www\.lizhi\.fm\/(\d*)\/(\d*)/);
				if(musicMatch){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch[2]+'&type=lizhi';
				}
			}
			else if(currentUrl.match(/music\.migu\.cn/)){ //咪咕音乐
				if(currentUrl.indexOf("?")) currentUrl = currentUrl.split("?")[0];
				if(currentUrl.indexOf("#")) currentUrl = currentUrl.split("#")[0];
				var musicMatch = currentUrl.match(/^https?:\/\/music\.migu\.cn\/v3\/music\/song\/(\S*)/);
				if(musicMatch){
					playUrl = 'https://music.liuzhijin.cn/?id='+musicMatch[1]+'&type=migu';
				}
			}
			return playUrl;
		};
		this.addStyle=function(){
			var innnerCss =
			"@keyframes turnaround{0%{-webkit-transform:rotate(0deg);}25%{-webkit-transform:rotate(90deg);}50%{-webkit-transform:rotate(180deg);}75%{-webkit-transform:rotate(270deg);}100%{-webkit-transform:rotate(360deg);}}"+
			"#plugin_kiwi_analysis_vip_music_box_"+this.eleId+" {position:fixed; top:150px; left:0px; width:26px; background-color:#E5212E;z-index:9999999899999;}"+
			"#plugin_kiwi_analysis_vip_music_box_"+this.eleId+" >.plugin_item{cursor:pointer; width:100%; padding:10px 0px; text-align:center;}"+
			"#plugin_kiwi_analysis_vip_music_box_"+this.eleId+" >.plugin_item >img{width:20px; display:inline-block; vertical-align:middle;animation:turnaround 4s linear infinite;}";
			$("body").prepend("<style>"+innnerCss+"</style>");
		};
		this.generateHtml=function(){
			var $that = this;
			var html="";
			var vipImgBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADJklEQVRYR6WXS6hOURTHf/8wux4TMZCBxwApJRSKXG8uGbieKQYGXpEMKLkGGFCURyEDJHFL6cr1uF4DlDJATDwGBnKVtzJAS0v7u53vfPvcc75j1e57nL3X+u2193ocUVDMrB8wFZgCjAcGhOEaOsN4BNwD7kr6UkS1ikwys2ZgHzCkyHzgDbBd0sW8+d0CmFmPYHhbnqKM5/sDyJ+s9ZkAZjYNuFXScHpZo6TbMV1RgODyCyWN3wGuhPEVmAecApbEjqQGwMx6Ar/qMP45GLsO3JT0Ib3WzCz810vS7+TzGMBVYE4OwHfgjBsEbkj62d38BEC7pLmZAGa2DjiaY/wGsE3S06JeSgD4kvWSjlXWdnnAzPoAz4DBOYqbJPkZF5YUwFtgtKRvriAJMAu4lqdVUl7oDgeawjgmqTUF4CZmS/I7UwWw12O2DICZTQbmA76JMQkduyW1RAD2SdqRBrgPTCwKYGZ+UWcGoyMy1mUBPJA0KQ3wChhaBMDM1gLH8+YCWQCvJQ1LA3hoNeQp9TtgZi3Arry5QIuk3ZEj+CGpdxrgfaK6ZequEyDLA52SBqYBPKlMz9tVDoAnpJfAp6DHy3LMAx2SZqQBDgKb/wPgOdAs6UVFh5k1SPoROYJDkrakAYpkQTI8UGM8uZEIQFc2TCYid78fQ1K809kDeA73KPknkUu4UdKRmPfMrD+QLlAzJHVUeSAoPgcsD4p8V8tjOT8C4K5vzQDYABxOPGuTtKDyuyqtmtk44CHgndBkSZ6caiQC0A5sSnopbGgxkG7LqmpJrBwfALZ2l/PN7DLQtYtA+A44Gb73Df1jek7V7muOIFAPArxQrI15wMyWAufzoiXy3BuRRelKmtWSjQQueUMq6XQAGwt4pKwpYfwjsFJSTbXtril1CD+/USUMJpd4i74q6z7l1XaH8DK9sCREG7BT0pOs9UVfTBqB1cCKgiBu+ESRzqkQQCIBTfAIATy8YvI4VMDCLVtdAAkQ7wW8J0jKWUmrCnqoa1opgBAVfkErnmiV5O+Pdcv/AHhDUal8IyV5Q1O3lAYIXljmn5LKJKZ/sH8B8jdXMDutk64AAAAASUVORK5CYII=";
			html+= "<div id='plugin_kiwi_analysis_vip_music_box_"+this.eleId+"'>";
			html+= "<div class='plugin_item jump_analysis_website' title='点我VIP音乐破解，免客户端下载！'><img src='"+vipImgBase64+"'></div>";
			html+= "</div>";
			$("body").append(html);

			$("#plugin_kiwi_analysis_vip_music_box_"+this.eleId+"").on("click", function(){
				var playUrl = $that.getPlayUrl();
				if(!!playUrl) GM_openInTab(playUrl, false);
			})
		};
		this.operation=function(){
			var $that = this;
			setInterval(function(){
				var playUrl = $that.getPlayUrl();
				var $vipMusicBox = $("#plugin_kiwi_analysis_vip_music_box_"+$that.eleId+"");
				if(!!playUrl){
					if($vipMusicBox.length==0){
						$that.generateHtml();
					}
				}else{
					$vipMusicBox.remove();
				}
			}, 100);
		};
		this.start=function(){
			if(this.isRun()){
				this.addStyle();
				this.operation();
			}
		};
	}

	/**
	 * 来搜一下，网盘搜索引擎无线下载
	 * @param {Object} toolObject
	 */
	function wangpanSearchEnginesHelper(toolObject){
		this.toolObject=toolObject;
		this.start = function(){
			let $that = this;
			if(window.location.host==="www.laisoyixia.com" && window.location.href.indexOf("/download/detail")!=-1){
				var $downloadBtn = $("#downloadHandler");
				var downloadurl = $downloadBtn.data("downloadurl");
				if(!!downloadurl){
					var wangpanUrl = window.atob(downloadurl);
					$downloadBtn.after("<div style='padding:15px;background-color:#eee;margin-top:15px;'>插件提取所得：<a target='_blank' href='"+wangpanUrl+"'>"+wangpanUrl+"</a></div>")
				}
			}
		}
	}

	/**
	 * @param {Object} toolObject
	 * hostwinds
	 */
	function hostwindsHelper(toolObject){
		this.toolObject=toolObject;
		this.start = function(){
			let $that = this;
			if(window.location.host==="www.hostwinds.com"){
				setInterval(function(){
					$("body").find("a").each(function(){
						if($(this).attr("xxooi")!="true"){
							let href = $(this).attr("href");
							if(!!href){
								if(href==="https://www.hostwinds.com/hosting/business" || href==="/hosting/business"){
									$(this).attr("href", "https://www.hostwinds.com/11747-17.html");
								}
								if(href==="https://www.hostwinds.com/cloud/cloud-servers" || href==="/cloud/cloud-servers"){
									$(this).attr("href", "https://www.hostwinds.com/11747-1.html");
								}
								if(href==="https://www.hostwinds.com/dedicated/servers"  || href==="/dedicated/servers"){
									$(this).attr("href", "https://www.hostwinds.com/11747-10.html");
								}
								if(href==="https://www.hostwinds.com/vps/linux" || href==="/vps/linux"){
									$(this).attr("href", "https://www.hostwinds.com/11747-6.html");
								}
								if(href==="https://www.hostwinds.com/vps/windows" || href==="/vps/windows"){
									$(this).attr("href", "https://www.hostwinds.com/11747-9.html");
								}
								if(href==="https://www.hostwinds.com/vps/minecraft" || href==="/vps/minecraft"){
									$(this).attr("href", "https://www.hostwinds.com/11747-11.html");
								}
								if(href==="https://www.hostwinds.com/hosting/reseller" || href==="/hosting/reseller"){
									$(this).attr("href", "https://www.hostwinds.com/11747-3.html");
								}
								if(href==="https://www.hostwinds.com/hosting/shared" || href==="/hosting/shared"){
									$(this).attr("href", "https://www.hostwinds.com/11747-2.html");
								}
								if(href==="https://www.hostwinds.com/vps/unmanaged-linux" || href==="/vps/unmanaged-linux"){
									$(this).attr("href", "https://www.hostwinds.com/11747-5.html");
								}
								if(href==="https://www.hostwinds.com/vps/unmanaged-windows" || href==="/vps/unmanaged-windows"){
									$(this).attr("href", "https://www.hostwinds.com/11747-7.html");
								}
								if(href==="https://www.hostwinds.com/hosting/whitelabel" || href==="/hosting/whitelabel"){
									$(this).attr("href", "https://www.hostwinds.com/11747-4.html");
								}
								$(this).attr("rel","noreferrer nofollow noopener");
							}
							$(this).attr("xxooi", "true");
						}
					});
				}, 500);
			}
		}
	}

	//最后统一调用
	try{
		(new superVideoHelper(newOriginalInterfaceList, playerNodes)).start();
	}catch(e){
		console.log("全网VIP解析：error："+e);
	}
	try{
		(new abroadVideoHelper()).start();
	}catch(e){
		console.log("国外视频解析：error："+e);
	}
	try{
		(new queryCoupon()).start();
	}catch(e){
		console.log("优惠券查询：error："+e);
	}
	try{
		(new superMusicHelper()).start();
	}catch(e){
		console.log("全网音乐下载：error："+e);
	}
	try{
		new huahuacat_bilibili(commonFunctionObject).start();
	}catch(e){
		console.log("B站视频下载：error："+e);
	}
	try{
		new wangpanSearchEnginesHelper(commonFunctionObject).start();
	}catch(e){
		console.log("搜索引擎破解：error："+e);
	}
	try{
		new hostwindsHelper(commonFunctionObject).start();
	}catch(e){
		console.log("hostwinds：error："+e);
	}
})();
```

### b站成分标签器

基于原三相之力改造，优化代码，新增内容，简化显示
主要原理就是设定关键词，遍历用户动态查询关键词，返回结果，但是原来的代码是手动遍历各种情况，不太智能，特优化代码如下

```js
// ==UserScript==
// @name         b站成分查询
// @version      0.0.1
// @description  B站评论区自动标注原农舟玩家，依据是动态里是否有相关内容
// @author       vanndxh
// @match        https://www.bilibili.com/video/*
// @match        https://t.bilibili.com/*
// @match        https://space.bilibili.com/*
// @match        https://www.bilibili.com/read/*
// @icon         https://static.hdslb.com/images/favicon.ico
// @connect      bilibili.com
// @grant        GM_xmlhttpRequest
// @license MIT
// @run-at document-end
// ==/UserScript==

(function () {
  "use strict";
  const unknown = new Set();

  /** 静态资源准备 高亮*/ 
  const keyword = {
    原: ["原神", "魈", "钟离", "万叶", "雷神", "可莉"],
    农: ["王者荣耀", "澜", "娜可露露", "元歌", "亚瑟", "妲己", "kpl", "KPL"],
    LOL: ["LOL", "LPL"],
    舟: ["明日方舟", "温蒂"],
    任: ["任天堂", "塞尔达", "宝可梦", "switch", "Switch"],
    主机: ["主机", "手柄", "switch", "Switch"],
    只因: ["小黑子", "只因", "cxk", "鸡脚", "鸡你太美", "只因你太美"],
    抽奖: ["互动抽奖"],
  };
  let tagList = [];
  const blog =
    "https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/space?&host_mid=";
  const isNew = document.getElementsByClassName("item goback").length != 0; // 检测是不是新版
  const whiteList = ["363270906"];

  /** 工具函数 */
  const getPid = (c) => {
    return isNew
      ? c.dataset["userId"]
      : c.children[0]["href"].replace(/[^\d]/g, "");
  };

  const getCommentList = () => {
    if (isNew) {
      let lst = new Set();
      for (let c of document.getElementsByClassName("user-name")) {
        lst.add(c);
      }
      for (let c of document.getElementsByClassName("sub-user-name")) {
        lst.add(c);
      }
      return lst;
    } else {
      return document.getElementsByClassName("user");
    }
  };

  /** 查询主体 */
  let jiance = setInterval(() => {
    let commentlist = getCommentList();
    if (commentlist.length !== 0) {
      commentlist.forEach((comment) => {
        let pid = getPid(comment);
        // 作者保护通道
        if (whiteList.includes(pid)) {
          const safeTag =
            "<b style='background-image: -webkit-linear-gradient(left, #1E90FF, #BA55D3); -webkit-background-clip: text; -webkit-text-fill-color: transparent;'>" +
            `【帅气的开发者】` +
            "</b>";
          comment.innerHTML += safeTag;
          clearInterval(jiance);
          return;
        }

        unknown.add(pid);
        let blogurl = blog + pid;
        GM_xmlhttpRequest({
          method: "get",
          url: blogurl,
          data: "",
          headers: {
            "user-agent":
              "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36",
          },
          onload: function (res) {
            if (res.status === 200) {
              let st = JSON.stringify(JSON.parse(res.response).data);
              unknown.delete(pid);

              Object.entries(keyword)?.map((i) => {
                let have = false;
                i[1]?.map((j) => {
                  if (st.includes(j)) {
                    if (!have) {
                      tagList.push(i[0]);
                    }
                    have = true;
                  }
                });
                if (have) {
                  return;
                }
              });
              const tagFinal =
                "<b style='background-image: -webkit-linear-gradient(left, #1E90FF, #BA55D3); -webkit-background-clip: text; -webkit-text-fill-color: transparent;'>" +
                `【${tagList?.join(",")}】` +
                "</b>";

              if (tagList.length !== 0) {
                comment.innerHTML += tagFinal;
                clearInterval(jiance);
              }
              tagList = [];
            } else {
              console.log("失败", res);
            }
          },
        });
        return;
      });
    }
  }, 1000);
})();
```

普通用户只需找到高亮行，按示例修改keyword，即可自定义

### **b站直播间关闭22娘**

```js
// ==UserScript==
// @name         b站直播间关闭22娘
// @version      0.1
// @description  b站直播间关闭22娘
// @author       vanndxh
// @match        https://live.bilibili.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=bilibili.com
// @run-at       document-end
// @grant        none
// ==/UserScript==


(function () {
  "use strict";

  const elements = document.getElementsByClassName("avatar-btn");

  let timer = setInterval(() => {
    if (elements.length > 0) {
      elements[0].remove();
      clearInterval(timer);
    }
  }, 5000);
})();
```

### **爱奇艺去除无用内容**

```
/**
 * @file 爱奇艺播放页面删除无用内容
 */
const iqiyi = () => {
  const classNames = [
    "header-sideItem qy-header__game",
    "header-sideItem header-download",
    "header-sideItem header-upload",
    "iqp-ivos-video-top",
    "header__weather",
    "header-sideItem header-vip",
    "nav-link nav-vip",
    "qy-player-side-list",
    "qy-nav",
  ];
  // 顶部目录无用内容
  classNames.forEach((i) => {
    const ele = document.getElementsByClassName(i)[0];
    if (ele) {
      ele.remove();
    }
  });

  // 右侧推荐视频栏
  Array(10)
    .fill(0)
    .forEach(() => {
      const element = document.getElementsByClassName("wrap")[0];
      if (element) {
        element.remove();
      }
    });
};

setTimeout(() => {
  iqiyi();
}, 3000);
```

### 下载极客时间文章

```js
// ==UserScript==
// @name         极客时间专栏文章
// @namespace    https://github.com/gyg0522
// @version      0.0.1
// @description  添加一个按钮，保存.md文章
// @author       Kerry
// @match        *://time.geekbang.org/column/article/*
// @grant        none
// @require      https://unpkg.com/ajax-hook@1.8.3/dist/ajaxhook.min.js
// @require      https://unpkg.com/showdown/dist/showdown.min.js
// ==/UserScript==

(function() {
    'use strict';

    const KEY_CONTENT = "mdContent";
    const KEY_TITLE = "mdTitle";
    const FILE_TYPE = "application/md";
    const articleRequestUrlRegex = /^https?:\/\/time\.geekbang\.org\/serv\/v\d\/article/;
    const mdService = new showdown.Converter();

    hookAjax({
        //拦截回调
        onreadystatechange:function(xhr){
            // console.log("onreadystatechange called: %O",xhr)
            if (xhr.readyState === 4 && articleRequestUrlRegex.test(xhr.responseURL)) {
                console.log(xhr.response);
                let resJson = JSON.parse(xhr.response);
                let title = resJson.data.article_title;
                let data = resJson.data.article_content;
                const mdContent = mdService.makeMarkdown("<h1>" + title + "</h1>" + data);
                sessionStorage.setItem(KEY_TITLE, title);
                sessionStorage.setItem(KEY_CONTENT, mdContent);

                genSaveBtn();
            }
        }
    });

    const genSaveBtn = () => {
        let saveBtn = document.querySelector("#save_btn");
        if (saveBtn) {
            // saveBtn.onclick = () => {
            //  createAndDownloadFile("正文.md", sessionStorage.getItem(KEY_CONTENT));
            // }
        }
        else {
            saveBtn = document.createElement("div");
            saveBtn.id = "save_btn";
            saveBtn.textContent = "存";
            saveBtn.onclick = () => {
                createAndDownloadFile(sessionStorage.getItem(KEY_TITLE) + ".md", sessionStorage.getItem(KEY_CONTENT));
            };
            setSaveBtnStyle(saveBtn);
            document.querySelector("#app").appendChild(saveBtn);
        }
    }

    const setSaveBtnStyle = (saveBtn) => {
        saveBtn.style.position = "fixed";
        saveBtn.style.bottom = "2em";
        saveBtn.style.right = "2em";
        saveBtn.style.borderRadius = "50%";
        saveBtn.style.backgroundColor = "#f6f7f9";
        saveBtn.style.color = "red";
        saveBtn.style.height = "38px";
        saveBtn.style.width = "38px";
        saveBtn.style.textAlign = "center";
        saveBtn.style.lineHeight = "38px";
        saveBtn.style.border = "1px solid #f6f7f9";
        saveBtn.style.cursor = "pointer";
    }

    const createAndDownloadFile = (fileName, content) => {
        let aTag = document.createElement('a');
        let blob = new Blob([content], {type: FILE_TYPE});
        aTag.download = fileName;
        aTag.href = URL.createObjectURL(blob);
        aTag.click();
        URL.revokeObjectURL(blob);
    }
    })();
```

## 发布脚本

**发布脚本的平台主要有两个：**

- [GreasyFork](https://greasyfork.org/)
- [OpenUserJS](https://openuserjs.org/)

**下面以 `GreasyFork`为例:** 首先要有一个GreasyFork的账号，点击[这个链接](https://greasyfork.org/zh-CN/users/sign_in?return_to=%2Fzh-CN)前往注册，如下图所示：

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY295Y3M=,size_20,color_FFFFFF,t_70,g_se,x_16.png)

点击右上角你的名字进入你的主页，点击 `**发布你编写的脚本** `，如下图所示：

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/1be2548d26c448c48292d2cc31852c84.gif) 

在 **`代码 `**置直接粘贴自己的代码或者本地上传文件 在 **`附加信息 `**位置可以写脚本的介绍等其他信息，支持HTML和Markdown 其他选项可以直接默认，最后点击 **`发布脚本 。`**

## 进阶

写成独立chrome插件，github源码[GitHub - vanndxh/van: 写着玩的chrome插件](https://github.com/vanndxh/van)

# 基础

## 元数据

<img src="%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231213133351990.png" alt="image-20231213133351990" style="zoom: 150%;" />

上图里的代码头是自带的，叫做元数据。每个用户脚本都含有一段元数据，用来向 Tampermonkey 描述这个脚本自身的信息：`脚本名，作者，描述，执行规则`等等

| 属性名      | 作用                                                         |
| ----------- | ------------------------------------------------------------ |
| name        | 油猴脚本的名字                                               |
| namespace   | 命名空间，类似于Java的包名，用来区分相同名称的脚本，一般写成作者名字或者网址就可以了 |
| version     | 脚本版本，油猴脚本的更新会读取这个版本号                     |
| description | 描述，用来告诉用户这个脚本是干什么用的                       |
| author      | 作者名字                                                     |
| match       | 只有匹配的网址才会执行对应的脚本，例如*、http://*、http://www.baidu.com/*等，参见[谷歌开发者文档](https://link.segmentfault.com/?enc=d4fm7ksMJZ9YIod8A%2B%2FNWA%3D%3D.DaYA998uwRu3fNOg0MYzwRvfUBCrfuAkG4Bj9mDCmiWf2Wm2HLgPpWWKqIIO9eytMMO3K5IFqTCz1JcsChz0TA%3D%3D) |
| grant       | 指定脚本运行所需权限，如果脚本拥有相应的权限，就可以调用油猴扩展提供的API与浏览器进行交互。如果设置为none的话，则不使用沙箱环境，脚本会直接运行在网页的环境中，这时候无法使用大部分油猴扩展的API。如果不指定的话，油猴会默认添加几个最常用的API |
| require     | 如果脚本依赖其他js库的话，可以使用require指令，在运行脚本之前先加载其他库，常见用法是加载jquery |
| connect     | 当用户使用[GM_xmlhttpRequest](https://link.segmentfault.com/?enc=paTrjDACBGn6FT6bxU%2B7yg%3D%3D.N7GuJ4bv%2FLyllfZogSnWysuAMjjtnWIunIhz6x2RKZUdvAV06CKow8N%2F0Osah3wHKwr48vKxma%2FC7RgIRsAjqa3KVExpqGKvFPziC4AcHWZYMDXDGbsvYKJYmvjdrgY8WGIoNtGRR5FZF0QCejT2Mg%3D%3D) 请求远程数据的时候，需要使用connect指定允许访问的域名，支持域名、子域名、IP地址以及*通配符 |
| updateURL   | 脚本更新网址，当油猴扩展检查更新的时候，会尝试从这个网址下载脚本，然后比对版本号确认是否更新 |

```javascript
// ==UserScript==
// @name         这里是你的编写的油猴脚本的名字
// @namespace    这个是命名空间；用来区分名称相同但是作者不同的用户脚本，一般都是写作者的个人网址，没有也可以写你的博客地址
// @version      0.1  这个是版本号
// @description  这个是功能描述，描述你的这个脚本是用来干嘛的
// @author       这个是作者的名字，比如我：jindao
// @match        这个是该脚本匹配的网址，支持通配符匹配
// @include		 这个也是该脚本匹配的网址，支持通配符匹配
// @exclude		 这个和 iclude 配合使用，排除匹配到的网址，优先于 include
// @grant        none  
// ==/UserScript==
```

+ match更严格一点，它对 * 角色的含义设定了更严格的规则
+ **@include**和 **@exclude** 是可选的，可以自定义执行和豁免的 URL，但必须每条规则各占一行。如果您没有任何定义， **Greasemonkey** 将会对所有的网站执行您的用户脚本。(等同于 **@include \***)。

您不能在 `@match` 中使用正则表达式 通配运算符

但是，`@include` 会向您的用户发出有关该脚本适用于所有站点的更可怕的安全警告。

即使 `@include` 表达式允许您对应用脚本的站点使用正则表达式片段 `[0-9]+`，或使用 `^https?://` 将这两种方案应用于脚本



例子

```js
// ==UserScript==
// @name         课程平台
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       kerry
// @match        *://test-kc.meishakeji.com/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==


// @require      https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js
// @connect vagrantup.com
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_addElement
// @grant GM_log
// @grant GM_xmlhttpRequest
// @grant unsafeWindow
// @grant window.close
// @grant window.focus
// ==/UserScript==

(function() {
    'use strict';
    GM_addElement('script', {
        src: 'https://example.com/script.js',
        type: 'text/javascript'
    });

    // Your code here...
})();
```

## 第一个脚本-HelloWorld

```js
// ==UserScript==
// @name         油猴中文网-HelloWorld
// @namespace    https://bbs.tampermonkey.net.cn/
// @version      0.1
// @description  油猴中文网-HelloWorld,一个演示demo,教程地址:https://bbs.tampermonkey.net.cn/forum.php?mod=viewthread&tid=88&extra=
// @author       You
// @match        https://bbs.tampermonkey.net.cn/
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // Your code here...
    alert('HelloWorld');
})();
```

![](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231212225321494.png)

访问 https://bbs.tampermonkey.net.cn/

![image-20231212225350429](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231212225350429.png)

## grant介绍none与unsafeWindow

### **grant**

这个属性可用来申请GM_*函数和unsafeWindow权限.相当于放在脚本header里面告诉油猴扩展,你需要用些什么东西,然后它就会给你相应的权限

更加详细的列表:
tampermonkey文档地址:https://www.tampermonkey.net/documentation.php#_grant
tampermonkey可申请api文档地址:https://www.tampermonkey.net/documentation.php#api

### **none和unsafeWindow**

+ **none**就是直接运行在前端页面中
+ **unsafeWindow **运行在一个沙盒环境去操作前端的元素

默认的情况下,"//@grant unsafeWindow"你的脚本运行在油猴给你创建的一个沙盒环境下,这个沙河环境无法访问到前端的页面,也就无法操作前端的一些元素等.

如果在页面最前方声明:"//@grant none", 那么油猴就会将你的脚本直接放在前端的上下文中执行, 这是的脚本上下文(window)就是前端的上下文.但是这样的话就无法使用GM_*等函数,无法与油猴交互,使用一些更强的功能.

所以一般写脚本的时候是使用**unsafeWindow**与前端交互,而不使用"//@grant none",这样就可以使用grant去申请油猴的一些更强的函数功能.这时候的脚本上下文(window)是沙盒的上下文,而不是前端的上下文.

在沙盒环境中,有一些window的操作也无法处理,需要使用grant来获取,例如:"// @grant window.onurlchange"(TamperMonkey文档中的)

```js
// ==UserScript==
...
// @grant window.onurlchange
// ==/UserScript==

if (window.onurlchange === null) {
    // feature is supported
    window.addEventListener('urlchange', (info) => ...);
}
```

这样的作法是为了避免恶意网页可以直接的使用GM_*函数,也可以避免被网页检测到GM_*插件的存在





## **引入Jquery**

注意:  网页自带jQuery,可以直接使用用, 无需引用

添加

```js
// @require https://code.jquery.com/jquery-2.1.4.min.js
/* globals jQuery, $, waitForKeyElements */
```

例子

```js
// ==UserScript==
// @name         New Userscript
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://fishc.com.cn/forum-243-1.html
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// @require https://code.jquery.com/jquery-2.1.4.min.js
// ==/UserScript==
(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */
    console.log($('#ct > div > div.bm.bml.pbn > div.bm_h.cl > h1 > a').text());
    alert('HelloWorld');
})();
```

![image-20231213143737018](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231213143737018.png)

方式2

```js
// ==UserScript==
// @name         使用 jQuery 的油猴脚本示例
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  在油猴脚本中使用 jQuery
// @match        https://www.example.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 加载 jQuery 库
    var jq = document.createElement('script');
    jq.src = "https://code.jquery.com/jquery-3.6.0.min.js";
    document.getElementsByTagName('head')[0].appendChild(jq);

    // 等待 jQuery 加载完毕后执行代码
    jq.onload = function() {
        console.log('jQuery 加载完成');
        // 在这里编写使用 jQuery 的代码
        $(document).ready(function(){
            // 此处为 jQuery 代码示例
            $("p").text("jQuery 脚本运行成功！");
        });
    };
})();

```



## 脚本自动化之模拟点击和表单填写

### **模拟点击**

```js
//html
<button id="btn" onclick="click()">按钮</button>

//js
btn.onclick=function(){
alert('按钮被点击了')
}

//jQuery
$('#btn').click(function(){
alert('按钮被点击了')
});
```

### **表单填写**

默认方法

```js
 输入框:
var input=document.querySelector('#input');
input.value="油猴中文网";
操作多选框:
var checkbox=document.querySelector('#checkbox');
checkbox.checked=true;
```

jquery方法

```js
// 设置输入框的值为"中文网"
$('#input').val('中文网');
// 设置多选框为选中状态
$('#checkbox').prop('checked', true);
```

### 例子

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/forum.php)

那么我们可以直接使用id来查询它,来看看它在不在这个页面上,在就表示没有登录
![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/forum-17024738464062.php)

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/forum-17024738859574.php)

```js
// ==UserScript==
// @name         油猴中文网-自动登录
// @namespace    https://bbs.tampermonkey.net.cn/
// @version      0.1.1
// @description  油猴中文网-自动登录,一个演示demo,教程地址:https://bbs.tampermonkey.net.cn/thread-91-1-1.html
// @author       You
// @match        https://bbs.tampermonkey.net.cn/
// @grant        none
// ==/UserScript==

var user="";
var pwd="";

if(!document.querySelector("#ls_username")){
//没有找到表示登录了,不再执行后续代码
return;
}
//未登录,执行登录代码

document.querySelector("#ls_username").value=user;
document.querySelector("#ls_password").value=pwd;
document.querySelector("#ls_cookietime").checked=true;

document.querySelector(".fastlg_l button").click();
```

例子

```js
// ==UserScript==
// @name         登录
// @namespace    https://github.com/Auroraol
// @version      0.1
// @description  长春大学教务系统登录
// @author       lfj
// @match        https://cdjwc.webvpn.ccu.edu.cn/jsxsd/
// @icon
// @grant        unsafeWindow
// @require      https://code.jquery.com/jquery-2.1.4.min.js
// ==/UserScript==


(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */
    var user="032141226";
    var pwd="-+66..[]l";
    $("#userAccount").val(user);
    $("#userPassword").val(pwd);
    $("#btnSubmit").click();

})();
```

## 获取链接列表

获取多个链接案例

```js
  var links = $("a[title='点击进入评价']").map(function() {
        return $(this).prop('href');
    }).get();

    links.forEach(function (value) {
        console.log(value)
    });
```

链接跳转案例

```
 <a href="/jsxsd/xspj/xspj_find.do?Ves632DSdyV=NEW_XSD_JXPJ">
```

```js
var link = $('a[href="/jsxsd/xspj/xspj_find.do?Ves632DSdyV=NEW_XSD_JXPJ"]').prop('href');
if (link) {
    //console.log(link);
    window.location.href = link;
}
```

href属性是一个javascript:UR案例

```js
[<a href="javascript:JsOpenWin('/jsxsd/xspj/xspj_edit.do?xnxq01id=2023-2024-1&pj01id=8E5FE8B38DD64FF19826ED88B3DD554E&pj0502id=015AF33A76A94498851F7D50C247C9E0&jx02id=5E81E951A1DB47248FBBA7FE065E1D15&jx0404id=202320241001034&xsflid=&zpf=98&jg0101id=01435&type=view',1000,700)">查看</a>]					
```

使用eval()函数来执行这个JavaScript代码。以下是一个示例：

```js
// ==UserScript==
// @name         自动点击评价链接
// @namespace    https://github.com/Auroraol
// @version      0.1
// @description  自动点击评价链接
// @author       lfj
// @match        http://your-website.com/*  // 请替换为你的网站地址
// @grant        none
// @require      https://code.jquery.com/jquery-2.1.4.min.js
// ==/UserScript==

(function() {
    'use strict';

    // 获取评价链接的JavaScript代码
    var jsCode = $('a:contains("评价")').attr('href');
    // 执行JavaScript代码
    eval(jsCode.substring(11));  // 去掉前面的"javascript:"
})();
```

eval 是 JavaScript 的一个全局函数，用于执行字符串形式的 JavaScript 代码。在某些严格的代码检查工具（如 ESLint）中，由于 eval 可能带来安全问题，所以默认是禁止使用的。

如果你确信你的代码是安全的，并且你需要使用 eval，你可以在你的代码文件的顶部添加一行注释来禁用这个规则：

```
/* eslint no-eval: "off" */
```


这行注释会告诉 ESLint 忽略 no-eval 规则，所以你可以在这个文件中使用 eval。

然而，我必须强调，eval 是非常危险的，因为它允许执行任意的 JavaScript 代码。你应该尽量避免使用 eval，除非你完全理解它的风险并且你能确保你执行的代码是

## h5视频倍速,时间加速和run-at

### **时间加速**

首先来介绍一下时间加速的原理.一般情况下,都是使用**setInterval**来做定时器,我们只要把这个定时器的时间缩短,比如之前是1s触发一次,现在变成500ms触发一次,那么就相当于时间缩短了一倍.

怎么缩短呢?我们可以劫持setInterval这个函数,传入值为1000,我们把他变为500.代码类似下面这样:
```js
let hookSetInterval=window.setInterval;//将系统提供的setInterval保存
window.setInterval=function(a,b){//将系统的setInterval替换为我们自己的
  return hookSetInterval(a,b/2);//经过处理后再调用系统的setInterval
}
```


注意:  如果使用//@grant unsafeWindow的话,window替换为unsafeWindow,

### **视频倍速**

h5的video,里面有一个播放速度的属性:playbackRate,最高为16倍.

像b站这个页面,里面只有一个视频,直接document.querySelector('video')就可以获取到了,如果有多个选择器写好也没问题.代码如下:

```js
document.querySelector('video').playbackRate=2;
```

### **RUN-AT**

![image-20231218090200599](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231218090200599.png)

**document-start**  脚本在最早的时刻被注入

**document-body**  当body元素存在时脚本被注入

**document-end**  脚本在DOMContentLoaded事件发生时或之后被注入

 **document-idle**  脚本在DOMContentLoaded事件发生后被注入. 当没有设置@run-at标签时,会采用该值作为默认值

**context-menu**  当在浏览器点击鼠标右键时,脚本被注入(只支持桌面版Chrome浏览器)  注: 当该值设置的时候, 所有的@include和@exclude声明会被忽略, 将来可能会有调整.

这里我们设置为:// @run-at document-start 希望脚本尽快的被注入,因为我们要抢在前端调用setInterval之前来替换掉setInterval函数.

### 例子

```js
// ==UserScript==
// @name         视频加速与时间加速demo
// @namespace    https://bbs.tampermonkey.net.cn/
// @version      0.1
// @description  用于:http://time.tianqi.com/的时间加速和用于bilibili的一个视频倍速:https://www.bilibili.com/video/BV1ys411p7To
// @author       王一之
// @match        http://time.tianqi.com/
// @match        https://www.bilibili.com/video/*
// @run-at       document-start
// @grant        unsafeWindow
// ==/UserScript==

let rate=4;//倍速

if(unsafeWindow.location.href.indexOf('time.tianqi.com')!=-1){
    //时间网站,用时间加速
    let hookSetInterval=unsafeWindow.setInterval;//将系统提供的setInterval保存
    unsafeWindow.setInterval=function(a,b){//将系统的setInterval替换为我们自己的
        return hookSetInterval(a,b/rate);//经过处理后再调用系统的setInterval
    }
}else{
    //bilibili用视频加速
    unsafeWindow.onload=function(){
        //在元素都加载完成后再监听video的播放时间,再进行倍速设置
        unsafeWindow.document.querySelector('video').onplay=function(){
            unsafeWindow.document.querySelector('video').playbackRate=rate;
        }
    }
}

```

## 脚本ajax的跨域请求

油猴中的ajax请求.将使用[GM_xmlhttpRequest](https://www.tampermonkey.net/documentation.php#GM_xmlhttpRequest)来绕过 `同源策略`做一个访问我们[油猴中文网](https://bbs.tampermonkey.net.cn/)就会自动关注我们的[up主](https://space.bilibili.com/1037793830)(夹杂私货手动狗头)

### AJAX

在脚本里面为什么不能直接使用 `XMLHttpRequest`去访问我们自己的api

AJAX即Asynchronous Javascript And XML,主要用于**不刷新页面**与网站后端通信.例如在b站网页上的点赞/投币/收藏,在评论区翻页,就是使用了ajax技术.

AJAX通常使用[XMLHttpRequest(XHR)](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest),但是由于此api的设计不太友好,于是又有了[Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)来解决这些问题,不过也有其它的封装让XHR的使用体验更友好,例如:axios和jQuery的ajax等.此处就不再展开.

#### 跨域

跨域即两个不同域名之间的访问.例如我在开头说的访问我们[油猴中文网](https://bbs.tampermonkey.net.cn/)就会自动关注[up主](https://space.bilibili.com/1037793830),那么肯定就需要从我们的域名https://bbs.tampermonkey.net.cn/访问到https://space.bilibili.com/1037793830哔哩哔哩的域名,这就产生了跨域访问.

#### 同源策略

如果上述可以正常访问那肯定是不合理且不安全的.假如正常访问了,只是看页面还好,万一直接投币甚至转账那是无法接受的.就比如我可以随便从我家跑到你家看东西(GET),放东西(POST),该东西(put), 丢东西(DELETE)一样.

然后就引出了[同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)对此来加以限制.

\> 如果两个 URL 的 protocol、port (如果有指定的话)和 host 都相同的话，则这两个 URL 是同源。这个方案也被称为“协议/主机/端口元组”，或者直接是 “元组”。

实际如下图所示,提示了错误.且不可以访问.

![image-20210112151930661.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300.png)

如果希望可以解决这个问题,能够让我们跨域访问,主要有 `JSONP`,[`CORS`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS),`反向代理`这三种方式.

像b站点击关注哪里就是使用的 `CORS`,因为用户页面的域名是:[space.bilibili.com](https://space.bilibili.com/1037793830),而关注api的域名是:[api.bilibili.com](https://api.bilibili.com/x/relation/modify),两个域名并不符合同源策略

<img src="%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231218110022686.png" style="zoom: 80%;" />

### 脚本的跨域访问

如果需要让脚本能够完全的访问其它的api,那么大概只有两种方法,一种是CORS,另外一种是通过油猴扩展去获得更高级的权限,让我们的脚本不受同源策略所限制.

+ CORS方法如果你调用的api不是自己写的,不能自己去增加CORS策略,那么就几乎无解,好处是对你的api安全.(不过都脚本了,哪里还管安全....)

+ 脚本一般使用 `GM_xmlhttpRequest`API,我们需要通过 `// @grant        GM_xmlhttpRequest`去申请此权限.

这个方法更详细的文档:[GM_xmlhttpRequest](https://www.tampermonkey.net/documentation.php#GM_xmlhttpRequest),看起来像XHR+jQuery的结合体.

### bilibili自动关注up主

如果想实现访问我们的论坛然后自动关注我们的up主,那么我们得先知道,bilibili关注up主的api是什么.

我们先通过f12的开发者工具,然后使用Network去查看bilibili关注up主的网络请求包是怎么样的.

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/forum-17028700686809.php)

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/forum-170287009480411.php)

主要关注Request URL:`https://api.bilibili.com/x/relation/modify`,Request Method:`POST`,Form Data.先来完成我们的脚本第一版.如果有问题再继续调整.

就像写ajax请求一样

```js
// ==UserScript==
// @name         油猴中文网-自动关注up主
// @namespace    https://bbs.tampermonkey.net.cn/
// @version      0.1
// @description  油猴中文网-自动关注up主
// @author       Wyz
// @match        https://bbs.tampermonkey.net.cn/
// @grant        GM_xmlhttpRequest
// @connect      api.bilibili.com
// ==/UserScript==

(function() {
    'use strict';

    GM_xmlhttpRequest(
        {
        url:"https://api.bilibili.com/x/relation/modify",
        method :"POST",
        data:"fid=1037793830&amp;act=1&amp;re_src=11&amp;jsonp=jsonp&amp;csrf=e37f1881fd98f16756d16ab71109d37a",
        headers: {
            "Content-type": "application/x-www-form-urlencoded"
        },
        onload:function(xhr){
            console.log(xhr.responseText);
        }
    }
    );
})();
```

执行一下,弹出了下面内容,当然点击允许啦!不过如果你不希望弹出这个内容,那么你可以在脚本中加入

 `// @connect      api.bilibili.com` 这一行来设置允许通过的域名,以进行屏蔽.    详细文档[@connect](https://www.tampermonkey.net/documentation.php#_connect)

不知道是延迟还是什么的原因,我刷新了几次之后才关注成功.

不过到此,虽然可以关注了,但是还不能算完,因为这个请求里有一个参数:`csrf`是与账号相关的,需要从cookie里面去获取,如果你直接将上面的脚本代码发给别人运行,因为对方的csrf和你的不同,那么就会输出这个内容

```
{"code":-111,"message":"csrf 校验失败","ttl":1}
```

## 脚本往页面添加新元素

详细讲 jquery

## 外部资源引用

需求 : 引入外部资源,例如jQuery,vue,和自己写的一些css样式,js脚本等.最终写一个脚本给论坛增加一个黑夜模式(背景全是黑的)

### js资源的引用

#### 方法1使用@require加载

```js
// @require      https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js
```

js代码可能会与前端冲突, 不推荐使用

#### 方法2使用脚本加载

往网页页面中加入script标签去加载js文件.需要注意的是,head标签,body标签等不同的位置中插入,js加载的时间是不同的,不过一般onload之后再执行脚本一般没问题.

注意:   脚本的 `run-at`属性,最好是 `start`,总之就是js加载顺序和脚本执行顺序,别js还没加载完你脚本就开始用js了)

```js
let script = document.createElement('script');
script.setAttribute('type', 'text/javascript');
script.src = "https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js";
document.documentElement.appendChild(script);
```

### css资源的引用

#### 方法1使用油猴来加载

```js
// @resource css https://blog.icodef.com/wp-content/themes/Kratos-3.0.7/assets/css/kratos.min.css?ver=3.2.4

console.log(GM_getResourceURL("css"),GM_getResourceText("css"));//url是一个base64的url
GM_addStyle(GM_getResourceText("css"));
```

#### 方法2使用脚本加载

```js
let script = document.createElement('link');
script.setAttribute('rel', 'stylesheet');
script.setAttribute('type', 'text/css');
script.href = "https://blog.icodef.com/wp-content/themes/Kratos-3.0.7/assets/css/kratos.min.css?ver=3.2.4";
document.documentElement.appendChild(script);
```

### 加密算法引入

```js
// ==UserScript==
// @name         使用CryptoJS和jQuery的油猴脚本示例
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  在油猴脚本中使用CryptoJS和jQuery
// @match        https://www.example.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */
    /* global CryptoJS */
    
    
    // 手动添加 CryptoJS 脚本标签
    var cryptoJSScript = document.createElement('script');
    cryptoJSScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js';
    document.getElementsByTagName('head')[0].appendChild(cryptoJSScript);

    // 手动添加 jQuery 脚本标签
    var jqueryScript = document.createElement('script');
    jqueryScript.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
    document.getElementsByTagName('head')[0].appendChild(jqueryScript);

    // 等待 CryptoJS 和 jQuery 加载完毕后执行代码
    var scriptsLoaded = 0;

    cryptoJSScript.onload = function() {
        console.log('CryptoJS 加载完成');
        scriptsLoaded++;
        executeIfReady();
    };

    jqueryScript.onload = function() {
        console.log('jQuery 加载完成');
        scriptsLoaded++;
        executeIfReady();
    };
    
    function executeIfReady() {
        if (scriptsLoaded === 2) {
            // 使用 jQuery 进行操作
            $(document).ready(function() {
                // 使用 CryptoJS 加密字符串
                var encryptedString = CryptoJS.MD5('yourStringToBeEncrypted').toString();
                console.log('加密后：' + encryptedString);
            });
        }
    }

})();
```

### 例子

```js
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest

(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */

    // 添加 Bootstrap 5 的 CSS 文件
    var bootstrapCss = document.createElement('link');
    bootstrapCss.rel = 'stylesheet';
    bootstrapCss.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css';
    document.head.appendChild(bootstrapCss);

    // 添加 Bootstrap Icons 的 CSS 文件
    var bootstrapIconCss = document.createElement('link');
    bootstrapIconCss.rel = 'stylesheet';
    bootstrapIconCss.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
    document.head.appendChild(bootstrapIconCss);
}
```

### 例子

```js
// ==UserScript==
// @name         登录
// @namespace    https://github.com/Auroraol
// @version      0.1
// @description  长春大学教务系统登录
// @author       lfj
// @match        https://cdjwc.webvpn.ccu.edu.cn/jsxsd/
// @icon
// @run-at       document-start
// @grant        unsafeWindow
// @require      https://code.jquery.com/jquery-2.1.4.min.js
// ==/UserScript==


(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */
    /* global CryptoJS */
    var user="032141226";
    var pwd="-+66..[]l";
   // 引入 CryptoJS 的代码
   var cryptoJSScript = document.createElement('script');
   cryptoJSScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js';
   document.getElementsByTagName('head')[0].appendChild(cryptoJSScript);

    // 在 CryptoJS 加载完毕后执行以下代码
    cryptoJSScript.onload = function() {
        // 这里写你的具体逻辑
         var encodedUser = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(user));
         var encodedPwd = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(pwd));
         console.log(encodedUser)
         console.log(encodedPwd)
}; 
})();
```

![image-20231218114909476](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231218114909476.png)



## 右键菜单与GM_get/setValue函数

### GM_get/set(Value)

> 官方文档:  [GM_get/setValue](https://bbs.tampermonkey.net.cn/[https%3A//www.tampermonkey.net/documentation.php#GM_setValue](https://www.tampermonkey.net/documentation.php%23GM_setValue))

这个函数可以用来保存一些配置数据,像某些脚本的配置是写在脚本代码中的,更新脚本后配置又被还原,很不方便,这时就可以改造成get/setValue函数来储存下来.   功能类似于localStorage.getItem()/setItem()

注意:  这个函数在Greasemonkey中是异步的,Tampermonkey是同步的, 在两个不同的脚本中是无法共享数据的.

**使用方法**

```js
// ==UserScript==
// @name         New Userscript2
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://bbs.tampermonkey.net.cn/
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

GM_setValue("qqq",123);
console.log(GM_getValue("qqq"));
```

### 右键菜单

run-at 除了 `document-start/body/end/idle`这些控制脚本运行时间的外,还有一个 `context-menu`的属性,  用于右键点击菜单的时候执行脚本. 

如果使用了 `context-menu`属性,那么当你在所匹配的页面上右键时,菜单中就会以你脚本名显示出一菜单项,点击之后就是执行你的脚本代码.

#### 方式1

```js
// ==UserScript==
// @name         右键菜单和valude demo
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://bbs.tampermonkey.net.cn/*
// @run-at       context-menu
// ==/UserScript==

alert("菜单被点击了");
```

![image-20231218120014492](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231218120014492.png)

#### 方式2(推荐)

除了使用 `@run-at       context-menu`生成菜单外,油猴还提供了两个函数[GM_registerMenuCommand](https://bbs.tampermonkey.net.cn/[https%3A//www.tampermonkey.net/documentation.php#GM_registerMenuCommand](https://www.tampermonkey.net/documentation.php%23GM_registerMenuCommand))和[GM_unregisterMenuCommand](https://bbs.tampermonkey.net.cn/[https%3A//www.tampermonkey.net/documentation.php#GM_unregisterMenuCommand](https://www.tampermonkey.net/documentation.php%23GM_unregisterMenuCommand)), 分别用于注册菜单和删除菜单. 更加灵活, 但是不能显示在页面上,只能到油猴图标脚本那里去进行点击.

```js
// ==UserScript==
// @name         右键菜单和valude demo
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://bbs.tampermonkey.net.cn/*
// @grant    GM_registerMenuCommand
// @grant    GM_unregisterMenuCommand
// ==/UserScript==

let id=GM_registerMenuCommand ("自定义的菜单", function(){
   alert('菜单点击');
   GM_unregisterMenuCommand(id);//删除菜单
}, "h");

// 第三个参数 accessKey 为快捷键，输入h即可触发。本脚本在点击一次之后会将菜单删除。
```

![image-20231218120428698](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231218120428698.png)

#### 例子

菜单点击计数器:  利用油猴的存储功能来保存菜单被点击的次数,然后刷新次数

```js
// ==UserScript==
// @name         右键菜单和valude demo
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://bbs.tampermonkey.net.cn/*
// @grant    GM_setValue
// @grant    GM_getValue
// @grant    GM_registerMenuCommand
// @grant    GM_unregisterMenuCommand
// ==/UserScript==

let id=GM_registerMenuCommand ("菜单第"+GM_getValue("click_num",0)+"点击",click, "h");

function click(){
   GM_unregisterMenuCommand(id);
   GM_setValue("click_num",GM_getValue("click_num",0)+1)
   id=GM_registerMenuCommand ("菜单第"+GM_getValue("click_num",0)+"点击",click, "h");
}
```

## 使用GM_addStyle去除网页广告

网站http://www.yhdm.io/

网站[http://www.imomoe.ai](http://www.imomoe.ai/)

### 第一个网站处理

首先解决[http://www.imomoe.ai](http://www.imomoe.ai/)

<img src="%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449615.png" alt="图片.png" style="zoom:67%;" />

首先我们去除一下右下角的广告, 用元素定位找到了

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449716.png)

然后在右边写上display:none发现广告消失了(display是展示的意思,none代表无)

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449717.png)

接下来视频两边的广告，可以找到

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449718.png)

设置display:none就可以了

```js
if(weburl.indexOf('www.imomoe.ai')!=-1)
{
    GM_addStyle('#HMRichBox{display:none !important}')
    GM_addStyle('#bdshare{display:none !important}')
}
```

bdshare是分享按钮，我觉得没什么用，就也给去掉了

#### #代表id

HMRichBox是名字

我们需要用一个大括号包含我们想写的内容，之间每一个规则都用;来分割，这次只有一个规则，所以也不可加

直接写上display:none就好了

!important是什么意思呢？因为原网页就有display:xxxx，不同的css规则具有不同的高低等级，important通常可以提高到最高等级

这里为了防止原网页的覆盖，所以加上了important

然后我又发现暂停的时候偶尔也会出现广告

确定class为player_pause

但是这时候出现一个问题，就是我们使用GM_addstyle是不好使的

这是为什么？

查看网页发现其实播放器是一个iframe，就是一个网页包含了另一个网页

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449719.png)

那我们应该怎么处理？

骚操作来了，油猴不仅仅会加载在当前页面，如果我们在match填入iframe的链接，也会匹配到ifame内的网页进行处理

首先我添加saas.jialingmm.net/*是不好使的

所以我直接访问了下

https://saas.jialingmm.net/code.php?type=qiyi&vid=5680af4a488b920b2e2bbba3fb8abae3,302725300&userlink=http%3A%2F%2Fwww.imomoe.ai%2Fplayer%2F209-0-0.html&adress=HeiLongJiang

#### 如何获取到这个地址

切换作用域打印**window**.**location**.**href**获取到地址

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449720.png)

#### 如何切换作用域

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449821.png)

火狐切换

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449822.png)

谷歌切换

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449823.png)

也可以通过点击iframe切换当前作用域

发现这是一个动态跳转的网页

目前的api链接是api.xiaomingming.org

所以我在match添加// @match api.xiaomingming.org/*

并且写入addstyle

这样http://www.imomoe.ai这个网页就彻底干净了

### 第二个网站处理

[http://www.yhdm.io](http://www.yhdm.io/)

右下角的问题相信大家已经知道怎么处理了(为什么都叫樱花动漫，但是域名不同，广告id都相同)

我们继续谈谈视频内的暂停广告

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449824.png)

这里依然使用了iframe

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288385449825.png)

我们访问这个链接依然是http://tup.yhdm.io

所以直接跟上一个网站同理设置就好了

最后附上脚本代码

```js
// ==UserScript==
// @name         【油猴中文网bbs.tampermonkey.net.cn】樱花去右下角广告以及弹窗
// @namespace    http://www.yhdm.io/
// @version      0.1
// @description  去除樱花动漫网广告，来源油猴中文网，bbs.tampermonkey.net.cn
// @author       【李恒道】来源油猴中文网，bbs.tampermonkey.net.cn
// @match        http://tup.yhdm.io/*
// @match        http://www.yhdm.io/*
// @match        http://www.imomoe.ai/*
// @match        api.xiaomingming.org/*
// @grant       GM_addStyle
// @grant       unsafeWindow
// @supportURL   https://bbs.tampermonkey.net.cn/forum.php?mod=viewthread&tid=270
// @homepage     https://bbs.tampermonkey.net.cn/forum.php?mod=viewthread&tid=270
// ==/UserScript==
let weburl=unsafeWindow.location.href
    if(weburl.indexOf('api.xiaomingming.org')!=-1)
    {
    GM_addStyle('#player_pause{display:none !important}')
    }
    if(weburl.indexOf('tup.yhdm.io')!=-1)
    {
    GM_addStyle('#img-random-hm1{display:none !important}')
    }
if(weburl.indexOf('www.yhdm.io')!=-1)
{
         GM_addStyle('#HMRichBox{display:none !important}')
        GM_addStyle('#bdshare{display:none !important}')
    }

if(weburl.indexOf('www.imomoe.ai')!=-1)
{
        GM_addStyle('#HMRichBox{display:none !important}')
        GM_addStyle('#bdshare{display:none !important}')
    }
```

## 油猴hook - 实现b站评论小尾巴

### hook

可以描述成 `劫持`,让实际调用的方法变成我们的方法,这时候就可以对它为所欲为了,可以选择不调用它走自己的逻辑,或者处理一下它的参数再进行调用等等.   类似中间件

### 全局函数

像之前时间加速中的 `setInterval`,当时我们的方法就是下面这样,很简单.在我们上述提供的demo网站中,因为globalFunc也是全局中,那么也可以直接像下面这样hook它.

```js
let hookSetInterval=window.setInterval;//将系统提供的setInterval保存
window.setInterval=function(a,b){//将系统的setInterval替换为我们自己的
  return hookSetInterval(a,b/2);//经过处理后再调用系统的setInterval
}
```

### 全局对象中的方法

常用的hook `setInterval`加速时间外,我们还会hook `XMLHttpRequest`,这是一个全局对象,用于处理网页请求(例如广告的),获取网页数据,可以就利用此思路去实现哔哩哔哩评论小尾巴.

在我们的demo中,定义了 `globalObject`的全局对象,然后 `let obj = new globalObject()`实例化它,使用 `obj.func`调用它.那么我们怎么hook呢?像下面这样,我们直接替换掉对象,然后经过我们的对象实例化后,再进行替换.相比于上面的函数,也很好理解,往里面进入了一层嘛.

```js
let hookGlobalObject=window.globalObject;
window.globalObject=function(){
    let ret=new hookGlobalObject();
    let hookFunc=ret.func;
    ret.func=function(p){
        return hookFunc("hook"+p);
    }
    return ret;
}
```

### 原型链上的方法

\> 原型链是什么,请阅读此内容:https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Inheritance_and_the_prototype_chain 我就不现丑了

与上面对象中的方法不同,原型链上的方法不需要等它调用了之后再继续找对应的对象,直接修改原型链上的方法就可以了.

```js
let hookPrototypeFunc=hookGlobalObject.prototype.prototypeFunc;
hookGlobalObject.prototype.prototypeFunc = function (p) {
    hookPrototypeFunc("hook"+p);
}
```

### 使用到了this的方法

如果调用的方法使用到了this,可以看demo中的 `thisFunc`,其实与hook对象中的方法一样,只是调用的时候使用apply或者call,让对象里的this指向我们期望的this,否则会影响结果,就像下图.对于this我打算在下一节中讲,会涉及到一些作用域的内容.

![image-20210325151205647.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288504238737.png)

apply和call的区别在于,apply传递参数是用的数组,call传递参数使用多个参数,就像下面这样:

```js
func.apply(this,[arg1,arg2]);
func.call(this,arg1,arg2);
```

hook代码:

```js
let hookGlobalObject=window.globalObject;
window.globalObject=function(){
    let ret=new hookGlobalObject();
    let hookThisFunc=ret.thisFunc;
    // hook对象中的方法
    ret.thisFunc=function(p){
        return hookThisFunc.apply(this,["hook"+p]);
    }
    return ret;
}
```

### 匿名函数

如果是匿名的函数,我们将很难处理,局限性也更大,匿名函数如果直接使用变量,因为作用域的原因,我们根本无法访问到.例如在demo中,实现了一个匿名函数,但是如果想hook达到我们的修改的话几乎没有办法.而且对hook的匿名函数来说,很多时候还要复制粘贴他原本的源码去修改来达到目的,如果源码一大串几乎可以放弃了.

```js
let hookAnonymous=window.anonymous;
// hook匿名
let i = 0;
setInterval(() =&gt; {
    i++;
}, 1000);
window.anonymous=function(anonymous){
    return hookAnonymous(function () {
        document.querySelector('#object-anonymous').innerHTML = "hook第" + i + "次";
    });
}
```

可以看到...现在我们是将这个匿名函数直接另外起了一个计时器和复制粘贴了代码,修改达到的目的.

### 一些不能hook的方法

一般来说,能hook的方法,应该满足他能访问到的对象,我们也能够访问得到,我们脚本能访问到的对象应该全在 `window`这个全局的变量上,所以上述例子都是以全局为基准的.另外对于匿名的方法或者离 `window`对象的距离越远,那么hook的成本将越大,这时候就应该切换其它的思路了.就像上方的,我们可以hook掉 `document.querySelector`,在判断参数为 `'#object-anonymous'`时,innerHTML变为其它的.也就是从其它我们能hook到的对象来入手,或者使用其它方法.

### Bilibili评论小尾巴

\> 文档:https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest

本节来使用hook xhr这个方法来实现小尾巴,这个方法是毕竟容易想到的,因为如果你要发评论,就肯定会发请求,如果发请求又不刷新页面的话,大部分都是 `XMLHttpRequest`,当然还有 `fetch`这个标准.

我们直接hook掉 `XMLHttpRequest`,在发送的数据后面添加小尾巴.

我们先抓下包,判断这个评论的数据包是怎么样的.红框处就是调用这个请求的js代码,我们点进去就可以判断是fetch还是xhr了,如果根据调用栈继续往上找还能看到数据是怎么来的,这个我们到下一节讲.

![image-20210325161502330.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288504238838.png)

然后看一些post的数据:

![image-20210325161650696.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170288504238839.png)

这时候我们就可以hook掉xhr原型链上的send方法,每次send时判断是否有message这个参数,有我们就对message的内容进行替换.当然message这个参数,万一其它post也有,我们也可以hook xhr这个对象,判断url,这里我就按简单的来了.

```js
let tail="\n----臭水沟捞的奔腾机";

let hookXhrSend=XMLHttpRequest.prototype.send
XMLHttpRequest.prototype.send=function(body){
    console.log(body);
    if(/&amp;message=(.*?)&amp;/.test(body)){
        //替换body内容
        body=body.replace(/&amp;message=(.*?)&amp;/,"&amp;message=$1"+encodeURIComponent(tail)+"&amp;");
    }
    hookXhrSend.apply(this,[body]);
}
```

当然这种方法还是不够优雅,下一节我们继续优化.

哔哩哔哩小尾巴
https://bbs.tampermonkey.net.cn/thread-431-1-1.html
(出处: 油猴中文网)

hook demo
https://bbs.tampermonkey.net.cn/thread-430-1-1.html
(出处: 油猴中文网)

# 劫持

## XMLHttpRequest

[XMLHttpRequest - Web API 接口参考 | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest#属性)

## Proxy劫持

> 使用Proxy 的方式来劫持 XMLHttpRequest 返回内容

重写 XMLHttpRequest 对象的方式来劫持和修改返回内容油猴脚本示例：

Proxy的使用见:  vue文件夹里的笔记

建议直接使用开源项目:  [轻松拦截和修改XHR(“AJAX”)请求和响应](https://github.com/jpillora/xhook)

<img src="%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220115149031.png" alt="image-20231220115149031" style="zoom:67%;" />

### 对象的数据劫

`Object.defineProperty()` 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。

栗子，这个函数相当于在访问对象内的属性的时候进行了一层过滤，可以篡改读取到的数据以及设置的数据

```js
const object1 = {};//创建一个object1

Object.defineProperty(object1, 'property1', {
  value: 42,      //设置object1的属性property1，值为42，不可写
  writable: false
});

object1.property1 = 77;  //再设置object1的property1属性为77
// throws an error in strict mode

console.log(object1.property1); // expected output: 42
```

不仅仅可以设置为对象，也可以设置set和get来控制读取和写入

```js
Object.defineProperty(对象, '属性', {
    get: function() {
         //获取的数据
    },
    set: function(str) {
         //设置的数据
    },
});
```

#### 对象进行劫持

###  Proxy的使用

#### **通用**

1、Proxy可以包装任何形式的对象：包括原生数组，函数，甚至另一个代理。
2、代理实例中没有指定的handler,实际就是操作原对象target

```js
let target = function(){return 'ddd'}
let proxy = new Proxy(target, {});
proxy.prototype.age = 12
console.log(proxy.prototype === target.prototype) // true
```

**本文参考的是MDN文档**https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy

Proxy对象用于创建一个对象的代理，从而实现基本操作的拦截和自定义（如属性查找、赋值、枚举、函数调用等）。

**如果说数据劫持是对对象中某个属性进行了劫持，那Proxy可以理解为对一个对象进行劫持。**

#### **语法以及参数**

```js
const p = new Proxy(target, handler)
```

`target`**要使用** `Proxy` **包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。**

`handler`**一个通常以函数作为属性的对象，各属性中的函数分别定义了在执行各种操作时代理 p 的行为。**

#### **handler的方法**

##### handler.getPrototypeOf()

**当读取代理对象的原型时，使用该函数进行劫持。**

```js
const handler = {
  getPrototypeOf(target) {
    return {name:'8888'};
  }
};

const proxy1 = new Proxy(obj, handler);
```

##### handler.setPrototypeOf()

**当设置代理对象的原型时，使用该函数进行劫持，如果不想设置一个新的原型，可以返回false**

```js
var handlerReturnsFalse = {
    setPrototypeOf(target, newProto) {
        return false;
    }
};

var newProto = {}, target = {};

var p1 = new Proxy(target, handlerReturnsFalse);
Object.setPrototypeOf(p1, newProto); // throws a TypeError
Reflect.setPrototypeOf(p1, newProto); // returns false
```

##### **handler.preventExtensions()**

**Object.preventExtensions 是让对象变得不可拓展的函数，当设置不可拓展时，会触发handler.preventExtensions**

**注意，如果对象是可拓展的，那么只能返回false**

```
var p = new Proxy({}, {
  preventExtensions: function(target) {
    console.log('called');
    Object.preventExtensions(target);
    return true;
  }
});

console.log(Object.preventExtensions(p)); // "called"
                                          // false
```

##### **handler.isExtensible()**

**该方法用于拦截Object.isExtensible()。，而Object.isExtensible用于判断对象是否是一个可拓展的对象**

**注意，该函数返回必须为true**

```
var p = new Proxy({}, {
  isExtensible: function(target) {
    console.log('called');
    return true;//也可以return 1;等表示为true的值
  }
});

console.log(Object.isExtensible(p)); // "called"
                                     // true
```

##### **handler.getOwnPropertyDescriptor()**

**handler.getOwnPropertyDescriptor()方法是 Object.getOwnPropertyDescriptor()的钩子。**

**该方法用于拦截Object.getOwnPropertyDescriptor(),Object.getOwnPropertyDescriptor获取对象自有属性的描述符，自有属性指直接赋予对象的属性，而且原型链中的属性**

```
getOwnPropertyDescriptor 必须返回一个 object 或 undefined。
如果属性作为目标对象的不可配置的属性存在，则该属性无法报告为不存在。
如果属性作为目标对象的属性存在，并且目标对象不可扩展，则该属性无法报告为不存在。
如果属性不存在作为目标对象的属性，并且目标对象不可扩展，则不能将其报告为存在。
属性不能被报告为不可配置，如果它不作为目标对象的自身属性存在，或者作为目标对象的可配置的属性存在。
Object.getOwnPropertyDescriptor（target）的结果可以使用 Object.defineProperty 应用于目标对象，也不会抛出异常。
var p = new Proxy({ a: 20}, {
  getOwnPropertyDescriptor: function(target, prop) {
    console.log('called: ' + prop);
    return { configurable: true, enumerable: true, value: 10 };
  }
});

console.log(Object.getOwnPropertyDescriptor(p, 'a').value); // "called: a"
                                                            // 10
```

**configurable**

**当且仅当该属性的** `configurable` **键值为** `true` **时，该属性的描述符才能够被改变，同时该属性也能从对应的对象上被删除。\****
***\***默认为***\*** ***\*`false`\****。**

**enumerable**

**当且仅当该属性的** `enumerable` **键值为** `true` **时，该属性才会出现在对象的枚举属性中。\****
***\***默认为 **`false`\****。**

**以下代码则违反了规则。**

```
var obj = { a: 10 };
Object.preventExtensions(obj);
var p = new Proxy(obj, {
  getOwnPropertyDescriptor: function(target, prop) {
    return undefined;
  }
});

Object.getOwnPropertyDescriptor(p, 'a'); // TypeError is thrown
```

##### handler.defineProperty

```
var p = new Proxy({}, {
  defineProperty: function(target, prop, descriptor) {
    console.log('called: ' + prop);
    return true;
  }
});

var desc = { configurable: true, enumerable: true, value: 10 };
Object.defineProperty(p, 'a', desc); // "called: a"
```

**handler.has()**

**in操作符的捕捉器。**

**如果指定的属性在指定的对象或其原型链中，则\****`in` **运算符\**\****返回**`true`**。**

```
const handler1 = {
  has(target, key) {
    if (key[0] === '_') {
      return false;
    }
    return key in target;
  }
};

const monster1 = {
  _secret: 'easily scared',
  eyeCount: 4
};

const proxy1 = new Proxy(monster1, handler1);
console.log('eyeCount' in proxy1);
// expected output: true

console.log('_secret' in proxy1);
// expected output: false

console.log('_secret' in monster1);
// expected output: true
```

**handler.get()**

**属性读取操作的捕捉器。get的意思与Object.defineProperty 中的get一致**

**需要注意的是**

```
如果要访问的目标属性是不可写以及不可配置的，则返回的值必须与该目标属性的值相同。
如果要访问的目标属性没有配置访问方法，即get方法是undefined的，则返回值必须为undefined。
var p = new Proxy({}, {
  get: function(target, prop, receiver) {
    console.log("called: " + prop);
    return 10;
  }
});

console.log(p.a); // "called: a"
                  // 10
```

**handler.set()**

**属性设置操作的捕捉器。set的意思与Object.defineProperty 中的set一致**

```
const monster1 = { eyeCount: 4 };

const handler1 = {
  set(obj, prop, value) {
    if ((prop === 'eyeCount') && ((value % 2) !== 0)) {
      console.log('Monsters must have an even number of eyes');
    } else {
      return Reflect.set(...arguments);
    }
  }
};

const proxy1 = new Proxy(monster1, handler1);

proxy1.eyeCount = 1;
// expected output: "Monsters must have an even number of eyes"

console.log(proxy1.eyeCount);
// expected output: 4

proxy1.eyeCount = 2;
console.log(proxy1.eyeCount);
// expected output: 2
```

**handler.deleteProperty()**

**delete操作符的捕捉器。**

***\***`delete` **操作符\**\****用于删除对象的某个属性；如果没有指向这个属性的引用，那它最终会被释放。**

**如果目标对象的属性是不可配置的，那么该属性不能被删除。**

```
var p = new Proxy({}, {
  deleteProperty: function(target, prop) {
    console.log('called: ' + prop);
    return true;
  }
});

delete p.a; // "called: a"
```

**handler.ownKeys()**

**Object.getOwnPropertyNames方法和 Object.getOwnPropertySymbols方法的捕捉器。**

**`Object.getOwnPropertyNames()`\****方法返回一个由指定对象的所有自身属性的属性名（包括不可枚举属性但不包括Symbol值作为名称的属性）组成的数组。**

```
var arr = ["a", "b", "c"];
console.log(Object.getOwnPropertyNames(arr).sort()); // ["0", "1", "2", "length"]

// 类数组对象
var obj = { 0: "a", 1: "b", 2: "c"};
console.log(Object.getOwnPropertyNames(obj).sort()); // ["0", "1", "2"]
```

`Object.getOwnPropertySymbols()` **方法返回一个给定对象自身的所有 Symbol 属性的数组。(常规开发涉及较少，这里就不做讲解了)**

**约束**

```
ownKeys 的结果必须是一个数组.
数组的元素类型要么是一个 String ，要么是一个 Symbol.
结果列表必须包含目标对象的所有不可配置（non-configurable ）、自有（own）属性的key.
如果目标对象不可扩展，那么结果列表必须包含目标对象的所有自有（own）属性的key，不能有其它值.
var p = new Proxy({}, {
  ownKeys: function(target) {
    console.log('called');
    return ['a', 'b', 'c'];
  }
});

console.log(Object.getOwnPropertyNames(p)); // "called"
                                            // [ 'a', 'b', 'c' ]
var obj = {};
Object.defineProperty(obj, 'a', {
  configurable: false,
  enumerable: true,
  value: 10 }
);

var p = new Proxy(obj, {
  ownKeys: function(target) {
    return [123, 12.5, true, false, undefined, null, {}, []];
  }
});

console.log(Object.getOwnPropertyNames(p));

// TypeError: proxy [[OwnPropertyKeys]] 必须返回一个数组
// 数组元素类型只能是String或Symbol
```

**handler.apply()**

**函数调用操作的捕捉器。**

**`handler.apply`\**** 方法用于拦截函数的调用。**

```
var p = new Proxy(function() {}, {
  apply: function(target, thisArg, argumentsList) {
    console.log('called: ' + argumentsList.join(', '));
    return argumentsList[0] + argumentsList[1] + argumentsList[2];
  }
});

console.log(p(1, 2, 3)); // "called: 1, 2, 3"
                         // 6
```

**handler.construct()**

**new操作符的捕捉器。**

`handler.construct()` **方法用于拦截new 操作符. 为了使new操作符在生成的Proxy对象上生效，用于初始化代理的目标对象自身必须具有[[Construct]]内部方法（即** `new target` **必须是有效的）。**

**注意，必须返回一个对象**

```
var p = new Proxy(function() {}, {
  construct: function(target, argumentsList, newTarget) {
    console.log('called: ' + argumentsList.join(', '));
    return { value: argumentsList[0] * 10 };
  }
});

console.log(new p(1).value); // "called: 1"
                             // 10
```

**下面的代码违反了约定.**

```
var p = new Proxy(function() {}, {
  construct: function(target, argumentsList, newTarget) {
    return 1;
  }
});

new p(); // TypeError is thrown
```

**下面的代码未能正确的初始化Proxy。Proxy初始化时，传给它的**`target` **必须具有一个有效的constructor供**`new`**操作符调用。**

```
var p = new Proxy({}, {
  construct: function(target, argumentsList, newTarget) {
    return {};
  }
});

new p(); // TypeError is thrown, "p" is not a constructor
```

#### **结语**

**那么到这里你已经了解Proxy的handle函数以及操作方法，如果有不明白的可以先放一放，了解如何使用就可以了，以后在使用的过程中可以慢慢查阅。**

### Reflect的使用

**Reflect与Proxy都同时在ES2015标准中，他是一个内置的对象，提供一些方法，这些方法与Proxy 的Handler中是相同的，他不是一个函数的对象，因此是不可构造的，我们只可以使用他的静态方法**

#### **为什么存在Reflect？**

**通常我们将它与Proxy进行联合使用，在进行劫持后调用原方法，那为什么不直接操作对象呢？**

**这点我查阅了资料，认为存在两个原因**

**一是目前暴露了一些核心的api供我们调用，但是未来可能隐藏掉这些api，通过Reflect才能调用。**

**二是统一操作的过程，如果我们不使用Reflect提供的函数，而使用操作的函数进行对象操作，那有一部分对象操作失败会报出异常，有一部分会报出null等等，返回值并不统一，而Reflect相对统一，比如曾经错误会报出异常的函数，在Reflect内会返回false，使用Reflect我们可以对各种函数有一个更统一的返回值以及处理。**

#### **Reflect的函数有哪些？**

```
### **Reflect.apply(target, thisArgument, argumentsList)**

**对一个函数进行调用操作，同时可以传入一个数组作为调用参数。和 Function.prototype.apply() 功能类似。**

### **Reflect.construct(target, argumentsList[, newTarget])**

**对构造函数进行 new 操作，相当于执行 new target(...args)。**

### **Reflect.defineProperty(target, propertyKey, attributes)**

**和 Object.defineProperty() 类似。如果设置成功就会返回 true**

### **Reflect.deleteProperty(target, propertyKey)**

**作为函数的delete操作符，相当于执行 delete target[name]。**

### **Reflect.get(target, propertyKey[, receiver])**

**获取对象身上某个属性的值，类似于 target[name]。**

### **Reflect.getOwnPropertyDescriptor(target, propertyKey)**

**类似于 Object.getOwnPropertyDescriptor()。如果对象中存在该属性，则返回对应的属性描述符, 否则返回 undefined.**

### **Reflect.getPrototypeOf(target)**

**类似于 Object.getPrototypeOf()。**

### **Reflect.has(target, propertyKey)**

**判断一个对象是否存在某个属性，和 in 运算符 的功能完全相同。**

### **Reflect.isExtensible(target)**

**类似于 Object.isExtensible().**

### **Reflect.ownKeys(target)**

**返回一个包含所有自身属性（不包含继承属性）的数组。(类似于 Object.keys(), 但不会受enumerable影响).**

### **Reflect.preventExtensions(target)**

**类似于 Object.preventExtensions()。返回一个Boolean。**

### **Reflect.set(target, propertyKey, value[, receiver])**

**将值分配给属性的函数。返回一个Boolean，如果更新成功，则返回true。**

### **Reflect.setPrototypeOf(target, prototype)**

**设置对象原型的函数. 返回一个 Boolean， 如果更新成功，则返回true。
```

## addEventListener劫持:crossed_swords:

> 重写 XMLHttpRequest 对象的方式来劫持和修改返回内容

通过addEventListener绑定xhr进行事件监听, 重写原XMLHttpRequest

### XHR劫持代码原理解释

```js
function addXMLRequestCallback(callback){
    //是一个劫持的函数
    var oldSend, i;
    if( XMLHttpRequest.callbacks ) {
      //判断XMLHttpRequest对象下是否存在回调列表，存在就push一个回调的函数
        // we've already overridden send() so just add the callback
        XMLHttpRequest.callbacks.push( callback );
    } else {
        // create a callback queue
        XMLHttpRequest.callbacks = [callback];
        //如果不存在则在xmlhttprequest函数下创建一个回调列表
        // store the native send()
        oldSend = XMLHttpRequest.prototype.send;
        //获取旧xml的send函数，并对其进行劫持
        // override the native send()
        XMLHttpRequest.prototype.send = function(){
            // process the callback queue
            // the xhr instance is passed into each callback but seems pretty useless
            // you can't tell what its destination is or call abort() without an error
            // so only really good for logging that a request has happened
            // I could be wrong, I hope so...
            // EDIT: I suppose you could override the onreadystatechange handler though
            for( i = 0; i < XMLHttpRequest.callbacks.length; i++ ) {
                XMLHttpRequest.callbacks[i]( this );
            }
            //循环回调xml内的回调函数
            // call the native send()
            oldSend.apply(this, arguments);
           //由于我们获取了send函数的引用，并且复写了send函数，这样我们在调用原send的函数的时候，需要对其传入引用，而arguments是传入的参数
        }
    }
}

// e.g.
addXMLRequestCallback( function( xhr ) {
        //调用劫持函数，填入一个function的回调函数
        //回调函数监听了对xhr调用了监听load状态，并且在触发的时候再次调用一个function，进行一些数据的劫持以及修改
        xhr.addEventListener("load", function(){
        if ( xhr.readyState == 4 && xhr.status == 200 ) {
            console.log( xhr.responseURL );
        }
    });

});
```

### 例子:  XHR劫持是以csdn搜索页面

```js
      // ==UserScript==
      // @name         xhr
      // @namespace    http://tampermonkey.net/
      // @version      0.1
      // @description  try to take over the world!
      // @author       lfj_learn
      // @match        http://*/*
      // @match        https://www.baidu.com/
      // @match        https://so.csdn.net/*/*
      // @grant        none
      // ==/UserScript==
 
      (function () {
        "use strict";
 
        //劫持函数
        function addXMLRequestCallback(callback) {
          // oldSend 旧函数 i 循环
          var oldSend, i;
          //判断是否有callbacks变量
          if (XMLHttpRequest.callbacks) {
            //判断XMLHttpRequest对象下是否存在回调列表，存在就push一个回调的函数
            XMLHttpRequest.callbacks.push(callback);
          } else {
            //如果不存在则在xmlhttprequest函数下创建一个回调列表/callback数组
            XMLHttpRequest.callbacks = [callback];
            // 保存 XMLHttpRequest 的send函数
            oldSend = XMLHttpRequest.prototype.send;
            //获取旧xml的send函数，并对其进行劫持（替换）  function()则为替换的函数
            //以下function函数是一个替换的例子
            XMLHttpRequest.prototype.send = function () {
              // 把callback列表上的所有函数取出来
              for (i = 0; i < XMLHttpRequest.callbacks.length; i++) {
                // 把this传入进去
                XMLHttpRequest.callbacks[i](this);
              }
              //循环回调xml内的回调函数
              // 调用旧的send函数 并传入this 和 参数
              oldSend.apply(this, arguments);
              //由于我们获取了send函数的引用，并且复写了send函数，这样我们在调用原send的函数的时候，需要对其传入引用，而arguments是传入的参数
            };
          }
        }
 
        // e.g.
        //传入回调 接收xhr变量
        addXMLRequestCallback(function (xhr) {
          //调用劫持函数，填入一个function的回调函数
          //回调函数监听了对xhr调用了监听load状态，并且在触发的时候再次调用一个function，进行一些数据的劫持以及修改
          xhr.addEventListener("load", function () {
            // 输入xhr所有相关信息
            console.log(xhr);
            if (xhr.readyState == 4 && xhr.status == 200) {
              //  如果xhr请求成功 则返回请求路径
              console.log("函数1", xhr.responseURL);
            }
          });
        });
 
        // Your code here...
      })();
```

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/7160616224f96ab05e1cfd9823f7f4c8.png)

###  例子:  劫持网页原本发出的请求，替换成自定义数据

开放API-接口文档用来测试的 : [Swagger UI (apiopen.top)](https://api.apiopen.top/swagger/index.html#/开放接口/get_api_sentences)

![image-20231220112721180](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220112721180.png)

```js
// ==UserScript==
// @name         xhr拦截
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       lfj_learn
// @match        http://*/*
// @match        https://www.baidu.com/
// @match        https://so.csdn.net/*/*
// @grant        none
// ==/UserScript==
 
(function() {
    'use strict';
 
    function addXMLRequestCallback(callback){
        //debugger;
        //是一个劫持的函数
        // oldSend 旧函数 i 循环
        var oldSend, i;
        //判断是否有callbacks变量
        if( XMLHttpRequest.callbacks ) {
            //判断XMLHttpRequest对象下是否存在回调列表，存在就push一个回调的函数
            XMLHttpRequest.callbacks.push( callback );
        } else {
            //如果没有则创建一个callback数组  //如果不存在则在xmlhttprequest函数下创建一个回调列表
            XMLHttpRequest.callbacks = [callback];
            // 保存 XMLHttpRequest 的send函数
            oldSend = XMLHttpRequest.prototype.send;
 
            //获取旧xml的send函数，并对其进行劫持（替换）  function()则为替换的函数
            XMLHttpRequest.prototype.send = function(){
 
                // 这里进行一些对自己数据的操作
                
                // 发送请求
                fetch("https://api.apiopen.top/api/sentences")
                    .then(response=> response.json())
                    .then(result =>{

                    //获取被替换的dom
                    const dom = document.getElementsByClassName("main-lt")[0];
                    dom.innerHTML = result.result.name

                })
                
                //循环回调xml内的回调函数
                // 调用旧的send函数 并传入this 和 参数
                oldSend.apply(this, arguments);
                //oldSend.apply(1);
                //由于我们获取了send函数的引用，并且复写了send函数，这样我们在调用原send的函数的时候，需要对其传入引用，而arguments是传入的参数
            }
        }
    }
 
    // e.g.
    //传入回调 接收xhr变量
    addXMLRequestCallback( function( xhr ) {
        //调用劫持函数，填入一个function的回调函数
        //回调函数监听了对xhr调用了监听load状态，并且在触发的时候再次调用一个function，进行一些数据的劫持以及修改
        //对xhr进行事件监听 判断是load 再回调function函数
        xhr.addEventListener("load", function(){
            console.log(xhr)
            if ( xhr.readyState == 4 && xhr.status == 200 ) {
                // 输入当前的路径
                console.log( '函数1',xhr.responseURL );
            }
        });
 
    });
 
 
    // Your code here...
})();
```

![image-20231220112747596](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220112747596.png)

## Fetch劫持 TODO











# 基本油猴编程的一些常见误区

### 找不到元素的问题

一般可能有两个因素，一个是存在ifame，另外一个问题可能是页面加载的问题

### 页面加载与元素

页面加载不等于元素已经出现，我们通常在f12控制台调试和查看的是现有的页面，并不代表页面加载完毕后就一定具备这个元素

尽管很多页面会在加载的时候就出现所有元素, 但是也有很多页面，会在渲染完毕后，再根据xhr请求数据等方式，再在页面上绘制新的数据，这个时候如果我们在页面加载完毕和获取数据绘制之间进行获取元素,是获取不到的。

解决方法也很简单，这里我提供两个常见的方法:

1. 使用Setinterval来进行循环判断，当获取元素不为空的时候继续执行，但需要注意不要创建过多的定时器，以及不使用的时候可以考虑销毁定时器 https://www.runoob.com/jsref/met-win-setinterval.html

2. 通过DOM插入监控来判断

在bilibili的例子中我们已经搞过了，通过上层已经存在的元素对其进行dom监听，然后再插入的时候会触发这个函数，来进行一些操作

但是需要注意把握好下层元素的数量问题，如果绘制元素过多反复触发，会极大的延迟运行速度

```js
let ops=document.querySelector('#arc_toolbar_report .ops');
//插入三连之后好像会重新生成,不添加就不会重新生成,暂时没弄清什么情况,先这样处理了.
//主要作用是监听ops的DOMNodeInserted事件,等它修改完成之后再插入我们的三连按钮,另外注意run-at是document-end,要等待ops生成之后再监听,不然query返回null会报错
//这个事件会多次调用,但是我们insertBefore插入如果元素存在,只是修改而不会新增
ops.addEventListener("DOMNodeInserted", function(event) {
    let share=document.querySelector('.share');
    share.parentElement.insertBefore(triple,share);
});
```

### iframe问题

可以参考https://music.163.com/#

我们可以获取到iframe元素后通过conetentWindow进入iframe的作用域来执行相应的函数

document.querySelector('#g_iframe').contentWindow.document.querySelector

在我的印象里好像是contentWindow内的document通常同域下才可以使用，而非同域是没有办法的

如果没法调用contentWindow下的document我们也有其他办法的

相信你一定想到了樱花动漫那一节课吧？

通过match匹配让脚本运行在iframe内就好了！

https://bbs.tampermonkey.net.cn/thread-274-1-1.html

### queryselect的临时

很多人都说document.queryselect的时候经常不知道怎么找元素

我这里列几个例子

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170296071181043.png)

以这个小iframe拿捏，我们可以根据id来获取

document.querySelector('#g_iframe')

也可以感觉除了id和class的其他属性来获取，比如name='contentFrame'

像这种除了id和class的其他属性，可以加上中括号和等于来进行判断

document.querySelector('[name="contentFrame"]')

另外queryslector是按层级匹配，但是不需要把每层都写上，即使隔层也可以匹配到的

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170296071181144.png)

这里我们想获取updn

document.querySelector('.g-btmbar .updn')

就可以了，不需要填写btmbar和updn中间那层元素

html中的标签也可以作为queryselect的搜索因素的

比如

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170296071181145.png)

网页只有这一个iframe标签，那我们可以直接

document.querySelector('iframe')

来获取

如果存在大量的相同的class元素，并且没什么特征怎么办？

通过queryselectorall获取全部匹配的元素，然后通过for循环，根据每个元素的特征来判断是否是我们需要的元素，这个在百度去广告那节

我们有进行讨论过

https://bbs.tampermonkey.net.cn/thread-688-1-1.html

### 关于脚本作用域问题

一旦你开启了沙盒模式，你的沙盒中的函数与网页的函数是隔离的

如果你再写代码的过程中网页与沙盒之间产生了一些函数的交互或者调用，一定要注意这个问题

这时候可以考虑在沙盒对网页的元素进行监控或者挂载一些实践





```js

```

例子

```js
<html>
  <head>
    <style>
      #result {
        width: 200px;
        height: 100px;
        border: 1px solid #90b;
      }
    </style>
    <script type="text/javascript">
      let xmlhttp;
      function loadXMLDoc() {
  let xmlhttp = new XMLHttpRequest();
  xmlhttp.open("GET", 'http://127.0.0.1:8000/server');
  xmlhttp.send();
  xmlhttp.onreadystatechange = () => {
    if (xmlhttp.readyState == 4) {
      if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
        document.getElementById("A1").innerHTML = xmlhttp.status;
        document.getElementById("A2").innerHTML = xmlhttp.statusText;
        document.getElementById("result").innerHTML = xmlhttp.responseText;
      } else {
        alert("Problem retrieving XML data:" + xmlhttp.statusText);
      }
    }
  };
}
    </script>
  </head>

  <body>
    <p>
      <b>状态码:</b>
      <span id="A1"></span>
    </p>

    <p>
      <b>状态文本:</b>
      <span id="A2"></span>
    </p>

    <p><b>响应结果:</b></p>
    <div id="result"></div>
    <button onclick="loadXMLDoc()">点击发送请求</button>
  </body>
</html>

```

```js
// 1、引入express
const express = require('express');
// import express from 'express';

// 2、创建应用对象
const app = express();

// 3、创建路由规则
// request 请求报文的封装
// response 响应报文的封装
app.get('/server', (request, response) => {
    // 设置响应头，设置允许跨域
    response.setHeader('Access-Control-Allow-Origin', '*');
    // 设置响应体
    response.send('Hello 金刀');
});

// 4、监听端口启动服务
app.listen(8000, () => {
    console.log("服务已经启动，8000 端口监听中...");
});
```

脚本

```js
// ==UserScript==
// @name         XHR劫持返回内容例子
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       lfj_learn
// @match        http://127.0.0.1:5501/test.html
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 保存原始的 XMLHttpRequest 对象
    var originalXHR = window.XMLHttpRequest;

    // 创建新的 XMLHttpRequest 对象
    window.XMLHttpRequest = function() {
        var xhr = new originalXHR();

        // 使用 Proxy 对象拦截 XMLHttpRequest 的属性访问和方法调用
        var xhrProxy = new Proxy(xhr, {
            get: function(target, prop, receiver) {
                if (prop === 'responseText' && target.responseURL === 'http://127.0.0.1:8000/server') {  // 要劫持的请求地址
                    // 修改返回内容
                    return 'hello jindao';
                }
                return Reflect.get(target, prop, receiver);
            }
        });

        return xhrProxy;
    };
})();
```



### 基本使用

[什么是xhr XMLHttpRequest的基本使用及](https://blog.csdn.net/Vest_er/article/details/127397828)

原生方式 发送AJAX请求

```js
// ==UserScript==
// @name         XHR劫持返回内容例子
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       lfj_learn
// @match        http://127.0.0.1:5501/test.html
// @grant        none
// ==/UserScript==

var oldxhr=window.XMLHttpRequest  //将系统提供的XMLHttpRequest保存
function newobj(){}

window.XMLHttpRequest = function(){  //将系统的XMLHttpRequest替换为自己的
    let tagetobk = new newobj();
    tagetobk.oldxhr = oldxhr;  //经过处理后再调用系统的XMLHttpRequest

    let handle={
        // 拦截是获取属性值
        get(target, prop, receiver) {

            if(prop==='oldxhr'){
                return Reflect.get(target,prop);
            }
            if(typeof Reflect.get(target.oldxhr,prop)==='function')
            {
                if(Reflect.get(target.oldxhr,prop+'proxy')===undefined)
                {
                    target.oldxhr[prop+'proxy']=(...funcargs)=> {
                        let result=target.oldxhr[prop].call(target.oldxhr,...funcargs)
                        console.log('函数劫持获取结果',result)
                        return result;
                    }
                }
                return Reflect.get(target.oldxhr,prop+'proxy')
            }
            if(prop.indexOf('response')!== -1)
            {
                let result=Reflect.get(target.oldxhr,prop)
                if(result.indexOf('金刀')!== -1){
                    result=result.replace('金刀','jindao')
                 }

                console.log('属性劫持结果',Reflect.get(target.oldxhr,prop))
                return Reflect.get(target.oldxhr,prop)
            }
            return Reflect.get(target.oldxhr,prop);
        },
        set(target, prop, value) {
            return Reflect.set(target.oldxhr, prop, value);
        }
    }

    let ret = new Proxy(tagetobk, handle);

    return ret;
}
```





## 例子:   实战抖音短视频无水印下载

> 通过xhr劫持直接拿到返回的内容

通常通过xhr劫持可以达成两种效果，一个是在xhr发送数据之前对数据进行获取和篡改，一个则是在xhr返回数据之后进行获取

可以在抖音官网:  https://www.douyin.com/user/MS4wLjABAAAAeq80JKa1oaIFOCOFjkw8o5STIHIsAnBQxVPxVJ4C7RZ5Hn8f1d_zNsMKaa8EOlCw?enter_method=video_title&author_id=3395719513245832&group_id=6976849455186185505&log_pb=%7B%22impr_id%22%3A%22021629423215634fdbddc0100fff0030a1217e00000001a54c1a3%22%7D&enter_from=undefined

通过f12进行抓包

大概查看一下数据，发现在`https://www.douyin.com/aweme/v1/web/aweme/post/?device_platform=webapp&aid=6383&channel=channel_pc_web&sec_user_id=MS4wLjABAAAAeq80JKa1oaIFOCOFjkw8o5STIHIsAnBQxVPxVJ4C7RZ5Hn8f1d_zNsMKaa8EOlCw&max_cursor=1624424355000&count=10&publish_video_strategy_type=2&version_code=160100&version_name=16.1.0&cookie_enabled=true&screen_width=1536&screen_height=864&browser_language=zh-CN&browser_platform=Win32&browser_name=Mozilla&browser_version=5.0+(Windows+NT+10.0%3B+Win64%3B+x64)+AppleWebKit%2F537.36+(KHTML,+like+Gecko)+Chrome%2F92.0.4515.159+Safari%2F537.36&browser_online=true&_signature=_02B4Z6wo00d01gP1vzgAAIDCg.dFeeve9RYD9buAAOHw7d`中的awemelist疑似是获取到的链接，这种乱七八糟一堆东西，想要做到解密是极其麻烦的，所以我们在这里可以直接打出一个xhr劫持获取返回内容

![image-20231220171508237](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220171508237.png)

![image-20231220172103365](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220172103365.png)

可以通过获取video的视频链接可以得到是v26开头的前缀,  使用如下方法判断:

```
document.querySelector('video').currentSrc

https://v3-web.douyinvod.com/9c96b4502899c24c53fef06a9a7cf20d/6582c5d0/video/tos/cn/tos-cn-ve-15c001-alinc2/osSMPlchbABnQCn1AHIHuUEgfe9pzRiBPDDIA4/?a=6383&ch=10010&cr=3&dr=0&lr=all&cd=0%7C0%7C0%7C3&cv=1&br=891&bt=891&cs=0&ds=3&ft=LjhJEL998xXpu0PmD0P5H4eaciDXtZTnq_QEeghJRCLD1Inz&mime_type=video_mp4&qs=1&rc=NjM4NWY1MzszNWQzNzxmOUBpM2x2Mzk6ZmdtbzMzNGkzM0AvYDY2YF4tNjIxYl5hMjItYSNwcl8ycjRfazBgLS1kLTBzcw%3D%3D&btag=e00008000&dy_q=1703065523&feature_id=46a7bb47b4fd1280f3d3825bf2b29388&l=202312201745236863F2681C9D940C9487
```

![image-20231220175447234](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220175447234.png)



之后所以在https://www.douyin.com/aweme/v1/web/aweme/post/?device_platform=webapp&aid=6383&channel=channel_pc_web&sec_user_id=MS4wLjABAAAAeq80JKa1oaIFOCOFjkw8o5STIHIsAnBQxVPxVJ4C7RZ5Hn8f1d_zNsMKaa8EOlCw&max_cursor=0&locate_query=false&show_live_replay_strategy=1&need_time_list=1&time_list_query=0&whale_cut_token=&cut_version=1&count=18&publish_video_strategy_type=2&pc_client_type=1&version_code=170400&version_name=17.4.0&cookie_enabled=true&screen_width=1536&screen_height=864&browser_language=zh-CN&browser_platform=Win32&browser_name=Firefox&browser_version=120.0&browser_online=true&engine_name=Gecko&engine_version=120.0&os_name=Windows&os_version=10&cpu_core_num=8&device_memory=&platform=PC&webid=7314551560427734528&msToken=v61cDUgqCYETWuZUhqZT3yL916YrxEt9dNGEQk7lMWVonz59iC1umaPUGJ9HvzuDFQ_2J_VDWHAbgp76rg5_Da6ukCQHcFs45TrLKJT08sziLHYJlQv1PAll0N8=&X-Bogus=DFSzKwVY2vsANSPVtN2PgRxfrmfp通过f12进行抓包的数据,  找一个[json在线格式化](https://www.sojson.com/)的工具，贴入数据并解析，搜索v3

![image-20231220175741110](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220175741110.png)



发现很多地方都是存在v3链接的，挑几个进行测试，我最后找到了video.play_addr.url_list是无水印的链接

![](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220175941812.png)

```
网页打开: http://v3-web.douyinvod.com/b3e2fa80654439aa90b68fe85eea3e57/6582c866/video/tos/cn/tos-cn-ve-15/c03de8fa3bc94066913c3ed6f732b878/?a=6383&ch=10010&cr=3&dr=0&lr=all&cd=0%7C0%7C0%7C3&cv=1&br=1970&bt=1970&cs=0&ds=3&ft=LjhJEL998xXpu0PmD0P5H4eaciDXte_nq_QEeghJRCLD1Inz&mime_type=video_mp4&qs=0&rc=aDNmZztmOTs7ZDc3aTw6ZEBpanNpNmRzNXE1NjMzNGkzM0BfLjU2Y2M1XjYxLzYxLzU1YSMxcm9vNHIuMy5gLS1kLWFzcw%3D%3D&btag=e00010000&dy_q=1703066176&l=20231220175616E1E0AAC6A571DA053B98

ok进入无水印视频

..但是发现用http://v26-web.douyinvod.com/f88e9dd04c020fd8f168f81b8951b844/6582c866/video/tos/cn/tos-cn-ve-15/c03de8fa3bc94066913c3ed6f732b878/?a=6383&ch=10010&cr=3&dr=0&lr=all&cd=0%7C0%7C0%7C3&cv=1&br=1970&bt=1970&cs=0&ds=3&ft=LjhJEL998xXpu0PmD0P5H4eaciDXte_nq_QEeghJRCLD1Inz&mime_type=video_mp4&qs=0&rc=aDNmZztmOTs7ZDc3aTw6ZEBpanNpNmRzNXE1NjMzNGkzM0BfLjU2Y2M1XjYxLzYxLzU1YSMxcm9vNHIuMy5gLS1kLWFzcw%3D%3D&btag=e00010000&dy_q=1703066176&l=20231220175616E1E0AAC6A571DA053B98", "http://v3-web.douyinvod.com/b3e2fa80654439aa90b68fe85eea3e57/6582c866/video/tos/cn/tos-cn-ve-15/c03de8fa3bc94066913c3ed6f732b878/?a=6383&ch=10010&cr=3&dr=0&lr=all&cd=0%7C0%7C0%7C3&cv=1&br=1970&bt=1970&cs=0&ds=3&ft=LjhJEL998xXpu0PmD0P5H4eaciDXte_nq_QEeghJRCLD1Inz&mime_type=video_mp4&qs=0&rc=aDNmZztmOTs7ZDc3aTw6ZEBpanNpNmRzNXE1NjMzNGkzM0BfLjU2Y2M1XjYxLzYxLzU1YSMxcm9vNHIuMy5gLS1kLWFzcw%3D%3D&btag=e00010000&dy_q=1703066176&l=20231220175616E1E0AAC6A571DA053B98", "https://www.douyin.com/aweme/v1/play/?video_id=v0d00fg10000c3126n12up7ar3rfup4g&line=0&file_id=8a87294f94244a98a886fcf89d8c10be&sign=d1b6b6b450de78246c4f66bf46a87513&is_play_url=1&source=PackSourceEnum_PUBLISH 
也可以
```

![image-20231220180358232](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220180358232.png)

写成如下代码(部分)

```js
    // xhr 拦截   
    function addXMLRequestCallback(callback){
        var oldSend, i;
        if( XMLHttpRequest.callbacks ) {
            // we've already overridden send() so just add the callback
            XMLHttpRequest.callbacks.push( callback );
        } else {
            // create a callback queue
            XMLHttpRequest.callbacks = [callback];
            // store the native send()
            oldSend = XMLHttpRequest.prototype.send;
            // override the native send()
            XMLHttpRequest.prototype.send = function(){
                // process the callback queue
                // the xhr instance is passed into each callback but seems pretty useless
                // you can't tell what its destination is or call abort() without an error
                // so only really good for logging that a request has happened
                // I could be wrong, I hope so...
                // EDIT: I suppose you could override the onreadystatechange handler though
                for( i = 0; i < XMLHttpRequest.callbacks.length; i++ ) {
                    XMLHttpRequest.callbacks[i]( this );
                }
                // call the native send()
                oldSend.apply(this, arguments);
            }
        }
    }

    // e.g.
    addXMLRequestCallback( function( xhr ) {
        xhr.addEventListener("load", function(){
            if ( xhr.readyState == 4 && xhr.status == 200 ) {
                // 是否是视频的链接
                if(xhr.responseURL.indexOf('/web/aweme/post')!==-1){
                    console.log('触发了加载')
                    let list=JSON.parse(xhr.response)
                    // 如果存在aweme_list属性
                    if(list.aweme_list!==undefined){
                        // 遍历aweme_list
                        for(let index=0;index<list.aweme_list.length;index++){
                            // 找到无水印地址url
                            let item=list.aweme_list[index].video.play_addr.url_list[1]
                            if(item.length!==0){
   /*因为一些存在前缀，一些不存在http前缀，一些前缀是//，所以我这里直接全部过滤为空加入了https
   	保存在videolist
   */                                videolist.push('https://'+item[0].replace('https://','').replace('http://','').replace('//',''))
                            }else{
                            alert('888')}
                        }

                    }

                }
            }
        });

    });
```

**网页源代码进行分析**

那这里我们的抖音视频解析就完成了一半了，大家如果测试会发现, 刚进入页面是没有进行这个post的。明明网页加载了很多个视频, 脚本确只拿到10个

![image-20231220154230744](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220154230744.png)

因为这个网页在加载过程中，会把一些用户数据或者页面数据直接放入网页中，在加载的过程中直接渲染, 并没有进行xhr请求了

没思路的时候看看网页源代码进行分析,  这里我们搜索v26看到了存在一个script标签，里面有一大坨乱七八糟的数据

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170298842473755.png)

看到`%22%3A%221579877069082637%22%2C%22hashtagName%22%3A%22%E4%B8%`这种乱七八糟的%字符串，通常是url编码，我们需要进行解码

通过控制台拿到, 方便一点不用复制上面的

![image-20231220173555289](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220173555289.png)

let unrender=JSON.parse(decodeURIComponent(document.querySelector('#RENDER_DATA').innerText))

![image-20231220142021919](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220142021919.png)

![image-20231220142354399](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/image-20231220142354399.png)



解析成对象的unrender存在三个键值，其中只有一个是存在视频列表的，所以我们使用Object.keys(unrender)获取他的所有键值

并且用for进行遍历

```
for(let index=0;index<keys.length;index++){
if(unrender[keys[index]].post!==undefined){
GetRenderTextVideo(videolist,unrender[keys[index]].post.data)
}
}
```

如果对应的对象的键值内存在post属性，就调用GetRenderTextVideo函数

```
function GetRenderTextVideo(MergeArray,VideoList){
    for(let index=0;index<VideoList.length;index++){
        let item=VideoList[index].video.playAddr
        if(item.length!==0){
            MergeArray.push('https://'+item[0].src.replace('//',''))
        }else{
            alert('8887')}

    }
}
```

这里的对象与我们通过xhr获取的对象不太一致，但是如何找到免水印的字符串的方法基本一致

到这里我们就完成了xhr的获取实战，下节课我们学习如果修改xhr参数！

[抖音单页视频下载助手](https://scriptcat.org/zh-CN/script-show-page/97)

```js
// ==UserScript==
// @name         xhr拦截
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       lfj_learm
// @match        http://*/*
// @match        https://www.baidu.com/
// @match        https://so.csdn.net/*/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    function addXMLRequestCallback(callback){
        //debugger;
        //是一个劫持的函数
        // oldSend 旧函数 i 循环
        var oldSend, i;
        //判断是否有callbacks变量
        if( XMLHttpRequest.callbacks ) {
            //判断XMLHttpRequest对象下是否存在回调列表，存在就push一个回调的函数
            XMLHttpRequest.callbacks.push( callback );
        } else {
            //如果没有则创建一个callback数组  //如果不存在则在xmlhttprequest函数下创建一个回调列表
            XMLHttpRequest.callbacks = [callback];
            // 保存 XMLHttpRequest 的send函数
            oldSend = XMLHttpRequest.prototype.send;

            //获取旧xml的send函数，并对其进行劫持（替换）  function()则为替换的函数
            XMLHttpRequest.prototype.send = function(){

                // 这里进行一些对自己数据的操作

                // 发送请求
                fetch("https://api.apiopen.top/api/sentences")
                    .then(response=> response.json())
                    .then(result =>{

                    //获取被替换的dom
                    const dom = document.getElementsByClassName("main-lt")[0];
                    dom.innerHTML = result.result.name

                })

                //循环回调xml内的回调函数
                // 调用旧的send函数 并传入this 和 参数
                oldSend.apply(this, arguments);
                //oldSend.apply(1);
                //由于我们获取了send函数的引用，并且复写了send函数，这样我们在调用原send的函数的时候，需要对其传入引用，而arguments是传入的参数
            }
        }
    }

    // e.g.
    //传入回调 接收xhr变量
    addXMLRequestCallback( function( xhr ) {
        //调用劫持函数，填入一个function的回调函数
        //回调函数监听了对xhr调用了监听load状态，并且在触发的时候再次调用一个function，进行一些数据的劫持以及修改
        //对xhr进行事件监听 判断是load 再回调function函数
        xhr.addEventListener("load", function(){
            console.log(xhr)
            if ( xhr.readyState == 4 && xhr.status == 200 ) {
                // 输入当前的路径
                console.log( '函数1',xhr.responseURL );
            }
        });

    });


    // Your code here...
})();
```

## 例子:  XHR实战百度自定义分享码

我们在使用之前可以先看一下代码

```javascript
function addXMLRequestCallback(callback){
    var oldSend, i;
    if( XMLHttpRequest.callbacks ) {
        // we've already overridden send() so just add the callback
        XMLHttpRequest.callbacks.push( callback );
    } else {
        // create a callback queue
        XMLHttpRequest.callbacks = [callback];
        // store the native send()
        oldSend = XMLHttpRequest.prototype.send;
        // override the native send()
        XMLHttpRequest.prototype.send = function(){
            // process the callback queue
            // the xhr instance is passed into each callback but seems pretty useless
            // you can't tell what its destination is or call abort() without an error
            // so only really good for logging that a request has happened
            // I could be wrong, I hope so...
            // EDIT: I suppose you could override the onreadystatechange handler though
            for( i = 0; i < XMLHttpRequest.callbacks.length; i++ ) {
                XMLHttpRequest.callbacks[i]( this );
            }
            // call the native send()
            if(arguments.length!==0){
                if(arguments[0]!==null&&arguments[0].indexOf!==undefined){
                    if(arguments[0].indexOf('pwd')!==-1&&arguments[0].indexOf('vcode')===-1){
                        var number=prompt("输入默认修改的四位分享码，默认:8888","8888")
                        if(number.length!==4)
                        {
                            number='8888'
                        }
                        arguments[0]=arguments[0].replace(/pwd=[a-zA-Z0-9]{0,4}&/i,"pwd="+number+"&")
                    }
                }
            }
                console.log('arguments',arguments)
            oldSend.apply(this, arguments);
        }
    }
}

// e.g.
addXMLRequestCallback( function( xhr ) {
        xhr.addEventListener("load", function(){
        if ( xhr.readyState == 4 && xhr.status == 200 ) {
            console.log( xhr.responseURL );
        }
    });

});
```

copy

这里依然是使用我们的js劫持例子，通常我喜欢直接贴上xhr劫持的demo然后在基础上修改

传入那个没用的函数是为了方便打印出劫持到的url，更好的分析我们的代码执行

## 提示

通常我们运行劫持脚本后在堆栈跟踪里看到了我们的脚本名字就是代表已经成功劫持了，如果发现没有成功劫持，可能是在脚本劫持之前已经被网页获取到了xhr，这个时候我们可以考虑使用runat抢先执行试图(让我们比比谁的剑更快！)

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170304457521261.png)

那我们如何判断一个post是否是xhr呢？

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170304457521562.png)

好了！你学会了！

我们这里代码最核心的部分就是

```javascript
if(arguments.length!==0){
                if(arguments[0]!==null&&arguments[0].indexOf!==undefined){
                    if(arguments[0].indexOf('pwd')!==-1&&arguments[0].indexOf('vcode')===-1){
                        var number=prompt("输入默认修改的四位分享码，默认:8888","8888")
                        if(number.length!==4)
                        {
                            number='8888'
                        }
                        arguments[0]=arguments[0].replace(/pwd=[a-zA-Z0-9]{0,4}&/i,"pwd="+number+"&")
                    }
                }
            }
                console.log('arguments',arguments)
```

arguments是对send传入的参数，我们首先判断长度是否为0，如果不为0就执行

arguments[0]纯属我多此一举进行判断的，这里的判断条件大家可以根据自己的需求逐渐的修正判断条件。大家不要在意细节

判断是否存在indexOf函数则是接下来我们使用了indexOf函数，他是一个属于字符串对象使用的函数，一些其他对象是不存在这个函数的，所以我们最好对使用的函数进行判断。

arguments[0].indexOf('pwd')!==-1&&arguments[0].indexOf('vcode')===-1

如果判断存在pwd和vcode，就执行下一步，这是我们在f12抓包的提交数据里看到的，我挑了几个关键的字符进行判断，但是依然可能在其他功能上出现错误，其实更好的办法可以通过url判断。
var number=prompt("输入默认修改的四位分享码，默认:8888","8888")
if(number.length!==4)
{
number='8888'
}

提示用户输入分享码，如果长度不为4或不输入默认8888

arguments[0]=arguments[0].replace(/pwd=[a-zA-Z0-9]{0,4}&/i,"pwd="+number+"&")

这里我对提交的字符串使用了replace，replace是字符串的替换函数，/pwd=[a-zA-Z0-9]{0,4}&/i 是什么意思的，这个是一个正则表达式，因为不涉及教程的内容，所以我大概对这条进行讲解，前后的/和/i可以忽略，/i是忽略大小写的意思，pwd=和&都是一个固定的字符串，唯一变动搜索的就是[a-zA-Z0-9]{0,4}

[]内表示搜索字符可以是括号内的任意一个字符,A-Z表示大写A到Z，a-z表示小写a-z，0-9表示数字0-9，说明我们匹配的字符可以是A到Z，a-z，0-9之中的任意一个字符，而{0,4}表示我们会匹配到0个到4个这样的字符，将pwd=[a-zA-Z0-9]{0,4}&匹配的内容替换成"pwd="+number+"&"，其实这里非常简单，就是把默认的提取码替换成用户自定义的提取码并且提交就没了。

那到这里我们就大概学习了xhr的各种劫持姿势

通常对原型链进行劫持，可以获取xhr返回的内容，以及篡改xhr提交的内容

而使用proxy或object.defineproperty可以对函数返回的内容进行一个劫持。



# Promise

Promise代表了未来发生的事件，相当于我与你签订了一个协议，我们现在协议没有办法完成，而在未来的某个时间点，这个协议会由执行中变为履行或者未履行

```js
var myPromise = new Promise(function(resolve, reject){
    setTimeout(function(){
        resolve("成功!"); //代码正常执行！
    }, 5000);
});
```

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170306905342865.png)

我们创建promise的时候是在New Promise的过程中传入一个函数，promise会调用这个函数，并且传给我们两个参数

resolve以及reject，如果你这个函数最后执行成功了，调用resolve并且传入数据，promise将会变得履行，如果调用reject，则是表示失败了

在代码中可以看到，当履行的过程中会显示pending，而当履行完毕后会显示fulfilled(履行完毕)



但是在这时候我们是拿不到promise的值的，我们该怎么样才能拿到呢？

即对promise后添加一个then函数，当promise变为完毕的状态后即会自动调用我们的then函数并且传入数据。

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170306905342966.png)

当上部分函数调用了resolve后，将会调用挂载到promise上的then函数，并传入参数

这里我通过console.log(data)输出了我们获取到的内容，那大家可能会疑惑，为什么我又return了一个data+'11111'

因为new Promise产生的是一个promise对象，而我们对这个对象挂了then后，then也会返回一个promise对象，这样方便我们对数据进行一层一层的处理或者包装。

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170306905342967.png)

我们挂载了两层then

第一层then获取到了promise的数据，然后对其进行输出并处理，返回了data+‘11111’交给了第二个then，第二个then是我们最终处理的数据的函数



需要注意的是第二个then也会返回一个promise，由于我们没有给他返回值，所以是履行状态，返回的值value是一个undefined



为什么then返回的promise是fulfilled，难道他也有执行状态(pending)？？？？

猜对了！在then函数中我们也可以返回一个promise

如果返回普通内容，普通内容将会变成then返回的这个promise的value值

如果返回一个promise，那then返回的promise将直接变成我们返回的promise



```js
new Promise(function(resolve, reject){
    setTimeout(function(){
        resolve("周杰伦"); //代码正常执行！
    }, 5000);
}).then(
function(data){
    console.log('我是then，我获取了数据，进行处理'+data)
    return new Promise(function(resolve, reject){
    setTimeout(function(){
        resolve("东泥打目"); //代码正常执行！
    }, 1000);
})
}
).then(function (data2){
   console.log('then获取了数据，并进行处理，然后获取了新的数据丢给我'+data2)
})
```

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170306905342968.png)

我们可以看到，在第一个then中我们创建了一个promise并且返回，当这个promise结束后，会调用第二个then，并传入数据。

那这里promise的大概概念大家已经理解了

那还有最后一个问题，如果我们的promise没有完成怎么办？

我们就需要调用reject表示未履行

```js
var p=new Promise(function(resolve, reject){
    setTimeout(function(){
        resolve("周杰伦"); //代码正常执行！
    }, 5000);
})

var then1=p.then(
function(data){
    console.log('我是then，我获取了数据，进行处理'+data)
    return new Promise(function(resolve, reject){
    setTimeout(function(){
        reject("东泥打目被抓了"); //代码正常执行！
    }, 1000);
})
}
)

var then2=then1.then(function (data2){
   console.log('then获取了数据，并进行处理，然后获取了新的数据丢给我'+data2)
})

var then2cath=then2.catch((err) => console.log('捕获到了异常', err));
console.log(p,then1,then2,then2cath)
```

如果我们对promise挂载一个catch，当出现未履行的情况就会直接调用catch

![图片.png](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/300-170306905342969.png)

这里我们可以看到，当我们在then1里没找到东泥打木，我们调用了reject，reject会传给then2，而then2因为then1的reject也无法履行，继续往下传递，这时候发现了then2身上挂载这一个catch，当发生reject的时候就会调用catch，所以会调用到then2的catch函数，也就是说catch捕获了异常，在reject的过程中会使then的状态传递的，直至遇见catch或完成，最后输出的一个promise是fufilled，因为他是捕获异常，我们再这里并没有搞出来新的异常，所以catch这个promise是完成任务的！

附注

我们还可以添加一个finally，finally的函数不管成功还是失败最后一定会调用finally内的函数









# 参考

使用脚手架写脚本应该就不会遇到这个问题了。
参考https://bbs.tampermonkey.net.cn/thread-3688-1-1.html

[最新Tampermonkey 中文文档解析 - 大白熊^_^ - 博客园 (cnblogs.com)](https://www.cnblogs.com/dabaixiong/p/14279678.html)

 [油猴脚本开发指南]第一个脚本-HelloWorld https://bbs.tampermonkey.net.cn/thread-88-1-1.html
 [油猴脚本开发指南]脚本自动化之模拟点击和表单填写 https://bbs.tampermonkey.net.cn/thread-91-1-1.html
 [油猴脚本开发指南]grant介绍,none与unsafeWindow https://bbs.tampermonkey.net.cn/thread-160-1-1.html
 [油猴脚本开发指南]h5视频倍速,时间加速和run-at https://bbs.tampermonkey.net.cn/thread-176-1-1.html
 [油猴脚本开发指南]脚本ajax的跨域请求 https://bbs.tampermonkey.net.cn/thread-136-1-1.html
 [油猴脚本开发指南]脚本往页面上添加新元素 https://bbs.tampermonkey.net.cn/thread-237-1-1.html
 [油猴脚本开发指南]外部资源引用 https://bbs.tampermonkey.net.cn/thread-249-1-1.html
 [油猴脚本开发指南]右键菜单与GM_get/setValue函数 https://bbs.tampermonkey.net.cn/thread-271-1-1.html
 [油猴脚本开发指南]特别篇Jquery引用 https://bbs.tampermonkey.net.cn/thread-275-1-1.html
 油猴脚本开发指南]使用GM_addStyle去除网页广告 https://bbs.tampermonkey.net.cn/thread-274-1-1.html
 [油猴脚本开发指南]油猴hook - 实现b站评论小尾巴 https://bbs.tampermonkey.net.cn/thread-429-1-1.html
 油猴脚本开发指南]简易this教程 https://bbs.tampermonkey.net.cn/thread-549-1-1.html
 [油猴脚本开发指南]简易感受this的例子 https://bbs.tampermonkey.net.cn/thread-550-1-1.html
 [油猴脚本开发指南]去除网页广告以及去除元素 https://bbs.tampermonkey.net.cn/thread-688-1-1.html
 [油猴脚本开发指南]箭头函数的特性 https://bbs.tampermonkey.net.cn/thread-720-1-1.html
 [油猴脚本开发指南]原型与原型链 https://bbs.tampermonkey.net.cn/thread-744-1-1.html
 [油猴脚本开发指南]XHR劫持代码原理解释 https://bbs.tampermonkey.net.cn/thread-752-1-1.html
 [油猴脚本开发指南]对象的数据劫持代码 https://bbs.tampermonkey.net.cn/thread-753-1-1.html
 [油猴脚本开发指南]Proxy的使用 https://bbs.tampermonkey.net.cn/thread-765-1-1.html
 [油猴脚本开发指南]Reflect的使用 https://bbs.tampermonkey.net.cn/thread-803-1-1.html
 [油猴脚本开发指南]基本油猴编程的一些常见误区 https://bbs.tampermonkey.net.cn/thread-835-1-1.html
 [油猴脚本开发指南]XHR的返回内容劫持 https://bbs.tampermonkey.net.cn/thread-839-1-1.html
 [油猴脚本开发指南]实战抖音短视频无水印下载 https://bbs.tampermonkey.net.cn/thread-873-1-1.html
 [油猴脚本开发指南]XHR实战百度自定义分享码 https://bbs.tampermonkey.net.cn/thread-877-1-1.html
 [油猴脚本开发指南]Promise基础解释 https://bbs.tampermonkey.net.cn/thread-878-1-1.html
 [油猴脚本开发指南]Promise常用函数与语法糖 https://bbs.tampermonkey.net.cn/thread-881-1-1.html
 [油猴脚本开发指南]包装异步代码为同步代码 https://bbs.tampermonkey.net.cn/thread-883-1-1.html
 [油猴脚本开发指南]Promise执行顺序问题 https://bbs.tampermonkey.net.cn/thread-894-1-1.html
 [油猴脚本开发指南]理解fetch劫持 https://bbs.tampermonkey.net.cn/thread-896-1-1.html
 [油猴脚本开发指南]实战fetch劫持知乎去广告 https://bbs.tampermonkey.net.cn/thread-912-1-1.html
 [油猴脚本开发指南]实战fetch劫持快手无水印视频 https://bbs.tampermonkey.net.cn/thread-927-1-1.html
 [油猴脚本开发指南]addEventListener劫持 https://bbs.tampermonkey.net.cn/thread-967-1-1.html
 [油猴脚本开发指南]script标签初始化对象劫持 https://bbs.tampermonkey.net.cn/thread-979-1-1.html
 [油猴脚本开发指南]MutationObserver的使用 https://bbs.tampermonkey.net.cn/thread-988-1-1.html
 [油猴脚本开发指南]Mutation Event性能影响简易测试 https://bbs.tampermonkey.net.cn/thread-1006-1-1.html
 [油猴脚本开发指南]MutationObserver简单详解 https://bbs.tampermonkey.net.cn/thread-1007-1-1.html
 [油猴脚本开发指南]MutationObserver简易例子 https://bbs.tampermonkey.net.cn/thread-1008-1-1.html
 [油猴脚本开发指南]MutationObserver实战 https://bbs.tampermonkey.net.cn/thread-1017-1-1.html
 [油猴脚本开发指南]Fetch劫持的第二种方式 https://bbs.tampermonkey.net.cn/thread-1020-1-1.html
 [油猴脚本开发指南]油猴脚本调用Vue https://bbs.tampermonkey.net.cn/thread-1030-1-1.html
 [油猴脚本开发指南]修改Vue3代码兼容油猴 https://bbs.tampermonkey.net.cn/thread-1035-1-1.html
 [油猴脚本开发指南]油猴脚本调用element plus https://bbs.tampermonkey.net.cn/thread-1038-1-1.html
 [油猴脚本开发指南]魔改Element plus https://bbs.tampermonkey.net.cn/thread-1039-1-1.html
 [油猴脚本开发指南]延迟查询元素代码解读 https://bbs.tampermonkey.net.cn/thread-1058-1-1.html
 [油猴脚本开发指南]破解鼠标移出限制实战 https://bbs.tampermonkey.net.cn/thread-1060-1-1.html
 [油猴脚本开发指南]Proxy与defineProperty性能分析 https://bbs.tampermonkey.net.cn/thread-1062-1-1.html
 [油猴脚本开发指南]监控对象初始化属性分析 https://bbs.tampermonkey.net.cn/thread-1063-1-1.html
 [油猴脚本开发指南]CSS基础之元素基础 https://bbs.tampermonkey.net.cn/thread-1067-1-1.html
 [油猴脚本开发指南]CSS基础之字体控制 https://bbs.tampermonkey.net.cn/thread-1068-1-1.html
 [油猴脚本开发指南]CSS基础之元素定位 https://bbs.tampermonkey.net.cn/thread-1072-1-1.html
 [油猴脚本开发指南]CSS基础之弹性布局 https://bbs.tampermonkey.net.cn/thread-1074-1-1.html
 [油猴脚本开发指南]新阶段开篇前文 https://bbs.tampermonkey.net.cn/thread-1075-1-1.html
 [油猴脚本开发指南]VUE入门概念 https://bbs.tampermonkey.net.cn/thread-1076-1-1.html
 [油猴脚本开发指南]VUE数据绑定的响应原理 https://bbs.tampermonkey.net.cn/thread-1077-1-1.html
 [油猴脚本开发指南]VUE点击按钮 https://bbs.tampermonkey.net.cn/thread-1081-1-1.html
 [油猴脚本开发指南]响应式编辑框 https://bbs.tampermonkey.net.cn/thread-1083-1-1.html
 [油猴脚本开发指南]魔改toastr https://bbs.tampermonkey.net.cn/thread-1084-1-1.html
 [油猴脚本开发指南]toastr引用 https://bbs.tampermonkey.net.cn/thread-1085-1-1.html
 [油猴脚本开发指南]循环绘制 https://bbs.tampermonkey.net.cn/thread-1087-1-1.html
 [油猴脚本开发指南]循环Key的作用 https://bbs.tampermonkey.net.cn/thread-1088-1-1.html
 [油猴脚本开发指南-难度超标，暂时移除]简明diff(一) https://bbs.tampermonkey.net.cn/thread-1094-1-1.html
 [油猴脚本开发指南-难度超标，暂时移除]简明diff(二) https://bbs.tampermonkey.net.cn/thread-1095-1-1.html
 [油猴脚本开发指南-难度超标，暂时移除]简明diff(三) https://bbs.tampermonkey.net.cn/thread-1101-1-1.html
 [油猴脚本开发指南-难度超标，暂时移除]简明diff(四) https://bbs.tampermonkey.net.cn/thread-1105-1-1.html
 [油猴脚本开发指南]条件判断 https://bbs.tampermonkey.net.cn/thread-1116-1-1.html
 [油猴脚本开发指南]v-show https://bbs.tampermonkey.net.cn/thread-1117-1-1.html
 [油猴脚本开发指南]NPM发布魔改包 https://bbs.tampermonkey.net.cn/thread-1123-1-1.html
 [油猴脚本开发指南]GM存储函数 https://bbs.tampermonkey.net.cn/thread-1133-1-1.html
 [油猴脚本开发指南]vue组件 https://bbs.tampermonkey.net.cn/thread-1136-1-1.html
 [油猴脚本开发指南]with解决require引入问题 https://bbs.tampermonkey.net.cn/thread-1146-1-1.html
 [油猴脚本开发指南]filesaver解决前端下载 https://bbs.tampermonkey.net.cn/thread-1147-1-1.html
 [油猴脚本开发指南]JSZIP库压缩解压文件 https://bbs.tampermonkey.net.cn/thread-1150-1-1.html
 [油猴脚本开发指南]JSZIP库实战 https://bbs.tampermonkey.net.cn/thread-1198-1-1.html
 [油猴脚本开发指南]XHR劫持的第二种格式 https://bbs.tampermonkey.net.cn/thread-1201-1-1.html
 [油猴脚本开发指南]SweetAlert2的漂亮对话框 https://bbs.tampermonkey.net.cn/thread-1203-1-1.html
 [油猴脚本开发指南]元素规则校验和检测的触发 https://bbs.tampermonkey.net.cn/thread-1250-1-1.html
 [油猴脚本开发指南]SweetAlert2进阶 https://bbs.tampermonkey.net.cn/thread-1303-1-1.html
 [油猴脚本开发指南]基础的网页调试(一) https://bbs.tampermonkey.net.cn/thread-1383-1-1.html
 [油猴脚本开发指南]基础的脚本调试(二) https://bbs.tampermonkey.net.cn/thread-1386-1-1.html
 [油猴脚本开发指南]基础的网络分析(三) https://bbs.tampermonkey.net.cn/thread-1389-1-1.html
 [油猴脚本开发指南]实战React数据提取抖音视频 https://bbs.tampermonkey.net.cn/thread-1405-1-1.html
 [油猴脚本开发指南]Vue初探__vue__ https://bbs.tampermonkey.net.cn/thread-1425-1-1.html
 [油猴脚本开发指南]通过__vue__获取数据 https://bbs.tampermonkey.net.cn/thread-1438-1-1.html
 [油猴脚本开发指南]实战秒杀快手视频提取 https://bbs.tampermonkey.net.cn/thread-1441-1-1.html
 [油猴脚本开发指南]应用 & 组件实例 https://bbs.tampermonkey.net.cn/thread-1491-1-1.html
 [油猴脚本开发指南]模板语法 https://bbs.tampermonkey.net.cn/thread-1499-1-1.html
 [油猴脚本开发指南]基本油猴编程的一些常见误区(二) https://bbs.tampermonkey.net.cn/thread-1537-1-1.html
 [油猴脚本开发指南]本地文件访问权限与外部开发 https://bbs.tampermonkey.net.cn/thread-1550-1-1.html
 [油猴脚本开发指南]完善抖音脚本键盘事件 https://bbs.tampermonkey.net.cn/thread-1709-1-1.html
 [油猴脚本开发指南]querySelector与css选择器入门 https://bbs.tampermonkey.net.cn/thread-1821-1-1.html
 [油猴脚本开发指南]Layui库引入扩展模块路径解决方法 https://bbs.tampermonkey.net.cn/thread-1910-1-1.htm

视频链接:[零基础油猴开发\]哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1gq4y1T7iF/?spm_id_from=333.337.search-card.all.click&vd_source=d9a5c37e5a6a5464c48dd001e33d7319)







编写油猴脚本时想要调用网页上本身定义的 `saveData` 函数

```js
// ==UserScript==
// @name         Your Script Name
// @namespace    http://your.namespace.com
// @version      1.0
// @description  Your description
// @author       You
// @match        http://example.com/*
// @grant        unsafeWindow
// ==/UserScript==



// 在油猴脚本中手动触发页面上的按钮点击事件
$(document).ready(function() {
  $("#bc").click(function() {
    unsafeWindow.saveData(this, '0');
  });

  $("#tj").click(function() {
    unsafeWindow.saveData(this, '1');
  });
});


// 自动触发
$("#bc").click();
```

注意:  油猴脚本中都是使用自动触发





```
  $("#bc").click();
if(status == "1" && !confirm("您是否确认提交当前评价,提交后不能修改！")) {
    // 自动点击确定按钮
    setTimeout(function() {
       $('.ui-dialog-buttonset button:first').trigger('click');
    }, 10000); // 需要设置一个延迟，以确保弹出框已经加载完成
}

```





```
// ==UserScript==
// @name         自动点击确认按钮
// @include      *在这里输入你想要执行脚本的页面URL*
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// ==/UserScript==

// 使用 jQuery 的 ready 函数，确保页面加载完成后执行
$(document).ready(function() {
    // 保存原始的 confirm 函数，以便后续使用
    var originalConfirm = window.confirm;

    // 重写 confirm 函数
    window.confirm = function(message) {
        // 如果弹窗消息是 "您是否确认提交当前评价,提交后不能修改！"，则自动点击确定按钮
        if (message === "您是否确认提交当前评价,提交后不能修改！") {
            // 模拟用户点击确定按钮
            return true;
        } else {
            // 对于其他弹窗消息，保持原始的 confirm 行为
            return originalConfirm(message);
        }
    };
});

```





# 弹窗自动确认

在油猴脚本中，我们不能直接覆盖页面的 confirm 函数，因为油猴脚本运行在一个隔离的环境中，无法直接访问或修改页面的全局对象。

```js
// ==UserScript==
// @name     Override Confirm
// @match    http://your-website.com/*
// @require  http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js
// @grant    none
// ==/UserScript==

var script = document.createElement('script');
script.textContent = 'window.confirm = function() { return true; };';
$('head').append(script);
```





```
window.confirm = function() { return true; };
```



```js
==用户脚本==
[url=home.php？mod=space&uid=23356]@name[/url] 新用户脚本
@namespace http://tampermonkey.net/
@version 0.1
@description试图接管世界！
@author你
[url=home.php？mod=space&uid=52134]@match[/url] https://blog.xhome.pro/
@icon数据：image/gif; base64，R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
@run-at 文档启动
@grant 没有
==/用户脚本==

（函数（） {
“严格使用”;
     let hookConfirm = window.confirm
窗口确认 = （msg） => {
if（msg == '你能接管它吗'） {
让 t1 = Date.now（）
让 t2 = Date.now（）
而（t2 - t1 <= 300） {
t2 = 日期.now（）
             }
返回 true
         } else {
返回 hookConfirm.apply（this， arguments）;
         }
     }
您的代码在这里...
})();
```









# todo

```js
// ==UserScript==
// @name         学生评价
// @namespace    https://github.com/Auroraol
// @version      0.1
// @description  try to take over the world!
// @author       lfj
// @match        https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_find.do*
// @match        https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_list.do*
// @grant        none
// @require https://code.jquery.com/jquery-2.1.4.min.js
// ==/UserScript==
(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */
    /* eslint no-eval: "off" */

    if (window.location.href.startsWith("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_find.do")) {
        // 在页面1执行逻辑
        processPage1();
    } else if (window.location.href.startsWith("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_list.do")) {
        // 在页面2执行逻辑
        processPage2();
    }


    var index = 0;
    var links = $("a[title='点击进入评价']").map(function() {
        return $(this).prop('href');
    }).get();
    function processNextLink(index) {
        if (links.length > 0 && index < links.length) {
            var nextLink = links[index];
            //console.log(nextLink);
             window.location.href = nextLink;
        }
    }

    function processPage1() {
        // TODO: 处理页面1的逻辑
        console.log("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_find.do");
        processNextLink(index);
    }

    function processPage2() {
        // TODO: 处理页面2的逻辑
        console.log(" https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_list.do");
        //var allEvaluated = true;// 假设所有行都已评价
        // 遍历表格的每一行
        $('#dataList tr').each(function() {
            var tdText = $(this).find('td').eq(6).text(); // 获取第7列的文本
            if (tdText === '否') {
                //var evaluateLink = $(this).find('a:contains("评价")').attr('href');
                 // 获取评价链接的JavaScript代码
                var jsCode = $(this).find('a:contains("评价")').attr('href');
                // console.log(jsCode);
                // 执行JavaScript代码, 链接到填写评价表单
                eval(jsCode.substring(11)); // 去掉前面的"javascript:"
          
                // 填写评价
              //  window.location.href = evaluateLink;


                //allEvaluated = false;
                //return false;
            }
        });


        // 如果所有行都已评价，点击返回按钮
        if ($('#dataList tr td:contains("否")').length === 0) {
            index = index + 1;
            $('#btnShenshen').click();
        }
    }

})();
```





```
function autoEvaluate() {
        var rows = $('#dataList tr');  // 获取所有行
        var num = 0;  // 当前处理的行的索引
        var popupWindow = null;  // 弹出窗口

        function processRow() {
            if (num >= rows.length) {
                // 如果所有行都已处理，点击返回按钮
                if ($('#dataList tr td:contains("否")').length === 0) {
                    $('#btnShenshen').click();
                }
                index++;
                return;
            }

            var row = $(rows[num]);  // 获取当前行
            var tdText = row.find('td').eq(6).text();  // 获取第7列的文本
            if (tdText === '否') {
                // 如果有未评价的行，获取评价链接
                var jsCode = row.find('a:contains("评价")').attr('href');
                // 打开弹出窗口
                popupWindow = window.open(eval(jsCode.substring(11)));  // 去掉前面的"javascript:"
                if (popupWindow === null) {
                    console.error('Failed to open popup window');
                    return;
                }
            }

            // 检查弹出窗口是否关闭
            var checkPopupClosed = setInterval(function() {
                if (popupWindow && popupWindow.closed) {
                    clearInterval(checkPopupClosed);
                    num++;  // 增加索引
                    processRow();  // 处理下一行
                }
            }, 1000);
        }

        // 开始处理第一行
        processRow();
    }

```





首次匹配  –> 油猴脚本所以变量会 重新初始化



# ————

# startsWith

```
if (text.startsWith("评教大类：实践环节学生评价")) {
    // 这是实践环节学生评价
    // 在这里执行你的代码
} else if (text.startsWith("评教大类：理论课学生评价")) {
    // 这是理论课学生评价
    // 在这里执行你的代码
}
```

```
    if (window.location.href.startsWith("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_find.do")) {
        processPage1();
    } else if (window.location.href.startsWith("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_list.do")) {
        processPage2();
    } else if (window.location.href.startsWith("https://cdjwc.webvpn.ccu.edu.cn/jsxsd/xspj/xspj_edit.do")){
       // processPage3();
       }
```

# window.location

```
window.location.reload(); //刷新当前页面 
window.location.href = "url"  //跳转
```

```
if (window.location.href.indexOf("example.com") !== -1) {
  // 当前页面的 URL 包含 "example.com"
  // 执行相应的逻辑
} else {
  // 当前页面的 URL 不包含 "example.com"
  // 执行其他逻辑
}
```



# 页面切换, 传递数据localStorage

```
 var indexNext = localStorage.getItem('indexNext');
 indexNext++;
 localStorage.setItem('indexNext', indexNext.toString());
```











```

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
```





```
// ==UserScript==
// @name         窗口
// @namespace    https:*
// @version      0.1
// @description  try to take over the world!
// @author       lfj
// @match        *://*/*
// @require      https://code.jquery.com/jquery-3.1.0.js
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';
    /* globals jQuery, $, waitForKeyElements */

/*
      if (self == top) {
              GM_addStyle(`#zizhuPopupMain { position: fixed; z-index: 999; right: 0; bottom: 20px; background: #fff; }
#zizhuPopupMain-hd { font-size: 14px; line-height: 30px; overflow: hidden; box-sizing: border-box; height: 30px; padding: 0 10px; cursor: pointer; white-space: nowrap; text-overflow: ellipsis; color: #fff; background: #4d90fe; }
#zizhuPopupMain-hd svg { display: none; margin-top: 2px; }
#zizhuPopupMain-bd { box-sizing: border-box; height: 60px; padding: 10px; border: 1px solid #ccc; }
#zizhuPopupMainInput { display: inline-block; box-sizing: border-box; width: 210px; height: 40px; padding: 0 10px; border: 1px solid #ccc; outline: none; }
#zizhuPopupMainBtn { font-size: 13px; line-height: 39px; display: inline-block; width: 60px; height: 40px; margin-left: -5px; text-align: center; text-decoration: none; color: #fff; background: #4d90fe; }
.zizhuPopupMainSmallHead { width: 32px; }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd { padding: 0 4px; box-shadow: 1px 2px 3px rgba(12, 12, 12, .3); }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd span { display: none; }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd svg { display: block; }
`)
    // 添加内容
    var smallCnt = `<div id="zizhuPopupMain">
		<div id="zizhuPopupMain-hd">
			<span>蜘蛛磁力搜索<small>(点击可缩小)</small></span>
			<!--<svg t="1542846569380" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1925" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24"><defs><style type="text/css"></style></defs><path d="M215.51289 370.94645c2.566452 1.534959 5.383614 2.25332 8.16803 2.25332 5.476735 0 10.796904-2.800789 13.802354-7.839549 45.552475-76.69373 129.193431-124.343983 218.281445-124.343983 8.856715 0 16.023952-7.166213 16.023952-16.023952s-7.167237-16.023952-16.023952-16.023952c-100.338243 0-194.541765 53.658084-245.838058 140.022057C205.404672 356.596627 207.907679 366.440833 215.51289 370.94645z" p-id="1926" fill="#ffffff"></path><path d="M196.751594 417.501766c-8.607028-1.987261-17.229406 3.332908-19.24839 11.955286-4.78805 20.451798-7.495718 33.127492-7.495718 55.879682 0 8.856715 7.182586 16.023952 16.023952 16.023952 8.857738 0 16.024975-7.167237 16.024975-16.023952 0-19.309788 2.159176-29.387307 6.650467-48.588625C210.724841 428.125731 205.372949 419.519726 196.751594 417.501766z" p-id="1927" fill="#ffffff"></path><path d="M947.204451 876.167047 784.053628 713.013153c-0.441045-0.442068-0.893346-0.86367-1.351787-1.272993 41.450041-62.197574 65.652256-136.821155 65.652256-217.013569 0-216.480426-176.10895-392.589376-392.588353-392.589376-216.4661 0-392.589376 176.10895-392.589376 392.589376 0 216.47224 176.123276 392.58119 392.589376 392.58119 78.758762 0 152.117536-23.378453 213.647915-63.470567l-46.695508-46.694485c-49.01125 29.074176-105.971543 46.069245-166.952406 46.069245-181.131337 0-328.493569-147.343813-328.493569-328.48436 0-181.131337 147.361209-328.493569 328.493569-328.493569 181.130314 0 328.493569 147.362232 328.493569 328.493569 0 85.36932-33.002648 162.956396-86.567611 221.433228l36.58422 36.585243c1.251503 1.983167 2.732228 3.860934 4.459568 5.588275l163.15287 163.151847c6.259564 6.259564 14.459317 9.389858 22.659069 9.389858s16.415878-3.130294 22.659069-9.389858C959.724603 908.980383 959.724603 888.684128 947.204451 876.167047z" p-id="1928" fill="#ffffff"></path></svg>-->
		</div>
		<div id="zizhuPopupMain-bd">
			<input type="text" name="" placeholder="电影,小说,游戏,想找的全都有" id="zizhuPopupMainInput" />
			<a href="javascript:void(0);" id="zizhuPopupMainBtn">搜索</a>
		</div>`
    // 添加到 body
    var odom = document.createElement("div");
    odom.id = "zizhuPopupMain";
    odom.innerHTML = smallCnt;
    document.body.appendChild(odom);
    // 点击 hd 事件
    $('#zizhuPopupMain-hd').click(function(){
		//$('#zizhuPopupMain').toggleClass('zizhuPopupMainSmallHead')
		$('#zizhuPopupMain-bd').slideToggle()
	})
    //点击搜索事件
    $('#zizhuPopupMainBtn').click(function(){
		let val = $('#zizhuPopupMainInput').val();
		if(val != '' && val != null && val != undefined){
			console.log(val)
			$(this).attr({
				//href:'http://www.zhizhud.com/so/'+val+'-first-asc-1',
				href:'https://cilibird.com/s/'+val+'/time-1.html',
				target: '_blank'
			})
		}
	})
    // 回车事件
    $('#zizhuPopupMainInput').keydown(function(e){
		if(e.keyCode == 13) {
			let val = $('#zizhuPopupMainInput').val();
			if(val != '' && val != null && val != undefined){
				//window.open('http://www.zhizhud.com/so/'+val+'-first-asc-1')
				window.open('https://cilibird.com/s/'+val+'/time-1.html')
			}
		}
	})
	}

})();
```



```
// ==UserScript==
// @name         蜘蛛磁力搜索弹窗版
// @namespace    https://zizhucili.com
// @version      0.7
// @description  搜索想看的视频,书籍,软件的磁力链接,方便高效,想搜什么搜什么
// @author       Fructose
// @match        *://*/*
// @grant        GM_addStyle
// @require      https://code.jquery.com/jquery-3.1.0.js
// @license      MIT
// @icon         https://cdn-img.easyicon.net/png/376/37643.gif
// ==/UserScript==
 
(function() {
    'use strict';
 
    if (self == top) {
              GM_addStyle(`#zizhuPopupMain { position: fixed; z-index: 999; right: 0; bottom: 20px; background: #fff; }
#zizhuPopupMain-hd { font-size: 14px; line-height: 30px; overflow: hidden; box-sizing: border-box; height: 30px; padding: 0 10px; cursor: pointer; white-space: nowrap; text-overflow: ellipsis; color: #fff; background: #4d90fe; }
#zizhuPopupMain-hd svg { display: none; margin-top: 2px; }
#zizhuPopupMain-bd { box-sizing: border-box; height: 60px; padding: 10px; border: 1px solid #ccc; }
#zizhuPopupMainInput { display: inline-block; box-sizing: border-box; width: 210px; height: 40px; padding: 0 10px; border: 1px solid #ccc; outline: none; }
#zizhuPopupMainBtn { font-size: 13px; line-height: 39px; display: inline-block; width: 60px; height: 40px; margin-left: -5px; text-align: center; text-decoration: none; color: #fff; background: #4d90fe; }
.zizhuPopupMainSmallHead { width: 32px; }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd { padding: 0 4px; box-shadow: 1px 2px 3px rgba(12, 12, 12, .3); }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd span { display: none; }
.zizhuPopupMainSmallHead  #zizhuPopupMain-hd svg { display: block; }
`)
    // 添加内容
    var smallCnt = `<div id="zizhuPopupMain">
		<div id="zizhuPopupMain-hd">
			<span>蜘蛛磁力搜索<small>(点击可缩小)</small></span>
			<svg t="1542846569380" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1925" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24"><defs><style type="text/css"></style></defs><path d="M215.51289 370.94645c2.566452 1.534959 5.383614 2.25332 8.16803 2.25332 5.476735 0 10.796904-2.800789 13.802354-7.839549 45.552475-76.69373 129.193431-124.343983 218.281445-124.343983 8.856715 0 16.023952-7.166213 16.023952-16.023952s-7.167237-16.023952-16.023952-16.023952c-100.338243 0-194.541765 53.658084-245.838058 140.022057C205.404672 356.596627 207.907679 366.440833 215.51289 370.94645z" p-id="1926" fill="#ffffff"></path><path d="M196.751594 417.501766c-8.607028-1.987261-17.229406 3.332908-19.24839 11.955286-4.78805 20.451798-7.495718 33.127492-7.495718 55.879682 0 8.856715 7.182586 16.023952 16.023952 16.023952 8.857738 0 16.024975-7.167237 16.024975-16.023952 0-19.309788 2.159176-29.387307 6.650467-48.588625C210.724841 428.125731 205.372949 419.519726 196.751594 417.501766z" p-id="1927" fill="#ffffff"></path><path d="M947.204451 876.167047 784.053628 713.013153c-0.441045-0.442068-0.893346-0.86367-1.351787-1.272993 41.450041-62.197574 65.652256-136.821155 65.652256-217.013569 0-216.480426-176.10895-392.589376-392.588353-392.589376-216.4661 0-392.589376 176.10895-392.589376 392.589376 0 216.47224 176.123276 392.58119 392.589376 392.58119 78.758762 0 152.117536-23.378453 213.647915-63.470567l-46.695508-46.694485c-49.01125 29.074176-105.971543 46.069245-166.952406 46.069245-181.131337 0-328.493569-147.343813-328.493569-328.48436 0-181.131337 147.361209-328.493569 328.493569-328.493569 181.130314 0 328.493569 147.362232 328.493569 328.493569 0 85.36932-33.002648 162.956396-86.567611 221.433228l36.58422 36.585243c1.251503 1.983167 2.732228 3.860934 4.459568 5.588275l163.15287 163.151847c6.259564 6.259564 14.459317 9.389858 22.659069 9.389858s16.415878-3.130294 22.659069-9.389858C959.724603 908.980383 959.724603 888.684128 947.204451 876.167047z" p-id="1928" fill="#ffffff"></path></svg>
		</div>
		<div id="zizhuPopupMain-bd">
			<input type="text" name="" placeholder="电影,小说,游戏,想找的全都有" id="zizhuPopupMainInput" />
			<a href="javascript:void(0);" id="zizhuPopupMainBtn">搜索</a>
		</div>`
    // 添加到 body
    var odom = document.createElement("div");
    odom.id = "zizhuPopupMain";
    odom.innerHTML = smallCnt;
    document.body.appendChild(odom);
    // 点击 hd 事件
    $('#zizhuPopupMain-hd').click(function(){
		$('#zizhuPopupMain').toggleClass('zizhuPopupMainSmallHead')
		$('#zizhuPopupMain-bd').slideToggle()
	})
    //点击搜索事件
    $('#zizhuPopupMainBtn').click(function(){
		let val = $('#zizhuPopupMainInput').val();
		if(val != '' && val != null && val != undefined){
			console.log(val)
			$(this).attr({
				//href:'http://www.zhizhud.com/so/'+val+'-first-asc-1',
				href:'https://cilibird.com/s/'+val+'/time-1.html',
				target: '_blank'
			})
		}
	})
    // 回车事件
    $('#zizhuPopupMainInput').keydown(function(e){
		if(e.keyCode == 13) {
			let val = $('#zizhuPopupMainInput').val();
			if(val != '' && val != null && val != undefined){
				//window.open('http://www.zhizhud.com/so/'+val+'-first-asc-1')
				window.open('https://cilibird.com/s/'+val+'/time-1.html')
			}
		}
	})
	}
})();
```



# 登录表单是如何做到每次打开浏览器, 自动填写的

另一种方式是使用浏览器的本地存储功能，比如localStorage或sessionStorage。当用户输入账号密码时，这些值会被存储在本地存储中，然后在页面加载时检查本地存储中是否存在这些值，并将它们填充到相应的输入框中。

```js
// 当用户输入账号密码时保存到本地存储
$('#email, #pwd').on('input', function() {
  localStorage.setItem('email', $('#email').val());
  localStorage.setItem('password', $('#pwd').val());
});

// 页面加载时检查本地存储中是否有账号密码，并填充到输入框中
$(document).ready(function() {
  $('#email').val(localStorage.getItem('email'));
  $('#pwd').val(localStorage.getItem('password'));
});
```







url跳转  –> 脚本刷新





```
<input type="button" name="qx" id="qx" value="保存" class="button" onclick="saveData(1)" />


function saveData(obj, status) {
		if(status == "1" && !confirm("您是否确认提交当前评价,提交后不能修改！")) {

		} else {
			obj.disabled = true;
			document.getElementById("Form1").submit();
		}
	}
```





# 常用插件

如果还想下载BILIBILI视频：就安装这个插件（chorme应用商店也能搜到）

[ACG Helper: Bilibili Auxiliary - Microsoft Edge Addons](https://microsoftedge.microsoft.com/addons/detail/acg-helper-bilibili-auxi/fcfebhekhbkhjjimonjmbgmkbclheaoh)



![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/p629233897.webp)

直接下载就行了



————————————————

v1.0 原文

碰到喜欢的B站知识类视频，怎么轻松提取人声文案/字幕（中英文通用），免得自己拖进度条旁边开个窗口打字做笔记？

此方法用来解决这样的困扰:看视频效率太低了,忍不住分心、拉进度条,暂停打字做笔记好累,收藏的视频在角落里积灰。

谢谢发教程视频的两位up主～



前提1：视频up主不分享文案+还没有人贡献笔记+视频没有外挂cc字幕, 所以不得不用这个办法。

前提2：电脑端操作。

==========导出MP4视频（参考操作视频：BV1ku411n7Dx）================



<iframe allow="fullscreen" allowfullscreen="allowfullscreen" frameborder="0" height="500" scrolling="no" src="https://player.bilibili.com/player.html?bvid=BV1ku411n7Dx&amp;autoplay=0" width="620" style="max-width: 100%;"></iframe>

可能是效果最好最方便的b站视频下载方法！简洁教程高清下载，不拼接、不转码！_哔哩哔哩_bilibili



第一步：微软应用商店下载 bilibili bwp，设置下载路径；

第二步：用bv号在bwp中搜索要下载的视频

第三步：下载视频到前置路径中（建议下载360p画质的就行, 体积小速度快点），发现子文件夹1中有一个MP4格式打不开

第四步：用notepad++进行编辑，删掉前面三个xFF，别删多别删少了

==========提取字幕（参考操作视频：BV1hv4y1g7Wr）================



<iframe allow="fullscreen" allowfullscreen="allowfullscreen" frameborder="0" height="500" scrolling="no" src="https://player.bilibili.com/player.html?bvid=BV1hv4y1g7Wr&amp;autoplay=0" width="620" style="max-width: 100%;"></iframe>

如何快速提取视频中的字幕？简单高效免费的提取视频中字幕的方法_哔哩哔哩_bilibili



第五步：视频可以正常打开了，导入到剪映中，使用智能字幕功能，识别字幕

第六步：点击导出，不勾选导出视频，只导出字幕

第七步：字幕就是笔记，后面根据个人喜好处理吧。如果是英文就用有道翻译一下。

（我喜欢导出字幕之后,在记事本中一边听着视频音频,一边删减字幕内容,加上标点符号,形成自己的笔记。有没有发现, 原来传统记笔记的方式,看视频+暂停打字, 花费双倍的时间,极其低效,难以坚持～)

结束。这一套流程熟练之后很快的。

————————————————————————

如果视频本来就有CC字幕，安装油猴脚本，复制/下载字幕

[Bilibili CC字幕工具 (greasyfork.org)](https://greasyfork.org/en/scripts/378513-bilibili-cc字幕工具)

![img](%E6%B2%B9%E7%8C%B4%E7%AC%94%E8%AE%B0.assets/p627207992.webp)

------------------------------------------------

