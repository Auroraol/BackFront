## 后端

```markdown
springBackEnd
├─ .gitignore
├─ .mvn
│  └─ wrapper
│     ├─ maven-wrapper.jar
│     └─ maven-wrapper.properties
├─ mvnw
├─ mvnw.cmd
├─ pom.xml
└─ src
   ├─ main
   │  ├─ java
   │  │  └─ com
   │  │     └─ lfj
   │  │        ├─ common
   │  │        │  └─ Result.java
  
   │  │        ├─ config
   │  │        │  ├─ CorsConfig.java
   │  │        │  ├─ MpConfig.java
   │  │        │  ├─ MyRedisConfig.java
   │  │        │  ├─ Properties
   │  │        │  │  ├─ JwtProperties.java
   │  │        │  │  └─ SwaggerProperties.java
   │  │        │  ├─ SwaggerConfig.java
   │  │        │  └─ web
   │  │        │     └─ MyWebConfig.java
   │  │        ├─ controller
   │  │        │  ├─ RoleController.java
   │  │        │  └─ UserController.java
   │  │        ├─ entity
   │  │        │  ├─ XMenu.java
   │  │        │  ├─ XRole.java
   │  │        │  ├─ XRoleMenu.java
   │  │        │  ├─ XUser.java
   │  │        │  └─ XUserRole.java
   │  │        ├─ interceptor
   │  │        │  └─ JwtValidateInterceptor.java
   │  │        ├─ mapper
   │  │        │  ├─ XMenuMapper.java
   │  │        │  ├─ XRoleMapper.java
   │  │        │  ├─ XRoleMenuMapper.java
   │  │        │  ├─ XUserMapper.java
   │  │        │  └─ XUserRoleMapper.java
   │  │        ├─ service
   │  │        │  ├─ impl
   │  │        │  │  ├─ XMenuServiceImpl.java
   │  │        │  │  ├─ XRoleMenuServiceImpl.java
   │  │        │  │  ├─ XRoleServiceImpl.java
   │  │        │  │  ├─ XUserRoleServiceImpl.java
   │  │        │  │  └─ XUserServiceImpl.java
   │  │        │  ├─ XMenuService.java
   │  │        │  ├─ XRoleMenuService.java
   │  │        │  ├─ XRoleService.java
   │  │        │  ├─ XUserRoleService.java
   │  │        │  └─ XUserService.java
   │  │        ├─ SpringBackEndApplication.java
   │  │        └─ util
   │  │           └─ JwtUtil.java
   │  └─ resources
   │     ├─ application.yml
   │     ├─ mapper
   │     │  ├─ XMenuMapper.xml
   │     │  ├─ XRoleMapper.xml
   │     │  ├─ XRoleMenuMapper.xml
   │     │  ├─ XUserMapper.xml
   │     │  └─ XUserRoleMapper.xml
   │     ├─ static
   │     └─ templates
   └─ test
      └─ java
         └─ com
            └─ lfj
               ├─ JwtUtilTest.java
               └─ SpringBackEndApplicationTests.java

```

### 1. 项目初始化

1. **创建springboot项目：2.7.8**

2. **pom依赖**

   ```xml
   <!-- web -->
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-web</artifactId>
   </dependency>
   <!-- mysql -->
   <dependency>
       <groupId>com.mysql</groupId>
       <artifactId>mysql-connector-j</artifactId>
   </dependency>
   <!-- mybatis-plus -->
   <dependency>
       <groupId>com.baomidou</groupId>
       <artifactId>mybatis-plus-boot-starter</artifactId>
       <version>3.5.2</version>
   </dependency>
   <dependency>
       <groupId>com.baomidou</groupId>
       <artifactId>mybatis-plus-generator</artifactId>
       <version>3.5.2</version>
   </dependency>
   <!-- freemarker -->
   <dependency>
       <groupId>org.freemarker</groupId>
       <artifactId>freemarker</artifactId>
   </dependency>
   <!-- lombok -->
   <dependency>
       <groupId>org.projectlombok</groupId>
       <artifactId>lombok</artifactId>
   </dependency>
   ```

3. **yml**

   ```yaml
   server:
     port: 9999
   
   spring:
     datasource:
       username: root
       password: 123456
       url: jdbc:mysql:///xdb
   
   logging:
     level:
       com.lantu: debug
   ```

4. **测试**

### 2. Mybatis-plus的代码生成

在test/java目录下创建CodeGenerator

1. **编写代码生成器**

   ```java
   public static void main(String[] args) {
           String url = "jdbc:mysql:///xdb";
           String username = "root";
           String password = "123456";
           String author = "laocai";
           String outputDir = "D:\\tmp\\spring\\x-admin\\src\\main\\java";
           String basePackage = "com.lantu";
           String moduleName = "sys";
           String mapperLocation = "D:\\tmp\\spring\\x-admin\\src\\main\\resources\\mapper\\" + moduleName;
           String tableName = "x_user,x_menu,x_role,x_role_menu,x_user_role";
           String tablePrefix = "x_";
           FastAutoGenerator.create(url, username, password)
                   .globalConfig(builder -> {
                       builder.author(author) // 设置作者
                               .enableSwagger() // 开启 swagger 模式
                               //.fileOverride() // 覆盖已生成文件
                               .outputDir(outputDir); // 指定输出目录
                   })
                   .packageConfig(builder -> {
                       builder.parent(basePackage) // 设置父包名
                               .moduleName(moduleName) // 设置父包模块名
                               .pathInfo(Collections.singletonMap(OutputFile.xml, mapperLocation)); // 设置mapperXml生成路径
                   })
                   .strategyConfig(builder -> {
                       builder.addInclude(tableName) // 设置需要生成的表名
                               .addTablePrefix(tablePrefix); // 设置过滤表前缀
                   })
                   .templateEngine(new FreemarkerTemplateEngine()) // 使用Freemarker引擎模板，默认的是Velocity引擎模板
                   .execute();
       }
   ```

2. **启动类加注解**

   ```java
   @MapperScan("com.lantu.*.mapper")
   ```

3. **测试**

### 3. 公共响应类

该项目前后端分离了, 用来和前端response结果对应起来

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Result<T> {
    private Integer code;    // 编码 200/400
    private String message;  // 响应消息
    private T data;          // 数据

    public static<T>  Result<T> success(){
        return new Result<>(20000,"success",null);
    }

    public static<T>  Result<T> success(T data){
        return new Result<>(20000,"success",data);
    }

    public static<T>  Result<T> success(T data, String message){
        return new Result<>(20000,message,data);
    }

    public static<T>  Result<T> success(String message){
        return new Result<>(20000,message,null);
    }

    public static<T>  Result<T> fail(){
        return new Result<>(20001,"fail",null);
    }

    public static<T>  Result<T> fail(Integer code){
        return new Result<>(code,"fail",null);
    }

    public static<T>  Result<T> fail(Integer code, String message){
        return new Result<>(code,message,null);
    }

    public static<T>  Result<T> fail( String message){
        return new Result<>(20001,message,null);
    }

}
```

测试代码

```java
@Slf4j
@RestController
public class UserController {
	@Autowired
	private XUserService xUserService;

	@GetMapping("/all")
	public void hello(){
		log.info("hello");
	}

	@GetMapping("/user")
	public  Result<List<XUser>> getAllUser(){
		List<XUser> list = xUserService.list();
		return Result.success(list, "查询成功");
	}
}
```

![image-20230922233147558](后端.assets/image-20230922233147558.png)

### 4. 登录相关接口

#### 4.1 登录

| 接口属性 | 值                                                           |
| -------- | ------------------------------------------------------------ |
| url      | /user/login                                                  |
| method   | post                                                         |
| 请求参数 | username password                                            |
| 返回参数 | ![image-20230923101854439](后端.assets/image-20230923101854439.png) |

controller

```java
@PostMapping("/login")
public Result<Map<String,Object>> login(@RequestBody User user){
    Map<String,Object> data = userService.login(user);
    if(data != null){
        return Result.success(data);
    }
    return Result.fail(20002,"用户名或密码错误");
}
```

service

```java
@Override	
public Map<String, Object> login(XUser user) {
    //根据用户名和密码查询
    LambdaQueryWrapper<XUser> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(XUser::getUsername,user.getUsername());
    wrapper.eq(XUser::getPassword,user.getPassword());
    XUser loginUser = this.baseMapper.selectOne(wrapper);
    //结果不为空,则生成token,并将用户信息存入redis
    if(loginUser != null) {
        // 暂时用UUID，终极方案是jwt
        String key = "user:" + UUID.randomUUID();
        // 存入redis
        loginUser.setPassword(null); //密码不存
        redisTemplate.opsForValue().set(key,loginUser,30, TimeUnit.MINUTES);
        // 返回数据
        Map<String, Object> data = new HashMap<>();
        data.put("token", key);
        return data;
    }
    return null;
}
```

测试效果

![image-20230923094816855](后端.assets/image-20230923094816855.png)

**整合redis**

在 Redis 出现之前，缓存框架各种各样，有了 Redis ，缓存方案基本上都统一了

1. pom

   ```xml
   <!-- redis -->
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-data-redis</artifactId>
   </dependency>
   ```

2. yml

   ```yaml
   spring:
     redis:
       host: localhost
       port: 6379
   ```

3. 配置类

   ```java
   @Configuration
   public class MyRedisConfig {
       @Resource
       private RedisConnectionFactory factory;
   
       @Bean
       public RedisTemplate redisTemplate(){
           RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
           redisTemplate.setConnectionFactory(factory);
           redisTemplate.setKeySerializer(new StringRedisSerializer());
   
           Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
           redisTemplate.setValueSerializer(serializer);
   
           ObjectMapper om = new ObjectMapper();
           om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
           om.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
           om.setTimeZone(TimeZone.getDefault());
           om.configure(MapperFeature.USE_ANNOTATIONS, false);
           om.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
           om.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);
           om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance ,ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
           om.setSerializationInclusion(JsonInclude.Include.NON_NULL);
           serializer.setObjectMapper(om);
   
           return redisTemplate;
       }
   }
   ```

   测试redis中保存

   ![image-20230923105605180](后端.assets/image-20230923105605180.png)

   

#### 4.2 获取用户信息

| 接口属性 | 值                                                           |
| -------- | ------------------------------------------------------------ |
| url      | /user/info?token=xxx                                         |
| method   | get                                                          |
| 请求参数 | token                                                        |
| 返回参数 | ![在这里插入图片描述](后端.assets/ba6fa3f2b3604f838a02eca7819b2f3f.png) |
|          |                                                              |

controller

```java
@GetMapping("/info")
    public Result<?> getUserInfo(@RequestParam("token") String token){
        Map<String,Object> data = userService.getUserInfo(token);
        if(data != null){
            return Result.success(data);
        }
        return Result.fail(20003,"用户信息获取失败");
    }
```

service

```java

	/**
	 * 返回参数:(和前端请求响应结果对应)
	 * {
	 * 		"code": 20000,
	 *		 message": "success",
	 * 		"data": {
	 * 		"roles": [
	 * 			"admin"
	 * 		],
	 * 		"name": "admin",
	 * 		"avatar": "https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif"
	 * }
	 * **/
	@Override
	public Map<String, Object> getUserInfo(String token) {
		// 从redis查询token
		Object obj = redisTemplate.opsForValue().get(token);  //  <!-- redis -->
		// 反序列化 json对象反序列化成user对象
		XUser user = JSON.parseObject(JSON.toJSONString(obj),XUser.class);
		if(user != null){
			Map<String, Object> data =  new HashMap<>();
			data.put("name",user.getUsername());
			data.put("avatar",user.getAvatar());
			// this.getBaseMapper().调用映射文件xml中的方法
			List<String> roleList = this.getBaseMapper().getRoleNamesByUserId(user.getId());// 查角色
			data.put("roles", roleList);
			return data;
		}
		return null;
	}
```

所需依赖

```xml
 <!-- fastjson2 反序列化 -->
<dependency>
    <groupId>com.alibaba.fastjson2</groupId>
    <artifactId>fastjson2</artifactId>
    <version>2.0.26</version>
</dependency>
```

**mapper.xml**

```xml
<select id="getRoleNamesByUserId" parameterType="Integer" resultType="String">
    SELECT
    b.role_name
    FROM x_user_role a,x_role b
    WHERE a.`user_id` = #{userId}
    AND a.`role_id` = b.`role_id`
</select>
```

测试

![image-20230923114617577](后端.assets/image-20230923114617577.png)

#### 4.3 注销

需要做的就是清楚token或者Cookie, 这个案例前端把token放在请求头里

<img src="后端.assets/image-20230923115204012.png" alt="image-20230923115204012" style="zoom:67%;" />

| 接口属性 | 值                                                           |
| -------- | ------------------------------------------------------------ |
| url      | /user/logout                                                 |
| method   | post                                                         |
| 请求参数 |                                                              |
| 返回参数 | ![image-20230923114723647](后端.assets/image-20230923114723647.png) |

controller

```java
@PostMapping("/logout")
public Result<?> logout(@RequestHeader("X-Token") String token){
    userService.logout(token);
    return Result.success("注销成功");
}
```

service

```java
public void logout(String token) {
    redisTemplate.delete(token);
}
```

测试

![image-20230923115748625](后端.assets/image-20230923115748625.png)

![image-20230923115811121](后端.assets/image-20230923115811121.png)

### 5. 前后端对接

登录为例

+ 前端的请求url: http://localhost:8888/dev-api/vue-admin-template/user/login

  ![image-20230923120144083](后端.assets/image-20230923120144083.png)

+ 后端的请求url:   http://localhost:9999/user/login

解决

修改前端对接后端接口api文件夹下

```js
import request from '@/utils/request'

export function login(data) {
  return request({
    url: '/user/login',  //修改
    method: 'post',
    data
  })
}

export function getInfo(token) {
  return request({
    url: '/user/info',  //修改
    method: 'get',
    params: { token }
  })
}

export function logout() {
  return request({
    url: '/user/logout',  //修改
    method: 'post'
  })
}

```

.development文件

```
# just a flag
ENV = 'development'

# base api
VUE_APP_BASE_API = 'http://localhost:9999'   //修改成后端的地址
```

### 6. 跨域处理

有很多方法,可以在前端处理也可以在后端处理

```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter(){
        //1.添加CORS配置信息
        CorsConfiguration config = new CorsConfiguration();
        //1) 允许的域,不要写*，否则cookie就无法使用了
        config.addAllowedOrigin("http://localhost:8888"); //这里填写请求的前端服务器
        //2) 是否发送Cookie信息
        config.setAllowCredentials(true);
        //3) 允许的请求方式
        config.addAllowedMethod("OPTIONS");
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        // 4）允许的头信息
        config.addAllowedHeader("*");

        //2.添加映射路径，我们拦截一切请求
        UrlBasedCorsConfigurationSource configSource = new UrlBasedCorsConfigurationSource();
        configSource.registerCorsConfiguration("/**", config);

        //3.返回新的CorsFilter.
        return new CorsFilter(configSource);
    }
}

```

测试, 前后端对接成功

![image-20230923151627978](后端.assets/image-20230923151627978.png)





### 7. 用户管理接口

| 接口           | 说明     |
| -------------- | -------- |
| 查询用户列表   | 分页查询 |
| 新增用户       |          |
| 根据id查询用户 |          |
| 修改用户       |          |
| 删除用户       | 逻辑删除 |

#### 7.1 查询用户列表

<img src="后端.assets/image-20230925091914169.png" alt="image-20230925091914169" style="zoom:80%;" />

![image-20230925141647957](后端.assets/image-20230925141647957.png)

![image-20230924172738582](后端.assets/image-20230924172738582.png)

1. controller

   ```java
   
   	@GetMapping("/user/list")
   	public Result<?> getUserListPage(@RequestParam(value = "username", required = false) String username,
   									 @RequestParam(value = "phone", required = false) String phone,
   									 @RequestParam("pageNo") Long pageNo,
   									 @RequestParam("pageSize") Long pageSize) {
   		LambdaQueryWrapper<XUser> wrapper = new LambdaQueryWrapper();
   		//等价wrapper.eq(username != null, XUser::getUsername, username);
   		wrapper.eq(StringUtils.hasLength(username), XUser::getUsername, username);
   		wrapper.eq(phone != null, XUser::getPhone, phone);
   		wrapper.orderByDesc(XUser::getId);
   		// 分页
   		Page<XUser> page = new Page<>(pageNo, pageSize);
   		xUserService.page(page, wrapper);
   
   		Map<String, Object> data = new HashMap<>();
   		data.put("total", page.getTotal());   //page.getTotal()得添加配置,具体见官网
   		data.put("rows", page.getRecords());  //结果集
   
   		return Result.success(data);
   		/**data数据:
   		 * {
   		 *     "code": 20000,
   		 *     "message": "success",
   		 *     "data": {
   		 *         "total": 6,
   		 *         "rows": [
   		 *             {
   		 *                 "id": 1,
   		 *                 "username": "admin",
   		 *                 "password": "123456",
   		 *                 "email": "super@aliyun.com",
   		 *                 "phone": "18677778888",
   		 *                 "status": 1,
   		 *                 "avatar": "https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif",
   		 *                 "deleted": 0
   		 *             }
   		 *         ]
   		 *     }
   		 * }
   		 * **/
   	}
   ```

   

2. 官网[分页插件 | MyBatis-Plus (baomidou.com)](https://baomidou.com/pages/97710a/#支持的数据库)分页插件:       

   ![image-20230923173255126](后端.assets/image-20230923173255126.png)

   分页拦截器

   ```java
   @Configuration
   public class MpConfig {
       @Bean
       public MybatisPlusInterceptor mybatisPlusInterceptor() {
           MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
           interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
           return interceptor;
       }
   }
   ```

#### 7.2 新增用户

**表单传递时,用数据实体对象接受时一定要用相同的属性名**

![image-20230928114340526](后端.assets/image-20230928114340526.png)

<img src="后端.assets/image-20230925091931144.png" alt="image-20230925091931144" style="zoom:80%;" />

![image-20230924190350184](后端.assets/image-20230924190350184.png)

![image-20230924190524778](后端.assets/image-20230924190524778.png)

```java

	//RequestBod接受前端数据(如json)
	@PostMapping("/user/add")
	public Result<?> addUser(@RequestBody XUser user) {
//		log.info(user.toString());
		// 用户密码加密
		user.setPassword(passwordEncoder.encode(user.getPassword()));
		xUserService.save(user);
		return Result.success("新增用户成功");
	}
```

密码加密处理，用BCryptPasswordEncoder，涉及登录逻辑改动

```
<dependency>
<groupId>org.springframework.security</groupId>
<artifactId>spring-security-core</artifactId>
<version>6.0.2</version>
</dependency>
```

```java
package com.lfj;

import io.micrometer.common.util.StringUtils;
import lombok.extern.slf4j.Slf4j;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.core.env.Environment;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.lang.management.ManagementFactory;
import java.net.InetAddress;
import java.net.UnknownHostException;

@Slf4j
@MapperScan("com.lfj.mapper")   //添加扫描
@SpringBootApplication
public class SpringBackEndApplication {

	public static void main(String[] args) {
		ConfigurableApplicationContext application = SpringApplication.run(SpringBackEndApplication.class, args);

	// 加密
	@Bean
	public PasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder();
	}
}

```

#### 7.3 修改用户

此处不提供密码更新，大家自行扩展，可以去实现前端右上角菜单的个人信息功能

前端

<img src="后端.assets/image-20230925092019807.png" alt="image-20230925092019807" style="zoom:80%;" />

![image-20230925092031806](后端.assets/image-20230925092031806.png)

后端

```java

	//
	@PutMapping("/user")
	public Result<?> updateUser(@RequestBody XUser user) {
		user.setPassword(null);
		xUserService.updateById(user);
		return Result.success("修改用户成功");
	}

	//
	@GetMapping("/{id}")
	public Result<XUser> getUserById(@PathVariable("id") Integer id) {
		XUser user = xUserService.getById(id);
		return Result.success(user);
	}
```



#### 7.4 删除用户

![image-20230925091603227](后端.assets/image-20230925091603227.png)

**利用MyBatisPlus做逻辑删除处理, 不建议直接删除**

```yaml
mybatis-plus:
  global-config:
    db-config:
      logic-delete-field: delete
      logic-delete-value: 1
      logic-not-delete-value: 0
```

```java
	// 删除
	@DeleteMapping("/user/{id}")
	public Result<XUser> deleteUserById(@PathVariable("id") Integer id) {
		xUserService.removeById(id);
		return Result.success("删除用户成功");
	}
```







后端错误状态码

[Error: Request failed with status code 500的错误_赫于富的博客-CSDN博客](https://blog.csdn.net/qq_30631063/article/details/105610395)



# 参数使用

```
this.$confirm(`您确认删除用户 ${user.username} ?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
          userApi.deleteUserById(user.id).then(response => {
            this.$message({
              message: response.message,
              type: "success",
            });
          this.getUserList();
```



### 一、些许优化

#### 标签栏导航   刷新丢失其它[标签页

![image-20230925092714334](后端.assets/image-20230925092714334.png)

1. **缓存已打开标签页**

   ```js
   tagsViewCache() {
       window.addEventListener("beforeunload", () => {
           let tabViews = this.visitedViews.map(item => {
               return {
                   fullPath: item.fullPath,
                   hash: item.hash,
                   meta: { ...item.meta },
                   name: item.name,
                   params: { ...item.params },
                   path: item.path,
                   query: { ...item.query },
                   title: item.title
               };
           });
           sessionStorage.setItem("tabViews", JSON.stringify(tabViews));
       });
       let oldViews = JSON.parse(sessionStorage.getItem("tabViews")) || [];
       if (oldViews.length > 0) {
           this.$store.state.tagsView.visitedViews = oldViews;
       }
   },
   ```

![在这里插入图片描述](后端.assets/83e428c9819b4b10a3fc29d93ab1c304.png)

1. **注销时删除所有tagview**

   ![image-20230925093053782](后端.assets/image-20230925093053782.png)

   ```js
   // 注销时删除所有tagview
   await this.$store.dispatch('tagsView/delAllViews')
   sessionStorage.removeItem('tabViews')
   ```

![在这里插入图片描述](后端.assets/343c54058db64b198359e4cb72fe4623.png)

### 三、Jwt整合

JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。

**jwt形式举例：**

```
eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI5MjAzOThjZi1hYThiLTQzNWUtOTIxYS1iNGQ3MDNmYmZiZGQiLCJzdWIiOiJ7XCJwaG9uZVwiOlwiMTIzNDIzNFwiLFwidXNlcm5hbWVcIjpcInpoYW5nc2FuXCJ9IiwiaXNzIjoic3lzdGVtIiwiaWF0IjoxNjc3MTE4Njc2LCJleHAiOjE2NzcxMjA0NzZ9.acc7H6-6ACqcgNu5waqain7th7zJciP-41z-qgWeaSY
```

#### ⑴ 整合步骤

1. pom

   ```xml
   <dependency>
       <groupId>io.jsonwebtoken</groupId>
       <artifactId>jjwt</artifactId>
       <version>0.9.1</version>
   </dependency>
   ```

2. 工具类

   ==不用这个==

   ```java
   @Component
   public class JwtUtil {
       // 有效期
       private static final long JWT_EXPIRE = 30*60*1000L;  //半小时
       // 令牌秘钥
       private static final String JWT_KEY = "123456";
   
       public  String createToken(Object data){
           // 当前时间
           long currentTime = System.currentTimeMillis();
           // 过期时间
           long expTime = currentTime+JWT_EXPIRE;
           // 构建jwt
           JwtBuilder builder = Jwts.builder()
                   .setId(UUID.randomUUID()+"")
                   .setSubject(JSON.toJSONString(data))
                   .setIssuer("system")
                   .setIssuedAt(new Date(currentTime))
                   .signWith(SignatureAlgorithm.HS256, encodeSecret(JWT_KEY))
                   .setExpiration(new Date(expTime));
           return builder.compact();
       }
   
       private  SecretKey encodeSecret(String key){
           byte[] encode = Base64.getEncoder().encode(key.getBytes());
           SecretKeySpec aes = new SecretKeySpec(encode, 0, encode.length, "AES");
           return  aes;
       }
   
       public  Claims parseToken(String token){
           Claims body = Jwts.parser()
                   .setSigningKey(encodeSecret(JWT_KEY))
                   .parseClaimsJws(token)
                   .getBody();
           return body;
       }
   
       /**
        * 解析JWT令牌并将其主体（subject）转换为指定类型的对象。
        *
        * @param token JWT令牌字符串
        * @param clazz 要将JWT主体转换为的目标类型的类
        * @param <T>   目标类型的泛型参数
        * @return 解析后的目标类型的对象
        */
       public <T> T parseToken(String token, Class<T> clazz) {
           // 解析JWT令牌
           Claims body = Jwts.parser()
                   .setSigningKey(encodeSecret(JWT_KEY))
                   .parseClaimsJws(token)
                   .getBody();
   
           // 将JWT主体转换为指定类型的对象并返回
           return JSON.parseObject(body.getSubject(), clazz);
       }
   
   }
   ```

3. 测试工具类

   ```java
   	public void testCreateJwt() {
   		XUser user = new XUser();
   		user.setUsername("miaowing");
   		user.setPassword("1111");
   
   		String token = JwtUtil.createJWT(JSON.toJSONString(user));
   		System.out.println(token);
   	}
   
   	@Test
   	public void testParseJwt2() {
   		String token = "";
   		XUser user = jwtUtil.parseToken(token, XUser.class);
   		System.out.println(user);
   	}
   ```

4. 修改登录逻辑
   ![在这里插入图片描述](后端.assets/6f46c77e51894747b3857fe5b9df00ea.png)
   ![在这里插入图片描述](后端.assets/2359a20352f34a4987dbdde4bfef1c61.png)

   ```java
   package com.lfj.service.impl;
   
   import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
   import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
   import com.lfj.entity.XUser;
   import com.lfj.mapper.XUserMapper;
   import com.lfj.service.XUserService;
   import com.lfj.util.JwtUtil;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.data.redis.core.RedisTemplate;
   import org.springframework.security.crypto.password.PasswordEncoder;
   import org.springframework.stereotype.Service;
   
   import java.util.HashMap;
   import java.util.List;
   import java.util.Map;
   
   /**
    * @author 16658
    * @description 针对表【x_user】的数据库操作Service实现
    * @createDate 2023-09-22 21:13:25
    */
   @Service
   public class XUserServiceImpl extends ServiceImpl<XUserMapper, XUser>
   		implements XUserService {
   
   	@Autowired
   	private RedisTemplate redisTemplate;
   
   	@Autowired
   	JwtUtil jwtUtil;
   
   	@Autowired
   	private PasswordEncoder passwordEncoder;
   
   	@Override
   	public Map<String, Object> login(XUser user) {
   		//根据用户名和密码查询
   		LambdaQueryWrapper<XUser> wrapper = new LambdaQueryWrapper<>();
   		wrapper.eq(XUser::getUsername, user.getUsername());
   		//wrapper.eq(XUser::getPassword,user.getPassword());
   		XUser loginUser = this.baseMapper.selectOne(wrapper);
   		//结果不为空,并且密码和传入密码匹配，则生成token,并将用户信息存入redis
   
   		if ((loginUser != null && passwordEncoder.matches(user.getPassword(), loginUser.getPassword()))) {
   			/**  简单方式
   			 // 暂时用UUID，终极方案是jwt
   			 String key = "user:" + UUID.randomUUID();
   			 loginUser.setPassword(null);
   
   			 // 存入redis
   			 loginUser.setPassword(null); //密码不存
   			 redisTemplate.opsForValue().set(key, loginUser, 30, TimeUnit.MINUTES);// 传入了XUser对象
   			 // 返回数据
   			 Map<String, Object> data = new HashMap<>();
   			 data.put("token", key);
   			 return data;
   			 **/
   			/*
   			 * 使用jwt
   			 * */
   			loginUser.setPassword(null); //密码不存
   			String jwt = jwtUtil.Token(loginUser);  // 传入了XUser对象
   			//返回数据
   			Map<String, Object> data = new HashMap<>();
   			data.put("token", jwt);
   			return data;
   
   		}
   		return null;
   	}
   
   	/**
   	 * 返回参数:(和前端请求响应结果对应)
   	 * {
   	 * "code": 20000,
   	 * message": "success",
   	 * "data": {
   	 * "roles": [
   	 * "admin"
   	 * ],
   	 * "name": "admin",
   	 * "avatar": "https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif"
   	 * }
   	 **/
   	@Override
   	public Map<String, Object> getUserInfo(String token) {
   		/** 简单方式
   		 // 从redis查询token
   		 Object obj = redisTemplate.opsForValue().get(token);  //  redis
   		 // 反序列化 json对象反序列化成user对象
   		 XUser user = JSON.parseObject(JSON.toJSONString(obj), XUser.class);
   		 if (user != null) {
   		 Map<String, Object> data = new HashMap<>();
   		 data.put("name", user.getUsername());
   		 data.put("avatar", user.getAvatar());
   		 // this.getBaseMapper().调用映射文件xml中的方法
   		 List<String> roleList = this.getBaseMapper().getRoleNamesByUserId(user.getId());// 查角色
   		 data.put("roles", roleList);
   		 return data;
   		 }
   		 return null;
   		 **/
   
   		/**
   		 *
   		 * */
   		// 解析jwt
   		XUser loginUser = null;
   		try {
   			loginUser = jwtUtil.verify(token, XUser.class);
   		} catch (Exception e) {
   			e.printStackTrace();
   		}
   		if (loginUser != null) {
   			Map<String, Object> data = new HashMap<>();
   			data.put("name", loginUser.getUsername());
   			data.put("avatar", loginUser.getAvatar());
   			// this.getBaseMapper().调用映射文件xml中的方法
   			List<String> roleList = this.getBaseMapper().getRoleNamesByUserId(loginUser.getId());// 查角色
   			data.put("roles", roleList);
   			return data;
   		}
   		return null;
   	}
   
   	@Override
   	public void logout(String token) {
   		// 删掉redis中储存的token
   		//redisTemplate.delete(token);
   	}
   }
   ```

   

5. 测试登录

**问题思考：**

登录后续请求如何验证jwt ？

![在这里插入图片描述](后端.assets/1cb0ce6878ad48708a2cb930ae3a60e5.png)

#### ⑵ JWT验证拦截器

**定义拦截器**

```java
@Component
@Slf4j
public class JwtValidateInterceptor implements HandlerInterceptor {
    @Autowired
    private JwtUtil jwtUtil;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String token = request.getHeader("X-Token");
        //System.out.println(request.getRequestURI() +" 待验证："+token);
        if(token != null){
            try {
                jwtUtil.parseToken(token);
                log.debug(request.getRequestURI() + " 放行...");
                return true;
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        log.debug(request.getRequestURI() + " 禁止访问...");
        
        // 服务器返回
        response.setContentType("application/json;charset=utf-8");
        response.getWriter().write(JSON.toJSONString(Result.fail(20003,"jwt令牌无效，请重新登录")));
        return false;
    }
}
```

**注册拦截器**

```java
@Configuration
public class MyWebConfig implements WebMvcConfigurer {
    @Autowired
    private JwtValidateInterceptor jwtValidateInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        InterceptorRegistration registration = registry.addInterceptor(jwtValidateInterceptor);
        registration.addPathPatterns("/**") //拦截-->找自定义拦截器
                .excludePathPatterns(
                        "/user/login",
                        "/user/info",
                        "/user/logout",
                        "/error",
                        "/swagger-ui/**",             // 放行swagger
                        "/swagger-resources/**",
                        "/v3/**");
    }
}
```

### 二、Swagger整合

==Swagger-UI可以动态地根据注解生成在线API文档,   也可以调试接口功能类似postman软件==

官网:  [API Documentation & Design Tools for Teams | Swagger](https://swagger.io/)

**整合步骤：**

1. 添加依赖

   ```xml
   <!--Swagger文档工具-->
   <dependency>
       <groupId>io.springfox</groupId>
       <artifactId>springfox-boot-starter</artifactId>
       <version>3.0.0</version>
   </dependency>
   ```

2. swagger配置类

   ```java
   package com.xxx.xxx.config;
   
   @Configuration
   @EnableOpenApi
   @EnableWebMvc
   public class SwaggerConfig {
       @Bean
       public Docket api() {
           return new Docket(DocumentationType.OAS_30)
                   .apiInfo(apiInfo())
                   .select()
                   .apis(RequestHandlerSelectors.basePackage("com.lantu"))
                   .paths(PathSelectors.any())
                   .build();
       }
   
       private ApiInfo apiInfo() {
           return new ApiInfoBuilder()
                   .title("神盾局特工管理系统接口文档")
                   .description("全网最简单的SpringBoot+Vue前后端分离项目实战")
                   .version("1.0")
                   .contact(new Contact("qqcn", "http://www.qqcn.cn", "qqcn@aliyun.com"))
                   .build();
       }
   }
   ```

3. 控制器根据需要添加swagger注解

   **常用注解**

   - @Api：用于修饰Controller类，生成Controller相关文档信息
   - @ApiOperation：用于修饰Controller类中的方法，生成接口方法相关文档信息
   - @ApiParam：用于修饰接口中的参数，生成接口参数相关文档信息
   - @ApiModelProperty：用于修饰实体类的属性，当实体类是请求参数或返回结果时，直接生成相关文档信息

4. 测试：http://localhost:9999/swagger-ui/index.html

   ![image-20230926114306888](后端.assets/image-20230926114306888.png)

#### Swagger授权token配置

```java
package com.xxx.xxx.config;

import io.swagger.v3.oas.models.security.SecurityScheme;

@Configuration
@EnableOpenApi
@EnableWebMvc
public class SwaggerConfig {
    @Bean
    public Docket api() {
        return new Docket(DocumentationType.OAS_30)
                .apiInfo(apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.lantu"))  //包名
                .paths(PathSelectors.any())
                .build()
                .securitySchemes(Collections.singletonList(securityScheme()))
                .securityContexts(Collections.singletonList(securityContext()));
    }

    private SecurityScheme securityScheme() {
        //return new ApiKey("Authorization", "Authorization", "header");
        return new ApiKey("X-Token", "X-Token", "header"); // token数据
    }

    private SecurityContext securityContext() {
        return SecurityContext.builder()
                .securityReferences(defaultAuth())
                .forPaths(PathSelectors.regex("^(?!auth).*$"))
                .build();
    }

    private List<SecurityReference> defaultAuth() {
        AuthorizationScope authorizationScope = new AuthorizationScope("global", "accessEverything");
        AuthorizationScope[] authorizationScopes = new AuthorizationScope[1];
        authorizationScopes[0] = authorizationScope;
        return Collections.singletonList(
                new SecurityReference("X-Token", authorizationScopes));
    }

     /**
     * API 页面上半部分展示信息
     */
    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("神盾局特工管理系统接口文档")
                .description("全网最简单的SpringBoot+Vue前后端分离项目实战")
                .version("1.0")
                .contact(new Contact("老蔡", "https://space.bilibili.com/431588578", "xxxx@aliyun.com"))
                .build();
    }
}
```

### 四、角色管理

#### 1. 基本功能

##### ⑴ 预览效果

![在这里插入图片描述](后端.assets/6eafcea2d01346ed9b3f5d9174992372.png)

##### ⑵ 前端

role.vue

```vue
<template>
  <div>
    <!-- 搜索栏 -->
    <el-card id="search">
      <el-row>
        <el-col :span="18">
          <el-input placeholder="角色名" v-model="searchModel.roleName" clearable> </el-input>
          <el-button @click="getRoleList" type="primary" icon="el-icon-search" round>查询</el-button>
        </el-col>
        <el-col :span="6" align="right">
          <el-button @click="openEditUI(null)" type="primary" icon="el-icon-plus" circle></el-button>
        </el-col>
      </el-row>
    </el-card>

    <!-- 结果列表 -->
    <el-card>
 
        <el-table :data="roleList" stripe style="width: 100%">
          <el-table-column label="#" width="80">
            <template slot-scope="scope">
              {{(searchModel.pageNo-1) * searchModel.pageSize + scope.$index + 1}}
            </template>
          </el-table-column>
          <el-table-column prop="roleId" label="角色编号" width="180">
          </el-table-column>
          <el-table-column prop="roleName" label="角色名称" width="180">
          </el-table-column>
          <el-table-column prop="roleDesc" label="角色描述" >
          </el-table-column>
          <el-table-column   label="操作" width="180">
            <template slot-scope="scope">
              <el-button @click="openEditUI(scope.row.roleId)" type="primary" icon="el-icon-edit" circle size="mini"></el-button>
              <el-button @click="deleteRole(scope.row)" type="danger" icon="el-icon-delete" circle size="mini"></el-button>
            </template>
          </el-table-column>
        </el-table> 
 
    </el-card>
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="searchModel.pageNo"
      :page-sizes="[5, 10, 20, 50]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="total">
    </el-pagination>

    <!-- 对话框 -->
    <el-dialog @close="clearForm" :title="title" :visible.sync="dialogFormVisible" :close-on-click-modal="false">
      <el-form :model="roleForm" ref="roleFormRef" :rules="rules">
        <el-form-item prop="roleName" label="角色名称" :label-width="formLabelWidth">
          <el-input v-model="roleForm.roleName" autocomplete="off"></el-input>
        </el-form-item>
        
        <el-form-item prop="roleDesc" label="角色描述" :label-width="formLabelWidth">
          <el-input v-model="roleForm.roleDesc" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="saveRole">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>


<script>
import roleApi from '@/api/roleManage'
export default {
  data(){
    
    return{
      formLabelWidth: '130px',
      roleForm: {},
      dialogFormVisible: false,
      title: '',
      searchModel: {
        pageNo: 1,
        pageSize: 10
      },
      roleList: [],
      total: 0,
      rules:{
        roleName: [
          { required: true, message: '请输入角色名称', trigger: 'blur' },
          { min: 3, max: 50, message: '长度在 3 到 50 个字符', trigger: 'blur' }
        ]
      }
    }
  },
  methods:{
    deleteRole(role){
      this.$confirm(`您确定删除角色 ${role.roleName} ？`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
      }).then(() => {
        roleApi.deleteRoleById(role.roleId).then(response => {
          this.$message({
            type: 'success',
            message: response.message
          });
          this.dialogFormVisible = false;
          this.getRoleList();
        });
        
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        });          
      });
    },
    saveRole(){
      // 触发表单验证
      this.$refs.roleFormRef.validate((valid) => {
        if (valid) {
          // 提交保存请求
          roleApi.saveRole(this.roleForm).then(response => {
            // 成功提示
            this.$message({
              message: response.message,
              type: 'success'
            });
            // 关闭对话框
            this.dialogFormVisible = false;
            // 刷新表格数据
            this.getRoleList();
          });
          
        } else {
          console.log('error submit!!');
          return false;
        }
      });
      
    },
    clearForm(){
      this.roleForm = {};
      this.$refs.roleFormRef.clearValidate();
    },
    openEditUI(id){
      if(id == null){
        this.title = '新增角色';
      }else{
        this.title = '修改角色';
        roleApi.getRoleById(id).then(response => {
          this.roleForm = response.data;
        });
      }
      this.dialogFormVisible = true;
    },
    handleSizeChange(pageSize){
      this.searchModel.pageSize = pageSize;
      this.getRoleList();
    },
    handleCurrentChange(pageNo){
      this.searchModel.pageNo = pageNo;
      this.getRoleList();
    },
    getRoleList(){
      roleApi.getRoleList(this.searchModel).then(response => {
        this.roleList = response.data.rows;
        this.total = response.data.total;
      });
    }
  },
  created(){
    this.getRoleList();
  }
};
</script>

<style>
#search .el-input {
  width: 200px;
  margin-right: 10px;
}
.el-dialog .el-input{
  width: 85%;
}
</style>
```

roleManage.js

```js
import request from '@/utils/request'

export default{
  // 分页查询角色列表
  getRoleList(searchModel){
    return request({
      url: '/role/list',
      method: 'get',
      params: {
        roleName: searchModel.roleName,
        pageNo: searchModel.pageNo,
        pageSize: searchModel.pageSize
      }
    });
  },
  // 新增
  addRole(role){
    return request({
      url: '/role',
      method: 'post',
      data: role
    });
  },
  // 修改
  updateRole(role){
    return request({
      url: '/role',
      method: 'put',
      data: role
    });
  },
  // 保存角色数据
  saveRole(role){
    if(role.roleId == null || role.roleId == undefined){
      return this.addRole(role);
    }
    return this.updateRole(role);
  },
  // 根据id查询
  getRoleById(id){
    return request({
      url: `/role/${id}`,
      method: 'get'
    });
  },
  // 根据id删除
  deleteRoleById(id){
    return request({
      url: `/role/${id}`,
      method: 'delete'
    });
  },

}
```

##### ⑶ 后端

RoleController

```java
@RestController
@RequestMapping("/role")
public class RoleController {

    @Autowired
    private IRoleService roleService;

    @GetMapping("/list")
    public Result<Map<String,Object>> getUserList(@RequestParam(value = "roleName",required = false) String roleName,
                                                  @RequestParam(value = "pageNo") Long pageNo,
                                                  @RequestParam(value = "pageSize") Long pageSize){
        LambdaQueryWrapper<Role> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(StringUtils.hasLength(roleName),Role::getRoleName,roleName);
        wrapper.orderByDesc(Role::getRoleId);

        Page<Role> page = new Page<>(pageNo,pageSize);
        roleService.page(page, wrapper);

        Map<String,Object> data = new HashMap<>();
        data.put("total",page.getTotal());
        data.put("rows",page.getRecords());

        return Result.success(data);

    }

    @PostMapping
    public Result<?> addRole(@RequestBody Role role){
        roleService.save(role);
        return Result.success("新增角色成功");
    }

    @PutMapping
    public Result<?> updateRole(@RequestBody Role role){
        roleService.updateById(role);
        return Result.success("修改角色成功");
    }

    @GetMapping("/{id}")
    public Result<Role> getRoleById(@PathVariable("id") Integer id){
        Role role = roleService.getById(id);
        return Result.success(role);
    }

    @DeleteMapping("/{id}")
    public Result<Role> deleteRoleById(@PathVariable("id") Integer id){
        roleService.removeById(id);
        return Result.success("删除角色成功");
    }

}
```

#### 2. 角色权限设置显示

![在这里插入图片描述](后端.assets/17d346725b46461885a21d86ea139703.png)

##### ⑴ 前端

menuManage.js

```js
import request from '@/utils/request'

export default{
  // 查询所有菜单数据
  getAllMenu(){
    return request({
      url: '/menu',
      method: 'get',
    });
  },
}
1234567891011
```

role.vue

```html
<el-form-item
              prop="roleDesc"
              label="权限设置"
              :label-width="formLabelWidth"
              >
    <el-tree
             :data="menuList"
             :props="menuProps"
             node-key="menuId"
             show-checkbox
             style="width:85%"
             default-expand-all
             ></el-tree>
</el-form-item>
1234567891011121314
```

![在这里插入图片描述](后端.assets/1255434bba8b4b199c2bcdee7c73fb72.png)
![在这里插入图片描述](后端.assets/4fb947b83eb448d389c439a8b1862f87.png)

##### ⑵ 数据库

x_menu表新增数据

```sql
delete from x_menu;
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('1','Layout','/sys','/sys/user','sysManage','系统管理','userManage','0','N','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('2','sys/user','user',NULL,'userList','用户列表','user','1','Y','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('3','sys/role','role',NULL,'roleList','角色列表','roleManage','1','Y','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('4','Layout','/test','/test/test1','test','功能测试','form','0','N','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('5','test/test1','test1','','test1','测试点一','form','4','Y','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('6','test/test2','test2','','test2','测试点二','form','4','Y','0');
insert into `x_menu` (`menu_id`, `component`, `path`, `redirect`, `name`, `title`, `icon`, `parent_id`, `is_leaf`, `hidden`) values('7','test/test3','test3','','test3','测试点三','form','4','Y','0');
12345678
```

##### ⑶ 后端

Menu类中新增

```java
@TableField(exist = false)
@JsonInclude(JsonInclude.Include.NON_EMPTY)
private List<Menu> children;

@TableField(exist = false)
private Map<String,Object> meta = new HashMap<>();
public Map<String,Object> getMeta(){
    meta.put("title",this.title);
    meta.put("icon",this.icon);
    return this.meta;
}
1234567891011
```

MenuController

```java
@RestController
@RequestMapping("/menu")
public class MenuController {
    @Autowired
    private IMenuService menuService;

    @GetMapping
    public Result<?> getAllMenu(){
        List<Menu> menuList =  menuService.getAllMenu();
        return Result.success(menuList);
    }

}
12345678910111213
```

MenuSeviceImpl

```java
@Override
public List<Menu> getAllMenu() {
    // 一级菜单
    LambdaQueryWrapper<Menu> wrapper = new LambdaQueryWrapper();
    wrapper.eq(Menu::getParentId,0);
    List<Menu> menuList = this.list(wrapper);
    // 子菜单
    setMenuChildren(menuList);
    return menuList;
}

private void setMenuChildren(List<Menu> menuList) {
    if(menuList != null) {
        for (Menu menu:menuList) {
            LambdaQueryWrapper<Menu> subWrapper = new LambdaQueryWrapper();
            subWrapper.eq(Menu::getParentId, menu.getMenuId());
            List<Menu> subMenuList = this.list(subWrapper);
            menu.setChildren(subMenuList);
            // 递归
            setMenuChildren(subMenuList);
        }
    }
}
1234567891011121314151617181920212223
```

#### 3. 角色权限新增提交

##### ⑴ 前端

![在这里插入图片描述](后端.assets/db67fc17fe064ba4ae740f4940da8546.png)

##### ⑵ 后端

![在这里插入图片描述](后端.assets/dd7f1870caa44fbd997291696f02a60f.png)

#### 4. 角色权限回显

##### ⑴ 前端

![在这里插入图片描述](后端.assets/62bb59d0da5c4c3e8733450c043f5e06.png)

##### ⑵ 后端

![在这里插入图片描述](后端.assets/c7eae2b2371b48e68855209ac62b3649.png)

RoleMenuMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lantu.sys.mapper.RoleMenuMapper">
    <select id="getMenuIdListByRoleId" parameterType="Integer" resultType="Integer">
        select
            a.`menu_id`
        from x_role_menu a, x_menu b
        where a.`menu_id` = b.`menu_id`
          and b.`is_leaf` = 'Y'
          and a.`role_id` = #{roleId}
    </select>
</mapper>
123456789101112
```

#### 5. 角色权限修改提交

##### ⑴ 后端

RoleServiceImpl新增

```java
@Override
@Transactional
public void updateRole(Role role) {
    // 更新role表
    this.updateById(role);
    // 清除原有权限
    LambdaQueryWrapper<RoleMenu> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(RoleMenu::getRoleId,role.getRoleId());
    roleMenuMapper.delete(wrapper);
    //新增权限
    for (Integer menuId : role.getMenuIdList()) {
        roleMenuMapper.insert(new RoleMenu(null,role.getRoleId(),menuId));
    }
}
1234567891011121314
```

#### 6. 角色删除时删相关权限

##### ⑴ 后端

![在这里插入图片描述](后端.assets/6a82623b37e541688535d84bdd6d6fc7.png)

### 五、用户角色设置

#### 1. 角色展示

##### ⑴ 前端

roleManage.js

```js
// 查询所有角色列表
getAllRole(){
    return request({
        url: '/role/all',
        method: 'get'
    });
},
1234567
```

user.vue
![在这里插入图片描述](后端.assets/ef880d1f9d044f208c4d7eb701f78d55.png)
![在这里插入图片描述](后端.assets/01ec18ace20642ec8e1bee5775600c3e.png)

##### ⑵ 后端

RoleController

![在这里插入图片描述](后端.assets/4be372d0af7f451a93a952f374233f56.png)

#### 2. 新增用户时提交角色

##### ⑴ 后端

![在这里插入图片描述](后端.assets/751ae85448da496b8a8b13583a6fa351.png)

UserServiceImpl
![在这里插入图片描述](后端.assets/046fffebe9e442bcac4b1bb5caa68b77.png)

#### 3. 角色回显

##### ⑴ 后端

UserServiceImpl
![在这里插入图片描述](后端.assets/4648401920294a7582a99f0a48ba1ac0.png)

#### 4. 修改用户时提交角色

##### ⑴ 后端

UserServiceImpl
![在这里插入图片描述](后端.assets/138d3bf618c14cbf8255b9e9d6e6c340.png)

#### 5. 用户删除时删相关角色

##### ⑴ 后端

UserServiceImpl
![在这里插入图片描述](后端.assets/df335f5768ad40578eb286a6bb0e96a5.png)

### 六、动态路由

不同用户权限不同,不同权限界面显示的菜单不同

#### 1. 根据用户查询菜单

##### ⑴ 后端

MenuMapper.xml

```xml
<select id="getMenuListByUserId" resultType="Menu">
    SELECT *
    FROM x_menu a,
    x_role_menu b,
    x_user_role c
    WHERE a.`menu_id` = b.`menu_id`
    AND b.`role_id` = c.`role_id`
    AND a.`parent_id` = #{pid}
    AND c.`user_id` = #{userId}
</select>
12345678910
```

yml

```yaml
type-aliases-package: com.lantu.*.entity
1
```

MenuMapper.java

```java
public interface MenuMapper extends BaseMapper<Menu> {
    public List<Menu> getMenuListByUserId(@Param("userId") Integer userId,
                                          @Param("pid") Integer pid);
}
```

--------

MenuServiceImpl

```java
@Override
    public List<Menu> getMenuListByUserId(Integer userId) {
        // 一级菜单
        List<Menu> menuList = this.getBaseMapper().getMenuListByUserId(userId, 0);
        // 子菜单
        setMenuChildrenByUserId(userId, menuList);
        return menuList;
    }

    private void setMenuChildrenByUserId(Integer userId, List<Menu> menuList) {
        if (menuList != null) {
            for (Menu menu : menuList) {
                List<Menu> subMenuList = this.getBaseMapper().getMenuListByUserId(userId, menu.getMenuId());
                menu.setChildren(subMenuList);
                // 递归
                setMenuChildrenByUserId(userId,subMenuList);
            }
        }
    }
```

通过user/info接口返回数据

**UserServiceImpl**

![在这里插入图片描述](后端.assets/54d588a94cbe4aa994738c9b71ff5e42.png)

#### 2. 前端动态路由处理

原始Router:

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard'}
    }]
  },

  {
    path: '/sys',
    component: Layout,
    redirect: '/sys/user', //重定向
    name: 'sys',
    meta: { title: '系统管理', icon: 'sys' }, //标题,图标
    children: [
      {
          // 二级菜单
        path: 'user',
        name: 'user',
        component: () => import('@/views/sys/user'), // 组件
        meta: { title: '用户管理', icon: 'userManage' }
      },
      {
        path: 'role',
        name: 'role',
        component: () => import('@/views/sys/role'),
        meta: { title: '角色管理', icon: 'roleManage' }
      }
    ]
  },

  {
    path: '/test',
    component: Layout,
    redirect: '/test/test1',
    name: 'test',
    meta: { title: '功能测试', icon: 'form' },
    children: [
      {
        path: 'test1',
        name: 'test1',
        component: () => import('@/views/test/test1'),
        meta: { title: '测试点一', icon: 'form' }
      },
      {
        path: 'test2',
        name: 'test2',
        component: () => import('@/views/test/test2'),
        meta: { title: '测试点二', icon: 'form' }
      },
      {
        path: 'test3',
        name: 'test3',
        component: () => import('@/views/test/test3'),
        meta: { title: '测试点三', icon: 'form' }
      }
    ]
  },
  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router
```



##### ⑴ 修改原路由配置

src\router\index.js，**保留基础路由**，其它的删掉或注释

```js
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },
  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },
  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard', affix:true ,noCache: false}
    }]
  },  
]
```

##### ⑵ 获取菜单数据并保存至Vuex

src\store\modules\user.js

![在这里插入图片描述](后端.assets/4e2a41048416462b8b2430d7e7a79f12.png)

**src\store\getters.js**

![在这里插入图片描述](后端.assets/ad655edae0114064aa3c1821903b4132.png)

##### ⑶ 路由转换

**修改src目录下的permission.js**

![image-20230928122026227](后端.assets/image-20230928122026227.png)



![在这里插入图片描述](后端.assets/2ce1ad9b64804bfeb4af1282ca15ec60.png)
![在这里插入图片描述](后端.assets/84f2fe296a1547a8ac040a9d06f958f1.png)

```js
import Layout from '@/layout'


// 路由转换
let myRoutes = myFilterAsyncRoutes(store.getters.menuList);
// 404
myRoutes.push({
    path: '*',
    redirect: '/404',
    hidden: true
});
// 动态添加路由
router.addRoutes(myRoutes);
// 存至全局变量
global.myRoutes = myRoutes;

next({...to,replace:true})  // 防止刷新后页面空白


function myFilterAsyncRoutes(menuList) {
  menuList.filter(menu => {
      //处理component字段
    if (menu.component === 'Layout') {
      menu.component = Layout
      console.log(menu.component);
    } else {
      menu.component = require(`@/views/${menu.component}.vue`).default
    }
    // 递归处理子菜单
    if (menu.children && menu.children.length) {
      menu.children = myFilterAsyncRoutes(menu.children)
    }
    return true
  })
  return menuList;
}
```

##### ⑷ 路由合并

**src\layout\components\Sidebar\index.vue**

相当于在拼接

![在这里插入图片描述](后端.assets/6ea3f4e05bfc40a2840085342b54e286.png)

测试预期结果，不同角色的用户登录后展示的菜单列表不一样。

