# å¼€é€šé˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ä¸è´­ä¹°çŸ­ä¿¡å¥—é¤åŒ…

![image-20230331154839943](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/c3e7dc534ab200b705c3ff3cce6619f7.png)

![image-20230401111543364](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/2878c914aa843f1cb4b4a607d17c4736.png)

# ç”¨æˆ·ä¸ç”¨æˆ·ç»„æƒé™ç®¡ç†

## è¿›å…¥ç®¡ç†æ§åˆ¶å°

![image-20230331152837165](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/abf33c22a810b8b7b28a511113e19c3d.png)

![image-20230331152901010](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/77cb73adc41dd38ac51c820507132fb7.png)

### 4.2 åˆ›å»ºç”¨æˆ·ç»„

![image-20230331153047987](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/7905a748ab026f1eed5fb53d88c9b25b.png)

![image-20230331153402484](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/280d92aac0981343e4d72b40482e445b.png)

### 4.3 åˆ›å»ºå­ç”¨æˆ·

![image-20230331153601832](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/4d879e2a5d15228086affd395a63e7a9.png)

![image-20230331153708643](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/7991568fd0705894b4f1e4b9d44f3064.png)

![image-20230331153849515](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/fb0cd6402fbd833fd5c3003c048e4263.png)

æ³¨æ„è¿™ä¸ª `AccessKey ID` å’Œ `AccessKey Secret` ä¸€å®šè¦ä¿å­˜ä¸‹æ¥ï¼Œåé¢éœ€è¦ä½¿ç”¨å¹¶ä¸”å…³é—­è¯¥é¡µé¢åæ— æ³•å†è·å– `AccessKey Secret`ã€‚

### 4.4 æ·»åŠ å­ç”¨æˆ·åˆ°ç”¨æˆ·ç»„

![image-20230331153945921](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/d8e56aa92439e717f84786ab19221643.png)

![image-20230331154033934](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/4bf09e5b85be9f33800708a75a537d54.png)

### 4.5 ç”¨æˆ·ç»„æƒé™ç®¡ç†

æˆ‘ä»¬åœ¨è¿™é‡Œåªæ·»åŠ  **çŸ­ä¿¡æœåŠ¡** çš„æƒé™ã€‚

![image-20230331154245277](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/9b0fa3a4e1b6626773085cff69a5dad2.png)

## æ·»åŠ ç­¾å

> å‰ææ¡ä»¶ï¼š
>
> - å®Œæˆ[é˜¿é‡Œäº‘è´¦å·æ³¨å†Œ](https://account.aliyun.com/register/register.htm?spm=a2c45.11132027.495613.5.57577fec5LicwM)å’Œ[å®åè®¤è¯](https://account.console.aliyun.com/#/auth/home)ã€‚
> - å¼€é€šçŸ­ä¿¡æœåŠ¡ã€‚

è¿™é‡Œä»¥ç­¾åæ¥æºä¸º`æµ‹è¯•æˆ–å­¦ä¹ `è¿›è¡Œæ¼”ç¤ºï¼Œå¹¶æ³¨æ„ ä¸ªäººè®¤è¯ç”¨æˆ·é™ç”³è¯·ä¸€ä¸ªéªŒè¯ç ç­¾åï¼Œä¸€ä¸ªè‡ªç„¶æ—¥åªèƒ½ç”³è¯·ä¸€ä¸ªé€šç”¨ç­¾åã€‚å¦‚éœ€ç”³è¯·å¤šä¸ªç­¾åï¼Œå»ºè®®å‡çº§ä¸ºä¼ä¸šè®¤è¯ç”¨æˆ·ã€‚

![image-20230401105626656](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/a0de15263239a0d9ad9c8d983fe2db1f.png)

![image-20230401110030266](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/f35cfce4067b996fc2e4632934548219.png)

é€šç€è¿™ä¸ªéœ€è¦ä¸¤ä¸‰å°æ—¶å·¦å³ï¼Œå› æ­¤ç­‰è¿™ä¸€æ­¥è¢«é€šè¿‡äº†å†è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚

![image-20230401150955641](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/e975b6de6dc6f4697cee8002d875297d.png)

## æ·»åŠ æ¨¡æ¿

![image-20230401110325545](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/650d66ac767813ed5b83ddb492b06d9b.png)

![image-20230401110514087](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/72b1356d3bc7c938e79c4327380236a1.png)



è§„èŒƒ:[çŸ­ä¿¡ç­¾åæ¥æº_çŸ­ä¿¡æœåŠ¡(SMS)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ (aliyun.com)](https://help.aliyun.com/zh/sms/user-guide/signature-specifications-1)

æ¨èæ¨¡ç‰ˆå¦‚ä¸‹:  

| åº”ç”¨åœºæ™¯  | æ¨¡æ¿ç¤ºä¾‹                                                     |
| --------- | ------------------------------------------------------------ |
| ç™»å½•/éªŒè¯ | æ‚¨çš„éªŒè¯ç `${code}`ï¼Œè¯¥éªŒè¯ç 5åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¯·å‹¿æ³„æ¼äºä»–äººï¼ æ‚¨çš„éªŒè¯ç ï¼š`${code}`ï¼Œæ‚¨æ­£è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ‰“æ­»ä¸å‘Šè¯‰åˆ«äººï¼ éªŒè¯ç ä¸ºï¼š`${code}`ï¼Œæ‚¨æ­£åœ¨ç™»å½•ï¼Œè‹¥éæœ¬äººæ“ä½œï¼Œè¯·å‹¿æ³„éœ²ã€‚ |
| æ³¨å†Œ      | æ‚¨æ­£åœ¨ç”³è¯·æ‰‹æœºæ³¨å†Œï¼ŒéªŒè¯ç ä¸ºï¼š`${code}`ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼ å°Šæ•¬çš„ç”¨æˆ·ï¼Œæ‚¨çš„æ³¨å†Œä¼šå‘˜åŠ¨æ€å¯†ç ä¸ºï¼š`${code}`ï¼Œè¯·å‹¿æ³„æ¼äºä»–äººï¼ æ‚¨çš„æ³¨å†Œç ï¼š`${code}`ï¼Œå¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æœ¬çŸ­ä¿¡ï¼ æ‚¨çš„æ ¡éªŒç ï¼š`${code}`ï¼Œæ‚¨æ­£åœ¨æ³¨å†Œæˆä¸ºä¼šå‘˜ï¼Œæ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ éªŒè¯ç ä¸ºï¼š`${code}`ï¼Œæ‚¨æ­£åœ¨æ³¨å†Œæˆä¸ºå¹³å°ä¼šå‘˜ï¼Œæ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ |
| é‡ç½®å¯†ç   | æ‚¨çš„åŠ¨æ€ç ä¸ºï¼š`${code}`ï¼Œæ‚¨æ­£åœ¨è¿›è¡Œå¯†ç é‡ç½®æ“ä½œï¼Œå¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æœ¬çŸ­ä¿¡ï¼ |
| å˜æ›´ä¿¡æ¯  | éªŒè¯ç ä¸ºï¼š`${code}`ï¼Œæ‚¨æ­£åœ¨å°è¯•å˜æ›´é‡è¦ä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡è´¦æˆ·ä¿¡æ¯ã€‚ |

![image-20230401110547539](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/64868b3c23959161f1fa719b5969e4dc.png)

é€šç€è¿™ä¸ªéœ€è¦ä¸¤ä¸‰å°æ—¶å·¦å³ï¼Œå› æ­¤ç­‰è¿™ä¸€æ­¥è¢«é€šè¿‡äº†å†è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚

![image-20230401151033273](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/c2f8f250fce90456614707d57718e439.png)

## ç»‘å®šæµ‹è¯•æ‰‹æœºå·

ç”±äºæˆ‘ä»¬è¿™é‡ŒæŒ‡å®šçš„çŸ­ä¿¡ç­¾åæ¥æºæ˜¯`æµ‹è¯•æˆ–å­¦ä¹ `ï¼Œå› æ­¤åªæœ‰ç»‘å®šäº†çš„æ‰‹æœºå·æ‰èƒ½æ”¶åˆ°çŸ­ä¿¡æ¶ˆæ¯ã€‚

![image-20230401112005960](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/8873f45b1b568e6a469776f6b7d99b5f.png)

# åœ¨çº¿æµ‹è¯•ç­¾åæ¨¡æ¿API

![image-20230401151142585](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/0ac66935e38204969767a1405e0dacca.png)

![image-20230401151424352](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/746b09e75b72256cd55c3e2b433609b3.png)

![image-20230401151511620](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/21ec1462641d9188b6829b97bf91675b.png)

æŸ¥çœ‹ç»‘å®šçš„æ‰‹æœºï¼Œå¯ä»¥æ¥å—åˆ°æ¶ˆæ¯ï¼š

<img src="%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/image-20240322223818460.png" style="zoom:50%;" />

## â­å‰åç«¯å®æˆ˜å¼€å‘-å‘é€çŸ­ä¿¡éªŒè¯ç 

### æµç¨‹åˆ†æ

![image-20230401171326382](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/1b3b1d0a0f2565a7d034690da940e4bb.png)

###  é…ç½®å‚æ•°è¯´æ˜

```yaml
sms:
  ali:
    # å­ç”¨æˆ·çš„è®¿é—®é”®
    accessKeyId: LTAI5tPBmf8y7ZoQSn9h****
    # å­ç”¨æˆ·çš„è®¿é—®å¯†é’¥
    accessKeySecret: cbd511ed24bd832d05af54f64c84****
    # ç­¾ååç§°
    signName: é€æµªæ•™è‚²
    # ç™»å½•çŸ­ä¿¡æ¨¡æ¿çš„code
    loginTemplateCode: SMS_27539****
```

#### è®¿é—®é”®ä¸å¯†é’¥

å°±æ˜¯åœ¨ `4.3 åˆ›å»ºå­ç”¨æˆ·` ä¸­å¾—åˆ°çš„ accessKeyId ä¸ accessKeySecret

![image-20230401173151971](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/e9b3130309b682a3c411f64c62edb370.png)

####  ç­¾ååç§°

å°±æ˜¯åœ¨ `5.æ·»åŠ ç­¾å` ä¸­è®¾ç½®çš„ç­¾åå†…å®¹ã€‚

![image-20230401173347142](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/18a75c01b9830ef4ba02cb94dad64734.png)

####  ç™»å½•çŸ­ä¿¡æ¨¡æ¿cod

![image-20230401173455640](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/18f999ed5861bd8b869b49882fa0ae49.png)

###  ğŸš€ åç«¯ä»£ç 

å®æˆ˜demoæºç åœ°å€ï¼š

<img src="%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/image-20240323183853447.png" alt="image-20240323183853447" style="zoom: 67%;" />

å¯¹åº”çš„æ˜¯ `sms-demo` åŒ…æ¨¡å—ã€‚

ğŸ€ ç¤ºä¾‹æ¼”ç¤ºï¼Œç”¨ Apipost7 è¿›è¡Œæµ‹è¯•ï¼šã€POSTã€‘ http://127.0.0.1:10505/sms-ali/sendLoginCode

![image-20230401190641121](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/ad813301b45a9c2324863f6b6ac4ea79.png)

![image-20230401190526600](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/5407da79104153f329407d0451407a26.png)

åŒæ—¶åœ¨æˆ‘çš„æ‰‹æœºä¸Šä¹Ÿæ¥å—åˆ°äº†éªŒè¯ç æ¶ˆæ¯ã€‚

###  è¡¥å……è¯´æ˜

####  è°ƒç”¨ api åå“åº”çš„è¿”å›æ•°æ®

| åç§°      | ç±»å‹   | æè¿°                                                         | ç¤ºä¾‹                                 |
| --------- | ------ | ------------------------------------------------------------ | ------------------------------------ |
| Code      | String | è¯·æ±‚çŠ¶æ€ç ã€‚è¿”å›OKä»£è¡¨è¯·æ±‚æˆåŠŸã€‚å…¶ä»–é”™è¯¯ç ï¼Œè¯·å‚è§[APIé”™è¯¯ç ](https://help.aliyun.com/document_detail/101346.html?spm=api-workbench.API Document.0.0.5be349a5PlzN8a)ã€‚ | OK                                   |
| Message   | String | çŠ¶æ€ç çš„æè¿°ã€‚                                               | OK                                   |
| BizId     | String | å‘é€å›æ‰§IDã€‚å¯æ ¹æ®å‘é€å›æ‰§IDåœ¨æ¥å£[QuerySendDetails](https://next.api.aliyun.com/document/Dysmsapi/2017-05-25/QuerySendDetails)ä¸­æŸ¥è¯¢å…·ä½“çš„å‘é€çŠ¶æ€ã€‚ | 9006197469364984****                 |
| RequestId | String | è¯·æ±‚IDã€‚                                                     | F655A8D5-B967-440B-8683-DAD6FF8DE990 |

æ­£å¸¸è¿”å›çš„JSONæ ¼å¼ç¤ºä¾‹

```json
{
  "Code": "OK",
  "Message": "OK",
  "BizId": "9006197469364984****",
  "RequestId": "F655A8D5-B967-440B-8683-DAD6FF8DE990"
}
```

####  application.yml æ–‡ä»¶ä¸­çš„é…ç½®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚

- redis åœ°å€
- redis å¯†ç 
- çŸ­ä¿¡å¹³å°ä¿¡æ¯

####  ubuntuå®‰è£…dockerçš„æ­¥éª¤

1. å®‰è£…éœ€è¦çš„åŒ…

   ```shell
   sudo apt-get update
   ```

2. å®‰è£…ä¾èµ–åŒ…

   ```shell
   sudo apt-get install \
      apt-transport-https \
      ca-certificates \
      curl \
      gnupg-agent \
      software-properties-common
   ```

3. æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥

   ```shell
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
   ```

4. è®¾ç½®è¿œç¨‹ä»“åº“

   ```shell
   sudo add-apt-repository \
      "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
     $(lsb_release -cs) \
     stable"
   ```

5. å®‰è£… Docker-CE

   ```shell
   sudo apt-get update
   
   sudo apt-get install docker-ce docker-ce-cli containerd.io
   ```

6. éªŒè¯æ˜¯å¦æˆåŠŸ

   ```shell
   sudo docker run hello-world
   ```

####  ä½¿ç”¨ docker å®‰è£…rediså¹¶è®¾ç½®å¯†ç çš„æ­¥éª¤

```shell
# æ‹‰å–redisé•œåƒ
docker pull redis

# å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œå¹¶ä¸ºå…¶è®¾ç½®å¯†ç 
docker run -d --name myredis -p 6379:6379 redis --requirepass "123456"

```

#### 10.4.5 å…¶å®ƒæ³¨æ„äº‹é¡¹

# sprinboot æ•´åˆ

D:\PCTMoveData\Documents\GitHub\my_blog\blog\src\main\java\com\lfj\blog\common\sms

<img src="%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/image-20240323183608183.png" alt="image-20240323183608183" style="zoom:67%;" />

## é€»è¾‘

![image-20240323184940454](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/image-20240323184940454.png)

## ä¾èµ–

```xml
 <!--é˜¿é‡Œäº‘ sms sdk ä¾èµ–-->
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>alibabacloud-dysmsapi20170525</artifactId>
            <version>2.0.23</version>
        </dependency>
        <!--redisä¾èµ–-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
            <version>2.6.3</version>
        </dependency>
```

## é…ç½®æ–‡ä»¶

```yaml
# æ‰‹æœºçŸ­ä¿¡
sms:
  # çŸ­ä¿¡ç±»å‹ï¼Œ1ï¼šé˜¿é‡Œï¼Œ2ï¼šè…¾è®¯
  type: 2
  # çŸ­ä¿¡éªŒè¯ç æœ‰æ•ˆæ—¶ï¼Œå•ä½ä¸º:ç§’
  expire: 300
  # çŸ­ä¿¡åŒä¸€æ‰‹æœºå·æœ€å¤§å‘é€æ¡æ•°
  day_max: 10
  # é˜¿é‡ŒçŸ­ä¿¡é…ç½®(é˜¿é‡Œäº‘å¹³å°é‡Œçœ‹)
  ali:
    regionId: cn-hangzhou         # åœ°åŒºç¼–å·
    accessKeyId: xxxx            # å­ç”¨æˆ·çš„è®¿é—®é”®
    accessKeySecret:   xxxx      # å­ç”¨æˆ·çš„è®¿é—®å¯†é’¥
    signName: æ‚¦è¯»åšå®¢              # ç­¾ååç§°
    templateCode: SMS_465388108    # ç™»å½•çŸ­ä¿¡æ¨¡æ¿çš„code
  # è…¾è®¯çŸ­ä¿¡é…ç½®
  tencent:
    appId: 14001859
    appKey: ea4d97cdc5d23f0741b
    templateId: 608484
    signName: æ‚¦è¯»åšå®¢
```

## controller

æ³¨æ„:   å¯¹å‘é€çŸ­ä¿¡æ¥å£è¿›è¡Œredisé™æµå¤„ç† ä¾‹å¦‚

```java
@Log4j2
@RestController
@RequestMapping("/sms")
@Api(tags = "çŸ­ä¿¡éªŒè¯ç æœåŠ¡", value = "/sms")
public class SmsController {

	@Autowired
	private SmsCodeService smsCodeService;

	@Autowired
	private EmailService emailService;

	@PostMapping("/send")
	@RateLimiter(name = RedisPrefixConstant.SMS_LIMIT_NAME, max = 1, key = "#mobile", timeout = 120L, extra = "smsLimiter")
	@ApiOperation(value = "å‘é€çŸ­ä¿¡éªŒè¯ç ", notes = "éªŒè¯ç æœ‰æ•ˆæ—¶5åˆ†é’Ÿ;åŒä¸€æ‰‹æœºå·æ¯å¤©åªèƒ½å‘10æ¬¡;åŒä¸€ipæ¯å¤©åªèƒ½å‘10æ¬¡;åŒä¸€æ‰‹æœºå·é™æµ120sä¸€æ¬¡")
	public ApiResponseResult sendSmsCode(@ApiParam("æ‰‹æœºå·") @NotNull @IsPhone @RequestParam String mobile) {
		smsCodeService.sendSmsCode(mobile);
		return ApiResponseResult.success();
	}
}
```

## sms

### vo

```java
package com.lfj.blog.common.sms.vo;

import lombok.AllArgsConstructor;
import lombok.Data;

/**
 * çŸ­ä¿¡å‘é€ç»“æœ
 *
 **/
@Data
@AllArgsConstructor
public class SendResult {

	/**
	 * æ˜¯å¦å‘é€æˆåŠŸ
	 */
	private boolean success;

	/**
	 * å‘é€çš„éªŒè¯ç 
	 */
	private String code;
}
```

### config

#### ç”¨äºé…ç½®æ–‡ä»¶

```java
package com.lfj.blog.common.sms.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

@Data
@ConfigurationProperties(prefix = "sms", ignoreInvalidFields = true)
public class SmsServiceProperties {

	private final Ali ali = new Ali();
	private final Tencent tencent = new Tencent();
	private int type = 1;
	private long expire = 300L;
	private long dayMax = 10L;

	public SmsServiceProperties() {
	}

	@Data
	public static class Ali {
		private String regionId = "cn-hangzhou";
		private String accessKeyId;
		private String accessKeySecret;
		private String signName;
		private String templateCode;
	}

	@Data
	public static class Tencent {
		private String appId;
		private String appKey;
		private String templateId;
		private String signName;
	}
}

```

#### @beanæ³¨è§£ +  è‡ªåŠ¨è¯»å–é…ç½®, é€‰æ‹©ä½¿ç”¨çš„å­ç±»

```java
package com.lfj.blog.common.sms.config;

import com.lfj.blog.common.sms.service.SmsCodeService;
import com.lfj.blog.common.sms.service.impl.ali.AliSmsCodeService;
import com.lfj.blog.common.sms.service.impl.tencent.TencentSmsCodeService;
import lombok.extern.log4j.Log4j2;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * çŸ­ä¿¡éªŒè¯ç æœåŠ¡è‡ªåŠ¨é…ç½®ï¼Œé»˜è®¤é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡
 **/
@Log4j2
@Configuration
@EnableConfigurationProperties({SmsServiceProperties.class})
public class SmsAutoConfiguration {

	@Bean
	@ConditionalOnMissingBean
	public SmsCodeService smsService(SmsServiceProperties properties) {
		int type = properties.getType();
		if (type == 1) {
			return new AliSmsCodeService(properties);
		}
		return new TencentSmsCodeService(properties);
	}
}
```

æ³¨æ„:  è¿™é‡Œä½¿ç”¨@beanæ³¨å…¥,  ä¹Ÿå¯ä»¥ä½¿ç”¨@server åœ¨ä½¿ç”¨çš„æ—¶å€™é€šè¿‡@Resource("xxxxx")æŒ‡å®šè°ƒç”¨çš„å­ç±»

## server

### SmsCodeService

```java
package com.lfj.blog.common.sms.service;

/**
 * çŸ­ä¿¡æœåŠ¡
 */
public interface SmsCodeService {
	/**
	 * å‘é€çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile æ‰‹æœºå·
	 * @return
	 */
	boolean sendSmsCode(String mobile);

	/**
	 * ç¼“å­˜çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @param code
	 */
	void cacheSmsCode(String mobile, String code);

	/**
	 * æ ¡éªŒçŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @param code
	 * @return
	 */
	boolean checkSmsCode(String mobile, String code);

	/**
	 * åˆ é™¤éªŒè¯ç 
	 *
	 * @param mobile
	 * @return
	 */
	boolean deleteSmsCode(String mobile);
}
```

### BaseSmsCodeServiceImpl

```java
package com.lfj.blog.common.sms.service.impl;

import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.lfj.blog.common.constant.RedisPrefixConstant;
import com.lfj.blog.common.sms.service.SmsCodeService;
import com.lfj.blog.common.sms.vo.SendResult;
import lombok.Data;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.util.Assert;

import java.util.concurrent.TimeUnit;

@Data
public abstract class BaseSmsCodeServiceImpl implements SmsCodeService,
		InitializingBean, ApplicationContextAware {


	private ApplicationContext applicationContext; //Springçš„ApplicationContextçš„æŒæœ‰è€…,å¯ä»¥è·å–springå®¹å™¨ä¸­çš„bean
	private StringRedisTemplate redisTemplate;
	/**
	 * çŸ­ä¿¡éªŒè¯ç æœ‰æ•ˆæ—¶é—´
	 */
	private long expire = 300L;


	//ä»åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­è·å– StringRedisTemplate ç±»å‹çš„ Beanï¼Œå¹¶è¿›è¡Œå¿…è¦çš„æ ¡éªŒï¼Œç¡®ä¿è¯¥ Bean çš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§
	@Override
	public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
		if (this.applicationContext == null) {
			this.applicationContext = applicationContext;
		}
	}

	@Override
	public void afterPropertiesSet() {
		if (this.redisTemplate == null) {
			this.redisTemplate = applicationContext.getBean(StringRedisTemplate.class);
		}
		Assert.notNull(this.redisTemplate, "There is no one available StringRedisTemplate bean");
	}

	/**
	 * å‘é€çŸ­ä¿¡éªŒè¯ç ï¼Œè¿™ä¸ªæä¾›å¤–éƒ¨è°ƒç”¨çš„
	 * å‘é€çŸ­ä¿¡æˆåŠŸåç¼“å­˜çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @return
	 */
	@Override
	public boolean sendSmsCode(String mobile) {
		SendResult sendResult = handleSendSmsCode(mobile);
		String code = sendResult.getCode();
		boolean smsSuccess = sendResult.isSuccess();
		if (!StringUtils.isBlank(code) && smsSuccess) {
			cacheSmsCode(mobile, code);
			return true;
		}
		return false;
	}

	/**
	 * å‘é€çŸ­ä¿¡éªŒè¯ç å®ç°, æŠ½è±¡æ–¹æ³•å…·ä½“å®ç°ç”±å­ç±»å®ç°
	 *
	 * @param mobile æ‰‹æœºå·
	 * @return
	 */
	protected abstract SendResult handleSendSmsCode(String mobile);

	/**
	 * ç¼“å­˜çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @param code
	 */
	@Override
	public void cacheSmsCode(String mobile, String code) {
		redisTemplate.opsForValue().set(RedisPrefixConstant.SMS_CODE + mobile, code,
				expire, TimeUnit.SECONDS);
	}

	/**
	 * æ ¡éªŒçŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @param code
	 * @return
	 */
	@Override
	public boolean checkSmsCode(String mobile, String code) {
		String cacheCode = redisTemplate.opsForValue().get(RedisPrefixConstant.SMS_CODE + mobile);
		return !StringUtils.isBlank(cacheCode) && cacheCode.equals(code);
	}

	/**
	 * åˆ é™¤ç¼“å­˜çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @return
	 */
	@Override
	public boolean deleteSmsCode(String mobile) {
		redisTemplate.delete(RedisPrefixConstant.SMS_CODE + mobile);
		return true;
	}

	/**
	 * è·å–éšæœº6ä½æ•°éªŒè¯ç 
	 *
	 * @return
	 */
	protected String createCode() {
		int random = (int) ((Math.random() * 9 + 1) * 100000);
		return String.valueOf(random);
	}


}

```



### ä¸¤ä¸ªç›¸åº”å®ç°

#### é˜¿é‡Œ

```java
package com.lfj.blog.common.sms.service.impl.ali;

import cn.hutool.json.JSONUtil;
import com.aliyun.auth.credentials.Credential;
import com.aliyun.auth.credentials.provider.StaticCredentialProvider;
import com.aliyun.sdk.service.dysmsapi20170525.AsyncClient;
import com.aliyun.sdk.service.dysmsapi20170525.models.SendSmsRequest;
import com.aliyun.sdk.service.dysmsapi20170525.models.SendSmsResponse;
import com.aliyun.sdk.service.dysmsapi20170525.models.SendSmsResponseBody;
import com.lfj.blog.common.response.enums.ResponseCodeEnum;
import com.lfj.blog.common.sms.config.SmsServiceProperties;
import com.lfj.blog.common.sms.service.impl.BaseSmsCodeServiceImpl;
import com.lfj.blog.common.sms.vo.SendResult;
import com.lfj.blog.exception.ApiException;
import darabonba.core.client.ClientOverrideConfiguration;
import darabonba.core.exception.ClientException;
import lombok.extern.log4j.Log4j2;

import java.time.Duration;
import java.util.HashMap;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;

/**
 * é˜¿é‡Œäº‘çŸ­ä¿¡éªŒè¯ç 
 */
@Log4j2
public class AliSmsCodeServiceImpl extends BaseSmsCodeServiceImpl {

	private static final String DOMAIN = "dysmsapi.aliyuncs.com"; // è®¿é—®çš„åŸŸåï¼Œä¸è¦ä¿®æ”¹

	/**
	 * åœ°åŸŸid
	 */
	private String regionId;
	/**
	 * å­ç”¨æˆ·çš„è®¿é—®é”®
	 */
	private String accessKeyId;
	/**
	 * å­ç”¨æˆ·çš„è®¿é—®å¯†é’¥
	 */
	private String accessKeySecret;
	/**
	 * ç­¾ååç§°
	 */
	private String signName;
	/**
	 * ç™»å½•çŸ­ä¿¡æ¨¡æ¿çš„code
	 */
	private String templateCode;


	// è¯»å–é…ç½®ä¿¡æ¯
	public AliSmsCodeServiceImpl(SmsServiceProperties properties) {
		setExpire(properties.getExpire());
		SmsServiceProperties.Ali ali = properties.getAli();
		init(ali);
	}

	private void init(SmsServiceProperties.Ali ali) {
		this.regionId = ali.getRegionId();
		this.accessKeyId = ali.getAccessKeyId();
		this.accessKeySecret = ali.getAccessKeySecret();
		this.signName = ali.getSignName();
		this.templateCode = ali.getTemplateCode();
	}


	/**
	 * å‘é€çŸ­ä¿¡éªŒè¯ç 
	 *
	 * @param mobile
	 * @return
	 */
	@Override
	protected SendResult handleSendSmsCode(String mobile) {

		// é…ç½®å‡­æ®èº«ä»½éªŒè¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ accessKeyId ä¸ accessKeySecret
		StaticCredentialProvider provider = StaticCredentialProvider.create(Credential.builder()
				.accessKeyId(accessKeyId)
				.accessKeySecret(accessKeySecret)
				.build());

		// å®¢æˆ·ç«¯é…ç½®
		AsyncClient client = AsyncClient.builder()
				// åœ°åŸŸid
				.region(regionId)
				.credentialsProvider(provider)
				.overrideConfiguration(
						ClientOverrideConfiguration.create()
								// è®¿é—®çš„åŸŸåï¼Œä¸è¦ä¿®æ”¹
								.setEndpointOverride(DOMAIN)
								// è®¾ç½®è¶…æ—¶æ—¶é•¿
								.setConnectTimeout(Duration.ofSeconds(30))
				)
				.build();

		// è¯·æ±‚å‚æ•°è®¾ç½®
		HashMap<String, String> contentParam = new HashMap<>();
		String code = createCode();  // è®¾ç½®éªŒè¯ç 
		contentParam.put("code", code);
		SendSmsRequest sendSmsRequest = SendSmsRequest.builder()
				.signName(signName)
				.templateCode(templateCode)
				.phoneNumbers(String.valueOf(mobile))
				.templateParam(JSONUtil.toJsonStr(contentParam))  //
				.build();

		CompletableFuture<SendSmsResponse> response = null;

		try {
			// å¼‚æ­¥è·å–APIè¯·æ±‚çš„è¿”å›å€¼
			response = client.sendSms(sendSmsRequest);
			// åŒæ­¥è·å–APIè¯·æ±‚çš„è¿”å›å€¼
			SendSmsResponseBody body = response.get().getBody();
			// åˆ¤æ–­æ˜¯å¦å‘é€æˆåŠŸ
			if ("OK".equalsIgnoreCase(body.getCode())) {
				// è¿”å›
				return new SendResult(true, code);
			} else {
				throw new ApiException(ResponseCodeEnum.SYSTEM_ERROR.getCode(), "çŸ­ä¿¡å‘é€å¤±è´¥");
			}
		} catch (ClientException e) {
			log.error("å‘é€çŸ­ä¿¡å¤±è´¥:{0}", e);
			throw new ApiException(ResponseCodeEnum.SYSTEM_ERROR.getCode(), "çŸ­ä¿¡å‘é€å¤±è´¥");
		} catch (ExecutionException | InterruptedException e) {
			throw new RuntimeException(e);
		} finally {
			// å…³é—­å®¢æˆ·ç«¯
			client.close();
		}
	}
}

```

#### è…¾è®¯

```java
package com.lfj.blog.common.sms.service.impl.tencent;

import com.github.qcloudsms.SmsSingleSender;
import com.github.qcloudsms.SmsSingleSenderResult;
import com.lfj.blog.common.response.enums.ResponseCodeEnum;
import com.lfj.blog.common.sms.config.SmsServiceProperties;
import com.lfj.blog.common.sms.service.impl.BaseSmsCodeServiceImpl;
import com.lfj.blog.common.sms.vo.SendResult;
import com.lfj.blog.exception.ApiException;
import lombok.extern.log4j.Log4j2;

import java.util.ArrayList;

/**
 * è…¾è®¯çŸ­ä¿¡æœåŠ¡
 *
 * @author: yaohw
 * @create: 2020-05-18 10:38
 **/
@Log4j2
public class TencentSmsCodeServiceImpl extends BaseSmsCodeServiceImpl {

	private String appId;
	private String appKey;
	private String templateId;
	private String signName;


	public TencentSmsCodeServiceImpl(SmsServiceProperties properties) {

	}

	/**
	 * å‘é€çŸ­ä¿¡éªŒè¯ç å®ç°
	 *
	 * @param mobile æ‰‹æœºå·
	 * @return
	 */
	@Override
	protected SendResult handleSendSmsCode(String mobile) {
		SmsSingleSender sender = new SmsSingleSender(Integer.parseInt(appId), appKey);
		ArrayList<String> params = new ArrayList<>();
		String code = createCode();
		params.add(code);
		// é»˜è®¤åªèƒ½å‘é€ä¸­å›½å¤§é™†çš„çŸ­ä¿¡86
		try {
			SmsSingleSenderResult result = sender.sendWithParam("86", mobile, Integer.parseInt(templateId), params, signName, "", "");
			if (result.result != 0) {
				throw new ApiException(ResponseCodeEnum.SYSTEM_ERROR.getCode(), result.errMsg);
			}
			return new SendResult(true, code);
		} catch (Exception e) {
			log.error("å‘é€çŸ­ä¿¡å¤±è´¥:{0}", e);
			throw new ApiException(ResponseCodeEnum.SYSTEM_ERROR.getCode(), "çŸ­ä¿¡å‘é€å¤±è´¥");
		}
	}
}

```

##  è¿è¡Œç»“æœ

![image-20240324125213951](%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E8%AE%A4%E8%AF%81.assets/image-20240324125213951.png)